
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
        
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>cellects.core.one_image_analysis - Cellects Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../../static/extra.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#cellectscoreone_image_analysis" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="Cellects Documentation" class="md-header__button md-logo" aria-label="Cellects Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Cellects Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              cellects.core.one_image_analysis
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="lime"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/Aurele-B/Cellects" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../getting-started/" class="md-tabs__link">
          
  
  
  Getting started

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../first-analysis/" class="md-tabs__link">
          
  
  
  User guide

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../use-cases/" class="md-tabs__link">
        
  
  
    
  
  Use cases

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../contributing/" class="md-tabs__link">
        
  
  
    
  
  Contributing

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../" class="md-tabs__link">
          
  
  
  API Reference

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../license/" class="md-tabs__link">
        
  
  
    
  
  License & Citation

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Cellects Documentation" class="md-nav__button md-logo" aria-label="Cellects Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Cellects Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Aurele-B/Cellects" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Getting started
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Getting started
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../getting-started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quick start
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../what-is-cellects/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    What is Cellects?
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    User guide
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    User guide
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Setting up a first analysis
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Setting up a first analysis
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../first-analysis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../first-analysis/data-localisation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Data localisation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../first-analysis/image-analysis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Image analysis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../first-analysis/video-tracking/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Video tracking
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Improving the analysis
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Improving the analysis
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../advanced/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../advanced/parameters/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Advanced parameters
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../advanced/outputs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Required outputs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../advanced/multiple-folders/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multiple folders
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../use-cases/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Use cases
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    API Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../license/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    License & Citation
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="cellectscoreone_image_analysis"><code>cellects.core.one_image_analysis</code></h1>


<div class="doc doc-object doc-module">



<a id="cellects.core.one_image_analysis"></a>
    <div class="doc doc-contents first">

        <p>Module providing tools for single-image color space analysis and segmentation.</p>
<p>The OneImageAnalysis class offers comprehensive image processing capabilities including
color space conversion (RGB, HSV, LAB, LUV, HLS, YUV), filtering (Gaussian, median, bilateral),
segmentation (Otsu thresholding, k-means clustering), and shape-based validation. It supports
multi-step optimization of color channel combinations to maximize contrast between organisms
and background through automated selection workflows involving logical operations on segmented regions.</p>
<p>Classes
OneImageAnalysis : Analyze images using multiple color spaces for optimal segmentation</p>
<p>Notes
Uses QThread for background operations during combination processing.</p>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="cellects.core.one_image_analysis.OneImageAnalysis" class="doc doc-heading">
            <code>OneImageAnalysis</code>


</h2>


    <div class="doc doc-contents ">



        <p>This class takes a 3D matrix (2 space and 1 color [BGR] dimensions),
Its methods allow image
- conversion to any bgr/hsv/lab channels
- croping
- rotating
- filtering using some of the mainly used techniques:
    - Gaussian, Median, Bilateral, Laplacian, Mexican hat
- segmenting using thresholds or kmeans
- shape selection according to horizontal size or shape ('circle' vs 'quadrilateral')</p>
<p>ps: A viewing method displays the image before and after the most advanced modification made in instance</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/cellects/core/one_image_analysis.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-37">  37</a></span>
<span class="normal"><a href="#__codelineno-0-38">  38</a></span>
<span class="normal"><a href="#__codelineno-0-39">  39</a></span>
<span class="normal"><a href="#__codelineno-0-40">  40</a></span>
<span class="normal"><a href="#__codelineno-0-41">  41</a></span>
<span class="normal"><a href="#__codelineno-0-42">  42</a></span>
<span class="normal"><a href="#__codelineno-0-43">  43</a></span>
<span class="normal"><a href="#__codelineno-0-44">  44</a></span>
<span class="normal"><a href="#__codelineno-0-45">  45</a></span>
<span class="normal"><a href="#__codelineno-0-46">  46</a></span>
<span class="normal"><a href="#__codelineno-0-47">  47</a></span>
<span class="normal"><a href="#__codelineno-0-48">  48</a></span>
<span class="normal"><a href="#__codelineno-0-49">  49</a></span>
<span class="normal"><a href="#__codelineno-0-50">  50</a></span>
<span class="normal"><a href="#__codelineno-0-51">  51</a></span>
<span class="normal"><a href="#__codelineno-0-52">  52</a></span>
<span class="normal"><a href="#__codelineno-0-53">  53</a></span>
<span class="normal"><a href="#__codelineno-0-54">  54</a></span>
<span class="normal"><a href="#__codelineno-0-55">  55</a></span>
<span class="normal"><a href="#__codelineno-0-56">  56</a></span>
<span class="normal"><a href="#__codelineno-0-57">  57</a></span>
<span class="normal"><a href="#__codelineno-0-58">  58</a></span>
<span class="normal"><a href="#__codelineno-0-59">  59</a></span>
<span class="normal"><a href="#__codelineno-0-60">  60</a></span>
<span class="normal"><a href="#__codelineno-0-61">  61</a></span>
<span class="normal"><a href="#__codelineno-0-62">  62</a></span>
<span class="normal"><a href="#__codelineno-0-63">  63</a></span>
<span class="normal"><a href="#__codelineno-0-64">  64</a></span>
<span class="normal"><a href="#__codelineno-0-65">  65</a></span>
<span class="normal"><a href="#__codelineno-0-66">  66</a></span>
<span class="normal"><a href="#__codelineno-0-67">  67</a></span>
<span class="normal"><a href="#__codelineno-0-68">  68</a></span>
<span class="normal"><a href="#__codelineno-0-69">  69</a></span>
<span class="normal"><a href="#__codelineno-0-70">  70</a></span>
<span class="normal"><a href="#__codelineno-0-71">  71</a></span>
<span class="normal"><a href="#__codelineno-0-72">  72</a></span>
<span class="normal"><a href="#__codelineno-0-73">  73</a></span>
<span class="normal"><a href="#__codelineno-0-74">  74</a></span>
<span class="normal"><a href="#__codelineno-0-75">  75</a></span>
<span class="normal"><a href="#__codelineno-0-76">  76</a></span>
<span class="normal"><a href="#__codelineno-0-77">  77</a></span>
<span class="normal"><a href="#__codelineno-0-78">  78</a></span>
<span class="normal"><a href="#__codelineno-0-79">  79</a></span>
<span class="normal"><a href="#__codelineno-0-80">  80</a></span>
<span class="normal"><a href="#__codelineno-0-81">  81</a></span>
<span class="normal"><a href="#__codelineno-0-82">  82</a></span>
<span class="normal"><a href="#__codelineno-0-83">  83</a></span>
<span class="normal"><a href="#__codelineno-0-84">  84</a></span>
<span class="normal"><a href="#__codelineno-0-85">  85</a></span>
<span class="normal"><a href="#__codelineno-0-86">  86</a></span>
<span class="normal"><a href="#__codelineno-0-87">  87</a></span>
<span class="normal"><a href="#__codelineno-0-88">  88</a></span>
<span class="normal"><a href="#__codelineno-0-89">  89</a></span>
<span class="normal"><a href="#__codelineno-0-90">  90</a></span>
<span class="normal"><a href="#__codelineno-0-91">  91</a></span>
<span class="normal"><a href="#__codelineno-0-92">  92</a></span>
<span class="normal"><a href="#__codelineno-0-93">  93</a></span>
<span class="normal"><a href="#__codelineno-0-94">  94</a></span>
<span class="normal"><a href="#__codelineno-0-95">  95</a></span>
<span class="normal"><a href="#__codelineno-0-96">  96</a></span>
<span class="normal"><a href="#__codelineno-0-97">  97</a></span>
<span class="normal"><a href="#__codelineno-0-98">  98</a></span>
<span class="normal"><a href="#__codelineno-0-99">  99</a></span>
<span class="normal"><a href="#__codelineno-0-100"> 100</a></span>
<span class="normal"><a href="#__codelineno-0-101"> 101</a></span>
<span class="normal"><a href="#__codelineno-0-102"> 102</a></span>
<span class="normal"><a href="#__codelineno-0-103"> 103</a></span>
<span class="normal"><a href="#__codelineno-0-104"> 104</a></span>
<span class="normal"><a href="#__codelineno-0-105"> 105</a></span>
<span class="normal"><a href="#__codelineno-0-106"> 106</a></span>
<span class="normal"><a href="#__codelineno-0-107"> 107</a></span>
<span class="normal"><a href="#__codelineno-0-108"> 108</a></span>
<span class="normal"><a href="#__codelineno-0-109"> 109</a></span>
<span class="normal"><a href="#__codelineno-0-110"> 110</a></span>
<span class="normal"><a href="#__codelineno-0-111"> 111</a></span>
<span class="normal"><a href="#__codelineno-0-112"> 112</a></span>
<span class="normal"><a href="#__codelineno-0-113"> 113</a></span>
<span class="normal"><a href="#__codelineno-0-114"> 114</a></span>
<span class="normal"><a href="#__codelineno-0-115"> 115</a></span>
<span class="normal"><a href="#__codelineno-0-116"> 116</a></span>
<span class="normal"><a href="#__codelineno-0-117"> 117</a></span>
<span class="normal"><a href="#__codelineno-0-118"> 118</a></span>
<span class="normal"><a href="#__codelineno-0-119"> 119</a></span>
<span class="normal"><a href="#__codelineno-0-120"> 120</a></span>
<span class="normal"><a href="#__codelineno-0-121"> 121</a></span>
<span class="normal"><a href="#__codelineno-0-122"> 122</a></span>
<span class="normal"><a href="#__codelineno-0-123"> 123</a></span>
<span class="normal"><a href="#__codelineno-0-124"> 124</a></span>
<span class="normal"><a href="#__codelineno-0-125"> 125</a></span>
<span class="normal"><a href="#__codelineno-0-126"> 126</a></span>
<span class="normal"><a href="#__codelineno-0-127"> 127</a></span>
<span class="normal"><a href="#__codelineno-0-128"> 128</a></span>
<span class="normal"><a href="#__codelineno-0-129"> 129</a></span>
<span class="normal"><a href="#__codelineno-0-130"> 130</a></span>
<span class="normal"><a href="#__codelineno-0-131"> 131</a></span>
<span class="normal"><a href="#__codelineno-0-132"> 132</a></span>
<span class="normal"><a href="#__codelineno-0-133"> 133</a></span>
<span class="normal"><a href="#__codelineno-0-134"> 134</a></span>
<span class="normal"><a href="#__codelineno-0-135"> 135</a></span>
<span class="normal"><a href="#__codelineno-0-136"> 136</a></span>
<span class="normal"><a href="#__codelineno-0-137"> 137</a></span>
<span class="normal"><a href="#__codelineno-0-138"> 138</a></span>
<span class="normal"><a href="#__codelineno-0-139"> 139</a></span>
<span class="normal"><a href="#__codelineno-0-140"> 140</a></span>
<span class="normal"><a href="#__codelineno-0-141"> 141</a></span>
<span class="normal"><a href="#__codelineno-0-142"> 142</a></span>
<span class="normal"><a href="#__codelineno-0-143"> 143</a></span>
<span class="normal"><a href="#__codelineno-0-144"> 144</a></span>
<span class="normal"><a href="#__codelineno-0-145"> 145</a></span>
<span class="normal"><a href="#__codelineno-0-146"> 146</a></span>
<span class="normal"><a href="#__codelineno-0-147"> 147</a></span>
<span class="normal"><a href="#__codelineno-0-148"> 148</a></span>
<span class="normal"><a href="#__codelineno-0-149"> 149</a></span>
<span class="normal"><a href="#__codelineno-0-150"> 150</a></span>
<span class="normal"><a href="#__codelineno-0-151"> 151</a></span>
<span class="normal"><a href="#__codelineno-0-152"> 152</a></span>
<span class="normal"><a href="#__codelineno-0-153"> 153</a></span>
<span class="normal"><a href="#__codelineno-0-154"> 154</a></span>
<span class="normal"><a href="#__codelineno-0-155"> 155</a></span>
<span class="normal"><a href="#__codelineno-0-156"> 156</a></span>
<span class="normal"><a href="#__codelineno-0-157"> 157</a></span>
<span class="normal"><a href="#__codelineno-0-158"> 158</a></span>
<span class="normal"><a href="#__codelineno-0-159"> 159</a></span>
<span class="normal"><a href="#__codelineno-0-160"> 160</a></span>
<span class="normal"><a href="#__codelineno-0-161"> 161</a></span>
<span class="normal"><a href="#__codelineno-0-162"> 162</a></span>
<span class="normal"><a href="#__codelineno-0-163"> 163</a></span>
<span class="normal"><a href="#__codelineno-0-164"> 164</a></span>
<span class="normal"><a href="#__codelineno-0-165"> 165</a></span>
<span class="normal"><a href="#__codelineno-0-166"> 166</a></span>
<span class="normal"><a href="#__codelineno-0-167"> 167</a></span>
<span class="normal"><a href="#__codelineno-0-168"> 168</a></span>
<span class="normal"><a href="#__codelineno-0-169"> 169</a></span>
<span class="normal"><a href="#__codelineno-0-170"> 170</a></span>
<span class="normal"><a href="#__codelineno-0-171"> 171</a></span>
<span class="normal"><a href="#__codelineno-0-172"> 172</a></span>
<span class="normal"><a href="#__codelineno-0-173"> 173</a></span>
<span class="normal"><a href="#__codelineno-0-174"> 174</a></span>
<span class="normal"><a href="#__codelineno-0-175"> 175</a></span>
<span class="normal"><a href="#__codelineno-0-176"> 176</a></span>
<span class="normal"><a href="#__codelineno-0-177"> 177</a></span>
<span class="normal"><a href="#__codelineno-0-178"> 178</a></span>
<span class="normal"><a href="#__codelineno-0-179"> 179</a></span>
<span class="normal"><a href="#__codelineno-0-180"> 180</a></span>
<span class="normal"><a href="#__codelineno-0-181"> 181</a></span>
<span class="normal"><a href="#__codelineno-0-182"> 182</a></span>
<span class="normal"><a href="#__codelineno-0-183"> 183</a></span>
<span class="normal"><a href="#__codelineno-0-184"> 184</a></span>
<span class="normal"><a href="#__codelineno-0-185"> 185</a></span>
<span class="normal"><a href="#__codelineno-0-186"> 186</a></span>
<span class="normal"><a href="#__codelineno-0-187"> 187</a></span>
<span class="normal"><a href="#__codelineno-0-188"> 188</a></span>
<span class="normal"><a href="#__codelineno-0-189"> 189</a></span>
<span class="normal"><a href="#__codelineno-0-190"> 190</a></span>
<span class="normal"><a href="#__codelineno-0-191"> 191</a></span>
<span class="normal"><a href="#__codelineno-0-192"> 192</a></span>
<span class="normal"><a href="#__codelineno-0-193"> 193</a></span>
<span class="normal"><a href="#__codelineno-0-194"> 194</a></span>
<span class="normal"><a href="#__codelineno-0-195"> 195</a></span>
<span class="normal"><a href="#__codelineno-0-196"> 196</a></span>
<span class="normal"><a href="#__codelineno-0-197"> 197</a></span>
<span class="normal"><a href="#__codelineno-0-198"> 198</a></span>
<span class="normal"><a href="#__codelineno-0-199"> 199</a></span>
<span class="normal"><a href="#__codelineno-0-200"> 200</a></span>
<span class="normal"><a href="#__codelineno-0-201"> 201</a></span>
<span class="normal"><a href="#__codelineno-0-202"> 202</a></span>
<span class="normal"><a href="#__codelineno-0-203"> 203</a></span>
<span class="normal"><a href="#__codelineno-0-204"> 204</a></span>
<span class="normal"><a href="#__codelineno-0-205"> 205</a></span>
<span class="normal"><a href="#__codelineno-0-206"> 206</a></span>
<span class="normal"><a href="#__codelineno-0-207"> 207</a></span>
<span class="normal"><a href="#__codelineno-0-208"> 208</a></span>
<span class="normal"><a href="#__codelineno-0-209"> 209</a></span>
<span class="normal"><a href="#__codelineno-0-210"> 210</a></span>
<span class="normal"><a href="#__codelineno-0-211"> 211</a></span>
<span class="normal"><a href="#__codelineno-0-212"> 212</a></span>
<span class="normal"><a href="#__codelineno-0-213"> 213</a></span>
<span class="normal"><a href="#__codelineno-0-214"> 214</a></span>
<span class="normal"><a href="#__codelineno-0-215"> 215</a></span>
<span class="normal"><a href="#__codelineno-0-216"> 216</a></span>
<span class="normal"><a href="#__codelineno-0-217"> 217</a></span>
<span class="normal"><a href="#__codelineno-0-218"> 218</a></span>
<span class="normal"><a href="#__codelineno-0-219"> 219</a></span>
<span class="normal"><a href="#__codelineno-0-220"> 220</a></span>
<span class="normal"><a href="#__codelineno-0-221"> 221</a></span>
<span class="normal"><a href="#__codelineno-0-222"> 222</a></span>
<span class="normal"><a href="#__codelineno-0-223"> 223</a></span>
<span class="normal"><a href="#__codelineno-0-224"> 224</a></span>
<span class="normal"><a href="#__codelineno-0-225"> 225</a></span>
<span class="normal"><a href="#__codelineno-0-226"> 226</a></span>
<span class="normal"><a href="#__codelineno-0-227"> 227</a></span>
<span class="normal"><a href="#__codelineno-0-228"> 228</a></span>
<span class="normal"><a href="#__codelineno-0-229"> 229</a></span>
<span class="normal"><a href="#__codelineno-0-230"> 230</a></span>
<span class="normal"><a href="#__codelineno-0-231"> 231</a></span>
<span class="normal"><a href="#__codelineno-0-232"> 232</a></span>
<span class="normal"><a href="#__codelineno-0-233"> 233</a></span>
<span class="normal"><a href="#__codelineno-0-234"> 234</a></span>
<span class="normal"><a href="#__codelineno-0-235"> 235</a></span>
<span class="normal"><a href="#__codelineno-0-236"> 236</a></span>
<span class="normal"><a href="#__codelineno-0-237"> 237</a></span>
<span class="normal"><a href="#__codelineno-0-238"> 238</a></span>
<span class="normal"><a href="#__codelineno-0-239"> 239</a></span>
<span class="normal"><a href="#__codelineno-0-240"> 240</a></span>
<span class="normal"><a href="#__codelineno-0-241"> 241</a></span>
<span class="normal"><a href="#__codelineno-0-242"> 242</a></span>
<span class="normal"><a href="#__codelineno-0-243"> 243</a></span>
<span class="normal"><a href="#__codelineno-0-244"> 244</a></span>
<span class="normal"><a href="#__codelineno-0-245"> 245</a></span>
<span class="normal"><a href="#__codelineno-0-246"> 246</a></span>
<span class="normal"><a href="#__codelineno-0-247"> 247</a></span>
<span class="normal"><a href="#__codelineno-0-248"> 248</a></span>
<span class="normal"><a href="#__codelineno-0-249"> 249</a></span>
<span class="normal"><a href="#__codelineno-0-250"> 250</a></span>
<span class="normal"><a href="#__codelineno-0-251"> 251</a></span>
<span class="normal"><a href="#__codelineno-0-252"> 252</a></span>
<span class="normal"><a href="#__codelineno-0-253"> 253</a></span>
<span class="normal"><a href="#__codelineno-0-254"> 254</a></span>
<span class="normal"><a href="#__codelineno-0-255"> 255</a></span>
<span class="normal"><a href="#__codelineno-0-256"> 256</a></span>
<span class="normal"><a href="#__codelineno-0-257"> 257</a></span>
<span class="normal"><a href="#__codelineno-0-258"> 258</a></span>
<span class="normal"><a href="#__codelineno-0-259"> 259</a></span>
<span class="normal"><a href="#__codelineno-0-260"> 260</a></span>
<span class="normal"><a href="#__codelineno-0-261"> 261</a></span>
<span class="normal"><a href="#__codelineno-0-262"> 262</a></span>
<span class="normal"><a href="#__codelineno-0-263"> 263</a></span>
<span class="normal"><a href="#__codelineno-0-264"> 264</a></span>
<span class="normal"><a href="#__codelineno-0-265"> 265</a></span>
<span class="normal"><a href="#__codelineno-0-266"> 266</a></span>
<span class="normal"><a href="#__codelineno-0-267"> 267</a></span>
<span class="normal"><a href="#__codelineno-0-268"> 268</a></span>
<span class="normal"><a href="#__codelineno-0-269"> 269</a></span>
<span class="normal"><a href="#__codelineno-0-270"> 270</a></span>
<span class="normal"><a href="#__codelineno-0-271"> 271</a></span>
<span class="normal"><a href="#__codelineno-0-272"> 272</a></span>
<span class="normal"><a href="#__codelineno-0-273"> 273</a></span>
<span class="normal"><a href="#__codelineno-0-274"> 274</a></span>
<span class="normal"><a href="#__codelineno-0-275"> 275</a></span>
<span class="normal"><a href="#__codelineno-0-276"> 276</a></span>
<span class="normal"><a href="#__codelineno-0-277"> 277</a></span>
<span class="normal"><a href="#__codelineno-0-278"> 278</a></span>
<span class="normal"><a href="#__codelineno-0-279"> 279</a></span>
<span class="normal"><a href="#__codelineno-0-280"> 280</a></span>
<span class="normal"><a href="#__codelineno-0-281"> 281</a></span>
<span class="normal"><a href="#__codelineno-0-282"> 282</a></span>
<span class="normal"><a href="#__codelineno-0-283"> 283</a></span>
<span class="normal"><a href="#__codelineno-0-284"> 284</a></span>
<span class="normal"><a href="#__codelineno-0-285"> 285</a></span>
<span class="normal"><a href="#__codelineno-0-286"> 286</a></span>
<span class="normal"><a href="#__codelineno-0-287"> 287</a></span>
<span class="normal"><a href="#__codelineno-0-288"> 288</a></span>
<span class="normal"><a href="#__codelineno-0-289"> 289</a></span>
<span class="normal"><a href="#__codelineno-0-290"> 290</a></span>
<span class="normal"><a href="#__codelineno-0-291"> 291</a></span>
<span class="normal"><a href="#__codelineno-0-292"> 292</a></span>
<span class="normal"><a href="#__codelineno-0-293"> 293</a></span>
<span class="normal"><a href="#__codelineno-0-294"> 294</a></span>
<span class="normal"><a href="#__codelineno-0-295"> 295</a></span>
<span class="normal"><a href="#__codelineno-0-296"> 296</a></span>
<span class="normal"><a href="#__codelineno-0-297"> 297</a></span>
<span class="normal"><a href="#__codelineno-0-298"> 298</a></span>
<span class="normal"><a href="#__codelineno-0-299"> 299</a></span>
<span class="normal"><a href="#__codelineno-0-300"> 300</a></span>
<span class="normal"><a href="#__codelineno-0-301"> 301</a></span>
<span class="normal"><a href="#__codelineno-0-302"> 302</a></span>
<span class="normal"><a href="#__codelineno-0-303"> 303</a></span>
<span class="normal"><a href="#__codelineno-0-304"> 304</a></span>
<span class="normal"><a href="#__codelineno-0-305"> 305</a></span>
<span class="normal"><a href="#__codelineno-0-306"> 306</a></span>
<span class="normal"><a href="#__codelineno-0-307"> 307</a></span>
<span class="normal"><a href="#__codelineno-0-308"> 308</a></span>
<span class="normal"><a href="#__codelineno-0-309"> 309</a></span>
<span class="normal"><a href="#__codelineno-0-310"> 310</a></span>
<span class="normal"><a href="#__codelineno-0-311"> 311</a></span>
<span class="normal"><a href="#__codelineno-0-312"> 312</a></span>
<span class="normal"><a href="#__codelineno-0-313"> 313</a></span>
<span class="normal"><a href="#__codelineno-0-314"> 314</a></span>
<span class="normal"><a href="#__codelineno-0-315"> 315</a></span>
<span class="normal"><a href="#__codelineno-0-316"> 316</a></span>
<span class="normal"><a href="#__codelineno-0-317"> 317</a></span>
<span class="normal"><a href="#__codelineno-0-318"> 318</a></span>
<span class="normal"><a href="#__codelineno-0-319"> 319</a></span>
<span class="normal"><a href="#__codelineno-0-320"> 320</a></span>
<span class="normal"><a href="#__codelineno-0-321"> 321</a></span>
<span class="normal"><a href="#__codelineno-0-322"> 322</a></span>
<span class="normal"><a href="#__codelineno-0-323"> 323</a></span>
<span class="normal"><a href="#__codelineno-0-324"> 324</a></span>
<span class="normal"><a href="#__codelineno-0-325"> 325</a></span>
<span class="normal"><a href="#__codelineno-0-326"> 326</a></span>
<span class="normal"><a href="#__codelineno-0-327"> 327</a></span>
<span class="normal"><a href="#__codelineno-0-328"> 328</a></span>
<span class="normal"><a href="#__codelineno-0-329"> 329</a></span>
<span class="normal"><a href="#__codelineno-0-330"> 330</a></span>
<span class="normal"><a href="#__codelineno-0-331"> 331</a></span>
<span class="normal"><a href="#__codelineno-0-332"> 332</a></span>
<span class="normal"><a href="#__codelineno-0-333"> 333</a></span>
<span class="normal"><a href="#__codelineno-0-334"> 334</a></span>
<span class="normal"><a href="#__codelineno-0-335"> 335</a></span>
<span class="normal"><a href="#__codelineno-0-336"> 336</a></span>
<span class="normal"><a href="#__codelineno-0-337"> 337</a></span>
<span class="normal"><a href="#__codelineno-0-338"> 338</a></span>
<span class="normal"><a href="#__codelineno-0-339"> 339</a></span>
<span class="normal"><a href="#__codelineno-0-340"> 340</a></span>
<span class="normal"><a href="#__codelineno-0-341"> 341</a></span>
<span class="normal"><a href="#__codelineno-0-342"> 342</a></span>
<span class="normal"><a href="#__codelineno-0-343"> 343</a></span>
<span class="normal"><a href="#__codelineno-0-344"> 344</a></span>
<span class="normal"><a href="#__codelineno-0-345"> 345</a></span>
<span class="normal"><a href="#__codelineno-0-346"> 346</a></span>
<span class="normal"><a href="#__codelineno-0-347"> 347</a></span>
<span class="normal"><a href="#__codelineno-0-348"> 348</a></span>
<span class="normal"><a href="#__codelineno-0-349"> 349</a></span>
<span class="normal"><a href="#__codelineno-0-350"> 350</a></span>
<span class="normal"><a href="#__codelineno-0-351"> 351</a></span>
<span class="normal"><a href="#__codelineno-0-352"> 352</a></span>
<span class="normal"><a href="#__codelineno-0-353"> 353</a></span>
<span class="normal"><a href="#__codelineno-0-354"> 354</a></span>
<span class="normal"><a href="#__codelineno-0-355"> 355</a></span>
<span class="normal"><a href="#__codelineno-0-356"> 356</a></span>
<span class="normal"><a href="#__codelineno-0-357"> 357</a></span>
<span class="normal"><a href="#__codelineno-0-358"> 358</a></span>
<span class="normal"><a href="#__codelineno-0-359"> 359</a></span>
<span class="normal"><a href="#__codelineno-0-360"> 360</a></span>
<span class="normal"><a href="#__codelineno-0-361"> 361</a></span>
<span class="normal"><a href="#__codelineno-0-362"> 362</a></span>
<span class="normal"><a href="#__codelineno-0-363"> 363</a></span>
<span class="normal"><a href="#__codelineno-0-364"> 364</a></span>
<span class="normal"><a href="#__codelineno-0-365"> 365</a></span>
<span class="normal"><a href="#__codelineno-0-366"> 366</a></span>
<span class="normal"><a href="#__codelineno-0-367"> 367</a></span>
<span class="normal"><a href="#__codelineno-0-368"> 368</a></span>
<span class="normal"><a href="#__codelineno-0-369"> 369</a></span>
<span class="normal"><a href="#__codelineno-0-370"> 370</a></span>
<span class="normal"><a href="#__codelineno-0-371"> 371</a></span>
<span class="normal"><a href="#__codelineno-0-372"> 372</a></span>
<span class="normal"><a href="#__codelineno-0-373"> 373</a></span>
<span class="normal"><a href="#__codelineno-0-374"> 374</a></span>
<span class="normal"><a href="#__codelineno-0-375"> 375</a></span>
<span class="normal"><a href="#__codelineno-0-376"> 376</a></span>
<span class="normal"><a href="#__codelineno-0-377"> 377</a></span>
<span class="normal"><a href="#__codelineno-0-378"> 378</a></span>
<span class="normal"><a href="#__codelineno-0-379"> 379</a></span>
<span class="normal"><a href="#__codelineno-0-380"> 380</a></span>
<span class="normal"><a href="#__codelineno-0-381"> 381</a></span>
<span class="normal"><a href="#__codelineno-0-382"> 382</a></span>
<span class="normal"><a href="#__codelineno-0-383"> 383</a></span>
<span class="normal"><a href="#__codelineno-0-384"> 384</a></span>
<span class="normal"><a href="#__codelineno-0-385"> 385</a></span>
<span class="normal"><a href="#__codelineno-0-386"> 386</a></span>
<span class="normal"><a href="#__codelineno-0-387"> 387</a></span>
<span class="normal"><a href="#__codelineno-0-388"> 388</a></span>
<span class="normal"><a href="#__codelineno-0-389"> 389</a></span>
<span class="normal"><a href="#__codelineno-0-390"> 390</a></span>
<span class="normal"><a href="#__codelineno-0-391"> 391</a></span>
<span class="normal"><a href="#__codelineno-0-392"> 392</a></span>
<span class="normal"><a href="#__codelineno-0-393"> 393</a></span>
<span class="normal"><a href="#__codelineno-0-394"> 394</a></span>
<span class="normal"><a href="#__codelineno-0-395"> 395</a></span>
<span class="normal"><a href="#__codelineno-0-396"> 396</a></span>
<span class="normal"><a href="#__codelineno-0-397"> 397</a></span>
<span class="normal"><a href="#__codelineno-0-398"> 398</a></span>
<span class="normal"><a href="#__codelineno-0-399"> 399</a></span>
<span class="normal"><a href="#__codelineno-0-400"> 400</a></span>
<span class="normal"><a href="#__codelineno-0-401"> 401</a></span>
<span class="normal"><a href="#__codelineno-0-402"> 402</a></span>
<span class="normal"><a href="#__codelineno-0-403"> 403</a></span>
<span class="normal"><a href="#__codelineno-0-404"> 404</a></span>
<span class="normal"><a href="#__codelineno-0-405"> 405</a></span>
<span class="normal"><a href="#__codelineno-0-406"> 406</a></span>
<span class="normal"><a href="#__codelineno-0-407"> 407</a></span>
<span class="normal"><a href="#__codelineno-0-408"> 408</a></span>
<span class="normal"><a href="#__codelineno-0-409"> 409</a></span>
<span class="normal"><a href="#__codelineno-0-410"> 410</a></span>
<span class="normal"><a href="#__codelineno-0-411"> 411</a></span>
<span class="normal"><a href="#__codelineno-0-412"> 412</a></span>
<span class="normal"><a href="#__codelineno-0-413"> 413</a></span>
<span class="normal"><a href="#__codelineno-0-414"> 414</a></span>
<span class="normal"><a href="#__codelineno-0-415"> 415</a></span>
<span class="normal"><a href="#__codelineno-0-416"> 416</a></span>
<span class="normal"><a href="#__codelineno-0-417"> 417</a></span>
<span class="normal"><a href="#__codelineno-0-418"> 418</a></span>
<span class="normal"><a href="#__codelineno-0-419"> 419</a></span>
<span class="normal"><a href="#__codelineno-0-420"> 420</a></span>
<span class="normal"><a href="#__codelineno-0-421"> 421</a></span>
<span class="normal"><a href="#__codelineno-0-422"> 422</a></span>
<span class="normal"><a href="#__codelineno-0-423"> 423</a></span>
<span class="normal"><a href="#__codelineno-0-424"> 424</a></span>
<span class="normal"><a href="#__codelineno-0-425"> 425</a></span>
<span class="normal"><a href="#__codelineno-0-426"> 426</a></span>
<span class="normal"><a href="#__codelineno-0-427"> 427</a></span>
<span class="normal"><a href="#__codelineno-0-428"> 428</a></span>
<span class="normal"><a href="#__codelineno-0-429"> 429</a></span>
<span class="normal"><a href="#__codelineno-0-430"> 430</a></span>
<span class="normal"><a href="#__codelineno-0-431"> 431</a></span>
<span class="normal"><a href="#__codelineno-0-432"> 432</a></span>
<span class="normal"><a href="#__codelineno-0-433"> 433</a></span>
<span class="normal"><a href="#__codelineno-0-434"> 434</a></span>
<span class="normal"><a href="#__codelineno-0-435"> 435</a></span>
<span class="normal"><a href="#__codelineno-0-436"> 436</a></span>
<span class="normal"><a href="#__codelineno-0-437"> 437</a></span>
<span class="normal"><a href="#__codelineno-0-438"> 438</a></span>
<span class="normal"><a href="#__codelineno-0-439"> 439</a></span>
<span class="normal"><a href="#__codelineno-0-440"> 440</a></span>
<span class="normal"><a href="#__codelineno-0-441"> 441</a></span>
<span class="normal"><a href="#__codelineno-0-442"> 442</a></span>
<span class="normal"><a href="#__codelineno-0-443"> 443</a></span>
<span class="normal"><a href="#__codelineno-0-444"> 444</a></span>
<span class="normal"><a href="#__codelineno-0-445"> 445</a></span>
<span class="normal"><a href="#__codelineno-0-446"> 446</a></span>
<span class="normal"><a href="#__codelineno-0-447"> 447</a></span>
<span class="normal"><a href="#__codelineno-0-448"> 448</a></span>
<span class="normal"><a href="#__codelineno-0-449"> 449</a></span>
<span class="normal"><a href="#__codelineno-0-450"> 450</a></span>
<span class="normal"><a href="#__codelineno-0-451"> 451</a></span>
<span class="normal"><a href="#__codelineno-0-452"> 452</a></span>
<span class="normal"><a href="#__codelineno-0-453"> 453</a></span>
<span class="normal"><a href="#__codelineno-0-454"> 454</a></span>
<span class="normal"><a href="#__codelineno-0-455"> 455</a></span>
<span class="normal"><a href="#__codelineno-0-456"> 456</a></span>
<span class="normal"><a href="#__codelineno-0-457"> 457</a></span>
<span class="normal"><a href="#__codelineno-0-458"> 458</a></span>
<span class="normal"><a href="#__codelineno-0-459"> 459</a></span>
<span class="normal"><a href="#__codelineno-0-460"> 460</a></span>
<span class="normal"><a href="#__codelineno-0-461"> 461</a></span>
<span class="normal"><a href="#__codelineno-0-462"> 462</a></span>
<span class="normal"><a href="#__codelineno-0-463"> 463</a></span>
<span class="normal"><a href="#__codelineno-0-464"> 464</a></span>
<span class="normal"><a href="#__codelineno-0-465"> 465</a></span>
<span class="normal"><a href="#__codelineno-0-466"> 466</a></span>
<span class="normal"><a href="#__codelineno-0-467"> 467</a></span>
<span class="normal"><a href="#__codelineno-0-468"> 468</a></span>
<span class="normal"><a href="#__codelineno-0-469"> 469</a></span>
<span class="normal"><a href="#__codelineno-0-470"> 470</a></span>
<span class="normal"><a href="#__codelineno-0-471"> 471</a></span>
<span class="normal"><a href="#__codelineno-0-472"> 472</a></span>
<span class="normal"><a href="#__codelineno-0-473"> 473</a></span>
<span class="normal"><a href="#__codelineno-0-474"> 474</a></span>
<span class="normal"><a href="#__codelineno-0-475"> 475</a></span>
<span class="normal"><a href="#__codelineno-0-476"> 476</a></span>
<span class="normal"><a href="#__codelineno-0-477"> 477</a></span>
<span class="normal"><a href="#__codelineno-0-478"> 478</a></span>
<span class="normal"><a href="#__codelineno-0-479"> 479</a></span>
<span class="normal"><a href="#__codelineno-0-480"> 480</a></span>
<span class="normal"><a href="#__codelineno-0-481"> 481</a></span>
<span class="normal"><a href="#__codelineno-0-482"> 482</a></span>
<span class="normal"><a href="#__codelineno-0-483"> 483</a></span>
<span class="normal"><a href="#__codelineno-0-484"> 484</a></span>
<span class="normal"><a href="#__codelineno-0-485"> 485</a></span>
<span class="normal"><a href="#__codelineno-0-486"> 486</a></span>
<span class="normal"><a href="#__codelineno-0-487"> 487</a></span>
<span class="normal"><a href="#__codelineno-0-488"> 488</a></span>
<span class="normal"><a href="#__codelineno-0-489"> 489</a></span>
<span class="normal"><a href="#__codelineno-0-490"> 490</a></span>
<span class="normal"><a href="#__codelineno-0-491"> 491</a></span>
<span class="normal"><a href="#__codelineno-0-492"> 492</a></span>
<span class="normal"><a href="#__codelineno-0-493"> 493</a></span>
<span class="normal"><a href="#__codelineno-0-494"> 494</a></span>
<span class="normal"><a href="#__codelineno-0-495"> 495</a></span>
<span class="normal"><a href="#__codelineno-0-496"> 496</a></span>
<span class="normal"><a href="#__codelineno-0-497"> 497</a></span>
<span class="normal"><a href="#__codelineno-0-498"> 498</a></span>
<span class="normal"><a href="#__codelineno-0-499"> 499</a></span>
<span class="normal"><a href="#__codelineno-0-500"> 500</a></span>
<span class="normal"><a href="#__codelineno-0-501"> 501</a></span>
<span class="normal"><a href="#__codelineno-0-502"> 502</a></span>
<span class="normal"><a href="#__codelineno-0-503"> 503</a></span>
<span class="normal"><a href="#__codelineno-0-504"> 504</a></span>
<span class="normal"><a href="#__codelineno-0-505"> 505</a></span>
<span class="normal"><a href="#__codelineno-0-506"> 506</a></span>
<span class="normal"><a href="#__codelineno-0-507"> 507</a></span>
<span class="normal"><a href="#__codelineno-0-508"> 508</a></span>
<span class="normal"><a href="#__codelineno-0-509"> 509</a></span>
<span class="normal"><a href="#__codelineno-0-510"> 510</a></span>
<span class="normal"><a href="#__codelineno-0-511"> 511</a></span>
<span class="normal"><a href="#__codelineno-0-512"> 512</a></span>
<span class="normal"><a href="#__codelineno-0-513"> 513</a></span>
<span class="normal"><a href="#__codelineno-0-514"> 514</a></span>
<span class="normal"><a href="#__codelineno-0-515"> 515</a></span>
<span class="normal"><a href="#__codelineno-0-516"> 516</a></span>
<span class="normal"><a href="#__codelineno-0-517"> 517</a></span>
<span class="normal"><a href="#__codelineno-0-518"> 518</a></span>
<span class="normal"><a href="#__codelineno-0-519"> 519</a></span>
<span class="normal"><a href="#__codelineno-0-520"> 520</a></span>
<span class="normal"><a href="#__codelineno-0-521"> 521</a></span>
<span class="normal"><a href="#__codelineno-0-522"> 522</a></span>
<span class="normal"><a href="#__codelineno-0-523"> 523</a></span>
<span class="normal"><a href="#__codelineno-0-524"> 524</a></span>
<span class="normal"><a href="#__codelineno-0-525"> 525</a></span>
<span class="normal"><a href="#__codelineno-0-526"> 526</a></span>
<span class="normal"><a href="#__codelineno-0-527"> 527</a></span>
<span class="normal"><a href="#__codelineno-0-528"> 528</a></span>
<span class="normal"><a href="#__codelineno-0-529"> 529</a></span>
<span class="normal"><a href="#__codelineno-0-530"> 530</a></span>
<span class="normal"><a href="#__codelineno-0-531"> 531</a></span>
<span class="normal"><a href="#__codelineno-0-532"> 532</a></span>
<span class="normal"><a href="#__codelineno-0-533"> 533</a></span>
<span class="normal"><a href="#__codelineno-0-534"> 534</a></span>
<span class="normal"><a href="#__codelineno-0-535"> 535</a></span>
<span class="normal"><a href="#__codelineno-0-536"> 536</a></span>
<span class="normal"><a href="#__codelineno-0-537"> 537</a></span>
<span class="normal"><a href="#__codelineno-0-538"> 538</a></span>
<span class="normal"><a href="#__codelineno-0-539"> 539</a></span>
<span class="normal"><a href="#__codelineno-0-540"> 540</a></span>
<span class="normal"><a href="#__codelineno-0-541"> 541</a></span>
<span class="normal"><a href="#__codelineno-0-542"> 542</a></span>
<span class="normal"><a href="#__codelineno-0-543"> 543</a></span>
<span class="normal"><a href="#__codelineno-0-544"> 544</a></span>
<span class="normal"><a href="#__codelineno-0-545"> 545</a></span>
<span class="normal"><a href="#__codelineno-0-546"> 546</a></span>
<span class="normal"><a href="#__codelineno-0-547"> 547</a></span>
<span class="normal"><a href="#__codelineno-0-548"> 548</a></span>
<span class="normal"><a href="#__codelineno-0-549"> 549</a></span>
<span class="normal"><a href="#__codelineno-0-550"> 550</a></span>
<span class="normal"><a href="#__codelineno-0-551"> 551</a></span>
<span class="normal"><a href="#__codelineno-0-552"> 552</a></span>
<span class="normal"><a href="#__codelineno-0-553"> 553</a></span>
<span class="normal"><a href="#__codelineno-0-554"> 554</a></span>
<span class="normal"><a href="#__codelineno-0-555"> 555</a></span>
<span class="normal"><a href="#__codelineno-0-556"> 556</a></span>
<span class="normal"><a href="#__codelineno-0-557"> 557</a></span>
<span class="normal"><a href="#__codelineno-0-558"> 558</a></span>
<span class="normal"><a href="#__codelineno-0-559"> 559</a></span>
<span class="normal"><a href="#__codelineno-0-560"> 560</a></span>
<span class="normal"><a href="#__codelineno-0-561"> 561</a></span>
<span class="normal"><a href="#__codelineno-0-562"> 562</a></span>
<span class="normal"><a href="#__codelineno-0-563"> 563</a></span>
<span class="normal"><a href="#__codelineno-0-564"> 564</a></span>
<span class="normal"><a href="#__codelineno-0-565"> 565</a></span>
<span class="normal"><a href="#__codelineno-0-566"> 566</a></span>
<span class="normal"><a href="#__codelineno-0-567"> 567</a></span>
<span class="normal"><a href="#__codelineno-0-568"> 568</a></span>
<span class="normal"><a href="#__codelineno-0-569"> 569</a></span>
<span class="normal"><a href="#__codelineno-0-570"> 570</a></span>
<span class="normal"><a href="#__codelineno-0-571"> 571</a></span>
<span class="normal"><a href="#__codelineno-0-572"> 572</a></span>
<span class="normal"><a href="#__codelineno-0-573"> 573</a></span>
<span class="normal"><a href="#__codelineno-0-574"> 574</a></span>
<span class="normal"><a href="#__codelineno-0-575"> 575</a></span>
<span class="normal"><a href="#__codelineno-0-576"> 576</a></span>
<span class="normal"><a href="#__codelineno-0-577"> 577</a></span>
<span class="normal"><a href="#__codelineno-0-578"> 578</a></span>
<span class="normal"><a href="#__codelineno-0-579"> 579</a></span>
<span class="normal"><a href="#__codelineno-0-580"> 580</a></span>
<span class="normal"><a href="#__codelineno-0-581"> 581</a></span>
<span class="normal"><a href="#__codelineno-0-582"> 582</a></span>
<span class="normal"><a href="#__codelineno-0-583"> 583</a></span>
<span class="normal"><a href="#__codelineno-0-584"> 584</a></span>
<span class="normal"><a href="#__codelineno-0-585"> 585</a></span>
<span class="normal"><a href="#__codelineno-0-586"> 586</a></span>
<span class="normal"><a href="#__codelineno-0-587"> 587</a></span>
<span class="normal"><a href="#__codelineno-0-588"> 588</a></span>
<span class="normal"><a href="#__codelineno-0-589"> 589</a></span>
<span class="normal"><a href="#__codelineno-0-590"> 590</a></span>
<span class="normal"><a href="#__codelineno-0-591"> 591</a></span>
<span class="normal"><a href="#__codelineno-0-592"> 592</a></span>
<span class="normal"><a href="#__codelineno-0-593"> 593</a></span>
<span class="normal"><a href="#__codelineno-0-594"> 594</a></span>
<span class="normal"><a href="#__codelineno-0-595"> 595</a></span>
<span class="normal"><a href="#__codelineno-0-596"> 596</a></span>
<span class="normal"><a href="#__codelineno-0-597"> 597</a></span>
<span class="normal"><a href="#__codelineno-0-598"> 598</a></span>
<span class="normal"><a href="#__codelineno-0-599"> 599</a></span>
<span class="normal"><a href="#__codelineno-0-600"> 600</a></span>
<span class="normal"><a href="#__codelineno-0-601"> 601</a></span>
<span class="normal"><a href="#__codelineno-0-602"> 602</a></span>
<span class="normal"><a href="#__codelineno-0-603"> 603</a></span>
<span class="normal"><a href="#__codelineno-0-604"> 604</a></span>
<span class="normal"><a href="#__codelineno-0-605"> 605</a></span>
<span class="normal"><a href="#__codelineno-0-606"> 606</a></span>
<span class="normal"><a href="#__codelineno-0-607"> 607</a></span>
<span class="normal"><a href="#__codelineno-0-608"> 608</a></span>
<span class="normal"><a href="#__codelineno-0-609"> 609</a></span>
<span class="normal"><a href="#__codelineno-0-610"> 610</a></span>
<span class="normal"><a href="#__codelineno-0-611"> 611</a></span>
<span class="normal"><a href="#__codelineno-0-612"> 612</a></span>
<span class="normal"><a href="#__codelineno-0-613"> 613</a></span>
<span class="normal"><a href="#__codelineno-0-614"> 614</a></span>
<span class="normal"><a href="#__codelineno-0-615"> 615</a></span>
<span class="normal"><a href="#__codelineno-0-616"> 616</a></span>
<span class="normal"><a href="#__codelineno-0-617"> 617</a></span>
<span class="normal"><a href="#__codelineno-0-618"> 618</a></span>
<span class="normal"><a href="#__codelineno-0-619"> 619</a></span>
<span class="normal"><a href="#__codelineno-0-620"> 620</a></span>
<span class="normal"><a href="#__codelineno-0-621"> 621</a></span>
<span class="normal"><a href="#__codelineno-0-622"> 622</a></span>
<span class="normal"><a href="#__codelineno-0-623"> 623</a></span>
<span class="normal"><a href="#__codelineno-0-624"> 624</a></span>
<span class="normal"><a href="#__codelineno-0-625"> 625</a></span>
<span class="normal"><a href="#__codelineno-0-626"> 626</a></span>
<span class="normal"><a href="#__codelineno-0-627"> 627</a></span>
<span class="normal"><a href="#__codelineno-0-628"> 628</a></span>
<span class="normal"><a href="#__codelineno-0-629"> 629</a></span>
<span class="normal"><a href="#__codelineno-0-630"> 630</a></span>
<span class="normal"><a href="#__codelineno-0-631"> 631</a></span>
<span class="normal"><a href="#__codelineno-0-632"> 632</a></span>
<span class="normal"><a href="#__codelineno-0-633"> 633</a></span>
<span class="normal"><a href="#__codelineno-0-634"> 634</a></span>
<span class="normal"><a href="#__codelineno-0-635"> 635</a></span>
<span class="normal"><a href="#__codelineno-0-636"> 636</a></span>
<span class="normal"><a href="#__codelineno-0-637"> 637</a></span>
<span class="normal"><a href="#__codelineno-0-638"> 638</a></span>
<span class="normal"><a href="#__codelineno-0-639"> 639</a></span>
<span class="normal"><a href="#__codelineno-0-640"> 640</a></span>
<span class="normal"><a href="#__codelineno-0-641"> 641</a></span>
<span class="normal"><a href="#__codelineno-0-642"> 642</a></span>
<span class="normal"><a href="#__codelineno-0-643"> 643</a></span>
<span class="normal"><a href="#__codelineno-0-644"> 644</a></span>
<span class="normal"><a href="#__codelineno-0-645"> 645</a></span>
<span class="normal"><a href="#__codelineno-0-646"> 646</a></span>
<span class="normal"><a href="#__codelineno-0-647"> 647</a></span>
<span class="normal"><a href="#__codelineno-0-648"> 648</a></span>
<span class="normal"><a href="#__codelineno-0-649"> 649</a></span>
<span class="normal"><a href="#__codelineno-0-650"> 650</a></span>
<span class="normal"><a href="#__codelineno-0-651"> 651</a></span>
<span class="normal"><a href="#__codelineno-0-652"> 652</a></span>
<span class="normal"><a href="#__codelineno-0-653"> 653</a></span>
<span class="normal"><a href="#__codelineno-0-654"> 654</a></span>
<span class="normal"><a href="#__codelineno-0-655"> 655</a></span>
<span class="normal"><a href="#__codelineno-0-656"> 656</a></span>
<span class="normal"><a href="#__codelineno-0-657"> 657</a></span>
<span class="normal"><a href="#__codelineno-0-658"> 658</a></span>
<span class="normal"><a href="#__codelineno-0-659"> 659</a></span>
<span class="normal"><a href="#__codelineno-0-660"> 660</a></span>
<span class="normal"><a href="#__codelineno-0-661"> 661</a></span>
<span class="normal"><a href="#__codelineno-0-662"> 662</a></span>
<span class="normal"><a href="#__codelineno-0-663"> 663</a></span>
<span class="normal"><a href="#__codelineno-0-664"> 664</a></span>
<span class="normal"><a href="#__codelineno-0-665"> 665</a></span>
<span class="normal"><a href="#__codelineno-0-666"> 666</a></span>
<span class="normal"><a href="#__codelineno-0-667"> 667</a></span>
<span class="normal"><a href="#__codelineno-0-668"> 668</a></span>
<span class="normal"><a href="#__codelineno-0-669"> 669</a></span>
<span class="normal"><a href="#__codelineno-0-670"> 670</a></span>
<span class="normal"><a href="#__codelineno-0-671"> 671</a></span>
<span class="normal"><a href="#__codelineno-0-672"> 672</a></span>
<span class="normal"><a href="#__codelineno-0-673"> 673</a></span>
<span class="normal"><a href="#__codelineno-0-674"> 674</a></span>
<span class="normal"><a href="#__codelineno-0-675"> 675</a></span>
<span class="normal"><a href="#__codelineno-0-676"> 676</a></span>
<span class="normal"><a href="#__codelineno-0-677"> 677</a></span>
<span class="normal"><a href="#__codelineno-0-678"> 678</a></span>
<span class="normal"><a href="#__codelineno-0-679"> 679</a></span>
<span class="normal"><a href="#__codelineno-0-680"> 680</a></span>
<span class="normal"><a href="#__codelineno-0-681"> 681</a></span>
<span class="normal"><a href="#__codelineno-0-682"> 682</a></span>
<span class="normal"><a href="#__codelineno-0-683"> 683</a></span>
<span class="normal"><a href="#__codelineno-0-684"> 684</a></span>
<span class="normal"><a href="#__codelineno-0-685"> 685</a></span>
<span class="normal"><a href="#__codelineno-0-686"> 686</a></span>
<span class="normal"><a href="#__codelineno-0-687"> 687</a></span>
<span class="normal"><a href="#__codelineno-0-688"> 688</a></span>
<span class="normal"><a href="#__codelineno-0-689"> 689</a></span>
<span class="normal"><a href="#__codelineno-0-690"> 690</a></span>
<span class="normal"><a href="#__codelineno-0-691"> 691</a></span>
<span class="normal"><a href="#__codelineno-0-692"> 692</a></span>
<span class="normal"><a href="#__codelineno-0-693"> 693</a></span>
<span class="normal"><a href="#__codelineno-0-694"> 694</a></span>
<span class="normal"><a href="#__codelineno-0-695"> 695</a></span>
<span class="normal"><a href="#__codelineno-0-696"> 696</a></span>
<span class="normal"><a href="#__codelineno-0-697"> 697</a></span>
<span class="normal"><a href="#__codelineno-0-698"> 698</a></span>
<span class="normal"><a href="#__codelineno-0-699"> 699</a></span>
<span class="normal"><a href="#__codelineno-0-700"> 700</a></span>
<span class="normal"><a href="#__codelineno-0-701"> 701</a></span>
<span class="normal"><a href="#__codelineno-0-702"> 702</a></span>
<span class="normal"><a href="#__codelineno-0-703"> 703</a></span>
<span class="normal"><a href="#__codelineno-0-704"> 704</a></span>
<span class="normal"><a href="#__codelineno-0-705"> 705</a></span>
<span class="normal"><a href="#__codelineno-0-706"> 706</a></span>
<span class="normal"><a href="#__codelineno-0-707"> 707</a></span>
<span class="normal"><a href="#__codelineno-0-708"> 708</a></span>
<span class="normal"><a href="#__codelineno-0-709"> 709</a></span>
<span class="normal"><a href="#__codelineno-0-710"> 710</a></span>
<span class="normal"><a href="#__codelineno-0-711"> 711</a></span>
<span class="normal"><a href="#__codelineno-0-712"> 712</a></span>
<span class="normal"><a href="#__codelineno-0-713"> 713</a></span>
<span class="normal"><a href="#__codelineno-0-714"> 714</a></span>
<span class="normal"><a href="#__codelineno-0-715"> 715</a></span>
<span class="normal"><a href="#__codelineno-0-716"> 716</a></span>
<span class="normal"><a href="#__codelineno-0-717"> 717</a></span>
<span class="normal"><a href="#__codelineno-0-718"> 718</a></span>
<span class="normal"><a href="#__codelineno-0-719"> 719</a></span>
<span class="normal"><a href="#__codelineno-0-720"> 720</a></span>
<span class="normal"><a href="#__codelineno-0-721"> 721</a></span>
<span class="normal"><a href="#__codelineno-0-722"> 722</a></span>
<span class="normal"><a href="#__codelineno-0-723"> 723</a></span>
<span class="normal"><a href="#__codelineno-0-724"> 724</a></span>
<span class="normal"><a href="#__codelineno-0-725"> 725</a></span>
<span class="normal"><a href="#__codelineno-0-726"> 726</a></span>
<span class="normal"><a href="#__codelineno-0-727"> 727</a></span>
<span class="normal"><a href="#__codelineno-0-728"> 728</a></span>
<span class="normal"><a href="#__codelineno-0-729"> 729</a></span>
<span class="normal"><a href="#__codelineno-0-730"> 730</a></span>
<span class="normal"><a href="#__codelineno-0-731"> 731</a></span>
<span class="normal"><a href="#__codelineno-0-732"> 732</a></span>
<span class="normal"><a href="#__codelineno-0-733"> 733</a></span>
<span class="normal"><a href="#__codelineno-0-734"> 734</a></span>
<span class="normal"><a href="#__codelineno-0-735"> 735</a></span>
<span class="normal"><a href="#__codelineno-0-736"> 736</a></span>
<span class="normal"><a href="#__codelineno-0-737"> 737</a></span>
<span class="normal"><a href="#__codelineno-0-738"> 738</a></span>
<span class="normal"><a href="#__codelineno-0-739"> 739</a></span>
<span class="normal"><a href="#__codelineno-0-740"> 740</a></span>
<span class="normal"><a href="#__codelineno-0-741"> 741</a></span>
<span class="normal"><a href="#__codelineno-0-742"> 742</a></span>
<span class="normal"><a href="#__codelineno-0-743"> 743</a></span>
<span class="normal"><a href="#__codelineno-0-744"> 744</a></span>
<span class="normal"><a href="#__codelineno-0-745"> 745</a></span>
<span class="normal"><a href="#__codelineno-0-746"> 746</a></span>
<span class="normal"><a href="#__codelineno-0-747"> 747</a></span>
<span class="normal"><a href="#__codelineno-0-748"> 748</a></span>
<span class="normal"><a href="#__codelineno-0-749"> 749</a></span>
<span class="normal"><a href="#__codelineno-0-750"> 750</a></span>
<span class="normal"><a href="#__codelineno-0-751"> 751</a></span>
<span class="normal"><a href="#__codelineno-0-752"> 752</a></span>
<span class="normal"><a href="#__codelineno-0-753"> 753</a></span>
<span class="normal"><a href="#__codelineno-0-754"> 754</a></span>
<span class="normal"><a href="#__codelineno-0-755"> 755</a></span>
<span class="normal"><a href="#__codelineno-0-756"> 756</a></span>
<span class="normal"><a href="#__codelineno-0-757"> 757</a></span>
<span class="normal"><a href="#__codelineno-0-758"> 758</a></span>
<span class="normal"><a href="#__codelineno-0-759"> 759</a></span>
<span class="normal"><a href="#__codelineno-0-760"> 760</a></span>
<span class="normal"><a href="#__codelineno-0-761"> 761</a></span>
<span class="normal"><a href="#__codelineno-0-762"> 762</a></span>
<span class="normal"><a href="#__codelineno-0-763"> 763</a></span>
<span class="normal"><a href="#__codelineno-0-764"> 764</a></span>
<span class="normal"><a href="#__codelineno-0-765"> 765</a></span>
<span class="normal"><a href="#__codelineno-0-766"> 766</a></span>
<span class="normal"><a href="#__codelineno-0-767"> 767</a></span>
<span class="normal"><a href="#__codelineno-0-768"> 768</a></span>
<span class="normal"><a href="#__codelineno-0-769"> 769</a></span>
<span class="normal"><a href="#__codelineno-0-770"> 770</a></span>
<span class="normal"><a href="#__codelineno-0-771"> 771</a></span>
<span class="normal"><a href="#__codelineno-0-772"> 772</a></span>
<span class="normal"><a href="#__codelineno-0-773"> 773</a></span>
<span class="normal"><a href="#__codelineno-0-774"> 774</a></span>
<span class="normal"><a href="#__codelineno-0-775"> 775</a></span>
<span class="normal"><a href="#__codelineno-0-776"> 776</a></span>
<span class="normal"><a href="#__codelineno-0-777"> 777</a></span>
<span class="normal"><a href="#__codelineno-0-778"> 778</a></span>
<span class="normal"><a href="#__codelineno-0-779"> 779</a></span>
<span class="normal"><a href="#__codelineno-0-780"> 780</a></span>
<span class="normal"><a href="#__codelineno-0-781"> 781</a></span>
<span class="normal"><a href="#__codelineno-0-782"> 782</a></span>
<span class="normal"><a href="#__codelineno-0-783"> 783</a></span>
<span class="normal"><a href="#__codelineno-0-784"> 784</a></span>
<span class="normal"><a href="#__codelineno-0-785"> 785</a></span>
<span class="normal"><a href="#__codelineno-0-786"> 786</a></span>
<span class="normal"><a href="#__codelineno-0-787"> 787</a></span>
<span class="normal"><a href="#__codelineno-0-788"> 788</a></span>
<span class="normal"><a href="#__codelineno-0-789"> 789</a></span>
<span class="normal"><a href="#__codelineno-0-790"> 790</a></span>
<span class="normal"><a href="#__codelineno-0-791"> 791</a></span>
<span class="normal"><a href="#__codelineno-0-792"> 792</a></span>
<span class="normal"><a href="#__codelineno-0-793"> 793</a></span>
<span class="normal"><a href="#__codelineno-0-794"> 794</a></span>
<span class="normal"><a href="#__codelineno-0-795"> 795</a></span>
<span class="normal"><a href="#__codelineno-0-796"> 796</a></span>
<span class="normal"><a href="#__codelineno-0-797"> 797</a></span>
<span class="normal"><a href="#__codelineno-0-798"> 798</a></span>
<span class="normal"><a href="#__codelineno-0-799"> 799</a></span>
<span class="normal"><a href="#__codelineno-0-800"> 800</a></span>
<span class="normal"><a href="#__codelineno-0-801"> 801</a></span>
<span class="normal"><a href="#__codelineno-0-802"> 802</a></span>
<span class="normal"><a href="#__codelineno-0-803"> 803</a></span>
<span class="normal"><a href="#__codelineno-0-804"> 804</a></span>
<span class="normal"><a href="#__codelineno-0-805"> 805</a></span>
<span class="normal"><a href="#__codelineno-0-806"> 806</a></span>
<span class="normal"><a href="#__codelineno-0-807"> 807</a></span>
<span class="normal"><a href="#__codelineno-0-808"> 808</a></span>
<span class="normal"><a href="#__codelineno-0-809"> 809</a></span>
<span class="normal"><a href="#__codelineno-0-810"> 810</a></span>
<span class="normal"><a href="#__codelineno-0-811"> 811</a></span>
<span class="normal"><a href="#__codelineno-0-812"> 812</a></span>
<span class="normal"><a href="#__codelineno-0-813"> 813</a></span>
<span class="normal"><a href="#__codelineno-0-814"> 814</a></span>
<span class="normal"><a href="#__codelineno-0-815"> 815</a></span>
<span class="normal"><a href="#__codelineno-0-816"> 816</a></span>
<span class="normal"><a href="#__codelineno-0-817"> 817</a></span>
<span class="normal"><a href="#__codelineno-0-818"> 818</a></span>
<span class="normal"><a href="#__codelineno-0-819"> 819</a></span>
<span class="normal"><a href="#__codelineno-0-820"> 820</a></span>
<span class="normal"><a href="#__codelineno-0-821"> 821</a></span>
<span class="normal"><a href="#__codelineno-0-822"> 822</a></span>
<span class="normal"><a href="#__codelineno-0-823"> 823</a></span>
<span class="normal"><a href="#__codelineno-0-824"> 824</a></span>
<span class="normal"><a href="#__codelineno-0-825"> 825</a></span>
<span class="normal"><a href="#__codelineno-0-826"> 826</a></span>
<span class="normal"><a href="#__codelineno-0-827"> 827</a></span>
<span class="normal"><a href="#__codelineno-0-828"> 828</a></span>
<span class="normal"><a href="#__codelineno-0-829"> 829</a></span>
<span class="normal"><a href="#__codelineno-0-830"> 830</a></span>
<span class="normal"><a href="#__codelineno-0-831"> 831</a></span>
<span class="normal"><a href="#__codelineno-0-832"> 832</a></span>
<span class="normal"><a href="#__codelineno-0-833"> 833</a></span>
<span class="normal"><a href="#__codelineno-0-834"> 834</a></span>
<span class="normal"><a href="#__codelineno-0-835"> 835</a></span>
<span class="normal"><a href="#__codelineno-0-836"> 836</a></span>
<span class="normal"><a href="#__codelineno-0-837"> 837</a></span>
<span class="normal"><a href="#__codelineno-0-838"> 838</a></span>
<span class="normal"><a href="#__codelineno-0-839"> 839</a></span>
<span class="normal"><a href="#__codelineno-0-840"> 840</a></span>
<span class="normal"><a href="#__codelineno-0-841"> 841</a></span>
<span class="normal"><a href="#__codelineno-0-842"> 842</a></span>
<span class="normal"><a href="#__codelineno-0-843"> 843</a></span>
<span class="normal"><a href="#__codelineno-0-844"> 844</a></span>
<span class="normal"><a href="#__codelineno-0-845"> 845</a></span>
<span class="normal"><a href="#__codelineno-0-846"> 846</a></span>
<span class="normal"><a href="#__codelineno-0-847"> 847</a></span>
<span class="normal"><a href="#__codelineno-0-848"> 848</a></span>
<span class="normal"><a href="#__codelineno-0-849"> 849</a></span>
<span class="normal"><a href="#__codelineno-0-850"> 850</a></span>
<span class="normal"><a href="#__codelineno-0-851"> 851</a></span>
<span class="normal"><a href="#__codelineno-0-852"> 852</a></span>
<span class="normal"><a href="#__codelineno-0-853"> 853</a></span>
<span class="normal"><a href="#__codelineno-0-854"> 854</a></span>
<span class="normal"><a href="#__codelineno-0-855"> 855</a></span>
<span class="normal"><a href="#__codelineno-0-856"> 856</a></span>
<span class="normal"><a href="#__codelineno-0-857"> 857</a></span>
<span class="normal"><a href="#__codelineno-0-858"> 858</a></span>
<span class="normal"><a href="#__codelineno-0-859"> 859</a></span>
<span class="normal"><a href="#__codelineno-0-860"> 860</a></span>
<span class="normal"><a href="#__codelineno-0-861"> 861</a></span>
<span class="normal"><a href="#__codelineno-0-862"> 862</a></span>
<span class="normal"><a href="#__codelineno-0-863"> 863</a></span>
<span class="normal"><a href="#__codelineno-0-864"> 864</a></span>
<span class="normal"><a href="#__codelineno-0-865"> 865</a></span>
<span class="normal"><a href="#__codelineno-0-866"> 866</a></span>
<span class="normal"><a href="#__codelineno-0-867"> 867</a></span>
<span class="normal"><a href="#__codelineno-0-868"> 868</a></span>
<span class="normal"><a href="#__codelineno-0-869"> 869</a></span>
<span class="normal"><a href="#__codelineno-0-870"> 870</a></span>
<span class="normal"><a href="#__codelineno-0-871"> 871</a></span>
<span class="normal"><a href="#__codelineno-0-872"> 872</a></span>
<span class="normal"><a href="#__codelineno-0-873"> 873</a></span>
<span class="normal"><a href="#__codelineno-0-874"> 874</a></span>
<span class="normal"><a href="#__codelineno-0-875"> 875</a></span>
<span class="normal"><a href="#__codelineno-0-876"> 876</a></span>
<span class="normal"><a href="#__codelineno-0-877"> 877</a></span>
<span class="normal"><a href="#__codelineno-0-878"> 878</a></span>
<span class="normal"><a href="#__codelineno-0-879"> 879</a></span>
<span class="normal"><a href="#__codelineno-0-880"> 880</a></span>
<span class="normal"><a href="#__codelineno-0-881"> 881</a></span>
<span class="normal"><a href="#__codelineno-0-882"> 882</a></span>
<span class="normal"><a href="#__codelineno-0-883"> 883</a></span>
<span class="normal"><a href="#__codelineno-0-884"> 884</a></span>
<span class="normal"><a href="#__codelineno-0-885"> 885</a></span>
<span class="normal"><a href="#__codelineno-0-886"> 886</a></span>
<span class="normal"><a href="#__codelineno-0-887"> 887</a></span>
<span class="normal"><a href="#__codelineno-0-888"> 888</a></span>
<span class="normal"><a href="#__codelineno-0-889"> 889</a></span>
<span class="normal"><a href="#__codelineno-0-890"> 890</a></span>
<span class="normal"><a href="#__codelineno-0-891"> 891</a></span>
<span class="normal"><a href="#__codelineno-0-892"> 892</a></span>
<span class="normal"><a href="#__codelineno-0-893"> 893</a></span>
<span class="normal"><a href="#__codelineno-0-894"> 894</a></span>
<span class="normal"><a href="#__codelineno-0-895"> 895</a></span>
<span class="normal"><a href="#__codelineno-0-896"> 896</a></span>
<span class="normal"><a href="#__codelineno-0-897"> 897</a></span>
<span class="normal"><a href="#__codelineno-0-898"> 898</a></span>
<span class="normal"><a href="#__codelineno-0-899"> 899</a></span>
<span class="normal"><a href="#__codelineno-0-900"> 900</a></span>
<span class="normal"><a href="#__codelineno-0-901"> 901</a></span>
<span class="normal"><a href="#__codelineno-0-902"> 902</a></span>
<span class="normal"><a href="#__codelineno-0-903"> 903</a></span>
<span class="normal"><a href="#__codelineno-0-904"> 904</a></span>
<span class="normal"><a href="#__codelineno-0-905"> 905</a></span>
<span class="normal"><a href="#__codelineno-0-906"> 906</a></span>
<span class="normal"><a href="#__codelineno-0-907"> 907</a></span>
<span class="normal"><a href="#__codelineno-0-908"> 908</a></span>
<span class="normal"><a href="#__codelineno-0-909"> 909</a></span>
<span class="normal"><a href="#__codelineno-0-910"> 910</a></span>
<span class="normal"><a href="#__codelineno-0-911"> 911</a></span>
<span class="normal"><a href="#__codelineno-0-912"> 912</a></span>
<span class="normal"><a href="#__codelineno-0-913"> 913</a></span>
<span class="normal"><a href="#__codelineno-0-914"> 914</a></span>
<span class="normal"><a href="#__codelineno-0-915"> 915</a></span>
<span class="normal"><a href="#__codelineno-0-916"> 916</a></span>
<span class="normal"><a href="#__codelineno-0-917"> 917</a></span>
<span class="normal"><a href="#__codelineno-0-918"> 918</a></span>
<span class="normal"><a href="#__codelineno-0-919"> 919</a></span>
<span class="normal"><a href="#__codelineno-0-920"> 920</a></span>
<span class="normal"><a href="#__codelineno-0-921"> 921</a></span>
<span class="normal"><a href="#__codelineno-0-922"> 922</a></span>
<span class="normal"><a href="#__codelineno-0-923"> 923</a></span>
<span class="normal"><a href="#__codelineno-0-924"> 924</a></span>
<span class="normal"><a href="#__codelineno-0-925"> 925</a></span>
<span class="normal"><a href="#__codelineno-0-926"> 926</a></span>
<span class="normal"><a href="#__codelineno-0-927"> 927</a></span>
<span class="normal"><a href="#__codelineno-0-928"> 928</a></span>
<span class="normal"><a href="#__codelineno-0-929"> 929</a></span>
<span class="normal"><a href="#__codelineno-0-930"> 930</a></span>
<span class="normal"><a href="#__codelineno-0-931"> 931</a></span>
<span class="normal"><a href="#__codelineno-0-932"> 932</a></span>
<span class="normal"><a href="#__codelineno-0-933"> 933</a></span>
<span class="normal"><a href="#__codelineno-0-934"> 934</a></span>
<span class="normal"><a href="#__codelineno-0-935"> 935</a></span>
<span class="normal"><a href="#__codelineno-0-936"> 936</a></span>
<span class="normal"><a href="#__codelineno-0-937"> 937</a></span>
<span class="normal"><a href="#__codelineno-0-938"> 938</a></span>
<span class="normal"><a href="#__codelineno-0-939"> 939</a></span>
<span class="normal"><a href="#__codelineno-0-940"> 940</a></span>
<span class="normal"><a href="#__codelineno-0-941"> 941</a></span>
<span class="normal"><a href="#__codelineno-0-942"> 942</a></span>
<span class="normal"><a href="#__codelineno-0-943"> 943</a></span>
<span class="normal"><a href="#__codelineno-0-944"> 944</a></span>
<span class="normal"><a href="#__codelineno-0-945"> 945</a></span>
<span class="normal"><a href="#__codelineno-0-946"> 946</a></span>
<span class="normal"><a href="#__codelineno-0-947"> 947</a></span>
<span class="normal"><a href="#__codelineno-0-948"> 948</a></span>
<span class="normal"><a href="#__codelineno-0-949"> 949</a></span>
<span class="normal"><a href="#__codelineno-0-950"> 950</a></span>
<span class="normal"><a href="#__codelineno-0-951"> 951</a></span>
<span class="normal"><a href="#__codelineno-0-952"> 952</a></span>
<span class="normal"><a href="#__codelineno-0-953"> 953</a></span>
<span class="normal"><a href="#__codelineno-0-954"> 954</a></span>
<span class="normal"><a href="#__codelineno-0-955"> 955</a></span>
<span class="normal"><a href="#__codelineno-0-956"> 956</a></span>
<span class="normal"><a href="#__codelineno-0-957"> 957</a></span>
<span class="normal"><a href="#__codelineno-0-958"> 958</a></span>
<span class="normal"><a href="#__codelineno-0-959"> 959</a></span>
<span class="normal"><a href="#__codelineno-0-960"> 960</a></span>
<span class="normal"><a href="#__codelineno-0-961"> 961</a></span>
<span class="normal"><a href="#__codelineno-0-962"> 962</a></span>
<span class="normal"><a href="#__codelineno-0-963"> 963</a></span>
<span class="normal"><a href="#__codelineno-0-964"> 964</a></span>
<span class="normal"><a href="#__codelineno-0-965"> 965</a></span>
<span class="normal"><a href="#__codelineno-0-966"> 966</a></span>
<span class="normal"><a href="#__codelineno-0-967"> 967</a></span>
<span class="normal"><a href="#__codelineno-0-968"> 968</a></span>
<span class="normal"><a href="#__codelineno-0-969"> 969</a></span>
<span class="normal"><a href="#__codelineno-0-970"> 970</a></span>
<span class="normal"><a href="#__codelineno-0-971"> 971</a></span>
<span class="normal"><a href="#__codelineno-0-972"> 972</a></span>
<span class="normal"><a href="#__codelineno-0-973"> 973</a></span>
<span class="normal"><a href="#__codelineno-0-974"> 974</a></span>
<span class="normal"><a href="#__codelineno-0-975"> 975</a></span>
<span class="normal"><a href="#__codelineno-0-976"> 976</a></span>
<span class="normal"><a href="#__codelineno-0-977"> 977</a></span>
<span class="normal"><a href="#__codelineno-0-978"> 978</a></span>
<span class="normal"><a href="#__codelineno-0-979"> 979</a></span>
<span class="normal"><a href="#__codelineno-0-980"> 980</a></span>
<span class="normal"><a href="#__codelineno-0-981"> 981</a></span>
<span class="normal"><a href="#__codelineno-0-982"> 982</a></span>
<span class="normal"><a href="#__codelineno-0-983"> 983</a></span>
<span class="normal"><a href="#__codelineno-0-984"> 984</a></span>
<span class="normal"><a href="#__codelineno-0-985"> 985</a></span>
<span class="normal"><a href="#__codelineno-0-986"> 986</a></span>
<span class="normal"><a href="#__codelineno-0-987"> 987</a></span>
<span class="normal"><a href="#__codelineno-0-988"> 988</a></span>
<span class="normal"><a href="#__codelineno-0-989"> 989</a></span>
<span class="normal"><a href="#__codelineno-0-990"> 990</a></span>
<span class="normal"><a href="#__codelineno-0-991"> 991</a></span>
<span class="normal"><a href="#__codelineno-0-992"> 992</a></span>
<span class="normal"><a href="#__codelineno-0-993"> 993</a></span>
<span class="normal"><a href="#__codelineno-0-994"> 994</a></span>
<span class="normal"><a href="#__codelineno-0-995"> 995</a></span>
<span class="normal"><a href="#__codelineno-0-996"> 996</a></span>
<span class="normal"><a href="#__codelineno-0-997"> 997</a></span>
<span class="normal"><a href="#__codelineno-0-998"> 998</a></span>
<span class="normal"><a href="#__codelineno-0-999"> 999</a></span>
<span class="normal"><a href="#__codelineno-0-1000">1000</a></span>
<span class="normal"><a href="#__codelineno-0-1001">1001</a></span>
<span class="normal"><a href="#__codelineno-0-1002">1002</a></span>
<span class="normal"><a href="#__codelineno-0-1003">1003</a></span>
<span class="normal"><a href="#__codelineno-0-1004">1004</a></span>
<span class="normal"><a href="#__codelineno-0-1005">1005</a></span>
<span class="normal"><a href="#__codelineno-0-1006">1006</a></span>
<span class="normal"><a href="#__codelineno-0-1007">1007</a></span>
<span class="normal"><a href="#__codelineno-0-1008">1008</a></span>
<span class="normal"><a href="#__codelineno-0-1009">1009</a></span>
<span class="normal"><a href="#__codelineno-0-1010">1010</a></span>
<span class="normal"><a href="#__codelineno-0-1011">1011</a></span>
<span class="normal"><a href="#__codelineno-0-1012">1012</a></span>
<span class="normal"><a href="#__codelineno-0-1013">1013</a></span>
<span class="normal"><a href="#__codelineno-0-1014">1014</a></span>
<span class="normal"><a href="#__codelineno-0-1015">1015</a></span>
<span class="normal"><a href="#__codelineno-0-1016">1016</a></span>
<span class="normal"><a href="#__codelineno-0-1017">1017</a></span>
<span class="normal"><a href="#__codelineno-0-1018">1018</a></span>
<span class="normal"><a href="#__codelineno-0-1019">1019</a></span>
<span class="normal"><a href="#__codelineno-0-1020">1020</a></span>
<span class="normal"><a href="#__codelineno-0-1021">1021</a></span>
<span class="normal"><a href="#__codelineno-0-1022">1022</a></span>
<span class="normal"><a href="#__codelineno-0-1023">1023</a></span>
<span class="normal"><a href="#__codelineno-0-1024">1024</a></span>
<span class="normal"><a href="#__codelineno-0-1025">1025</a></span>
<span class="normal"><a href="#__codelineno-0-1026">1026</a></span>
<span class="normal"><a href="#__codelineno-0-1027">1027</a></span>
<span class="normal"><a href="#__codelineno-0-1028">1028</a></span>
<span class="normal"><a href="#__codelineno-0-1029">1029</a></span>
<span class="normal"><a href="#__codelineno-0-1030">1030</a></span>
<span class="normal"><a href="#__codelineno-0-1031">1031</a></span>
<span class="normal"><a href="#__codelineno-0-1032">1032</a></span>
<span class="normal"><a href="#__codelineno-0-1033">1033</a></span>
<span class="normal"><a href="#__codelineno-0-1034">1034</a></span>
<span class="normal"><a href="#__codelineno-0-1035">1035</a></span>
<span class="normal"><a href="#__codelineno-0-1036">1036</a></span>
<span class="normal"><a href="#__codelineno-0-1037">1037</a></span>
<span class="normal"><a href="#__codelineno-0-1038">1038</a></span>
<span class="normal"><a href="#__codelineno-0-1039">1039</a></span>
<span class="normal"><a href="#__codelineno-0-1040">1040</a></span>
<span class="normal"><a href="#__codelineno-0-1041">1041</a></span>
<span class="normal"><a href="#__codelineno-0-1042">1042</a></span>
<span class="normal"><a href="#__codelineno-0-1043">1043</a></span>
<span class="normal"><a href="#__codelineno-0-1044">1044</a></span>
<span class="normal"><a href="#__codelineno-0-1045">1045</a></span>
<span class="normal"><a href="#__codelineno-0-1046">1046</a></span>
<span class="normal"><a href="#__codelineno-0-1047">1047</a></span>
<span class="normal"><a href="#__codelineno-0-1048">1048</a></span>
<span class="normal"><a href="#__codelineno-0-1049">1049</a></span>
<span class="normal"><a href="#__codelineno-0-1050">1050</a></span>
<span class="normal"><a href="#__codelineno-0-1051">1051</a></span>
<span class="normal"><a href="#__codelineno-0-1052">1052</a></span>
<span class="normal"><a href="#__codelineno-0-1053">1053</a></span>
<span class="normal"><a href="#__codelineno-0-1054">1054</a></span>
<span class="normal"><a href="#__codelineno-0-1055">1055</a></span>
<span class="normal"><a href="#__codelineno-0-1056">1056</a></span>
<span class="normal"><a href="#__codelineno-0-1057">1057</a></span>
<span class="normal"><a href="#__codelineno-0-1058">1058</a></span>
<span class="normal"><a href="#__codelineno-0-1059">1059</a></span>
<span class="normal"><a href="#__codelineno-0-1060">1060</a></span>
<span class="normal"><a href="#__codelineno-0-1061">1061</a></span>
<span class="normal"><a href="#__codelineno-0-1062">1062</a></span>
<span class="normal"><a href="#__codelineno-0-1063">1063</a></span>
<span class="normal"><a href="#__codelineno-0-1064">1064</a></span>
<span class="normal"><a href="#__codelineno-0-1065">1065</a></span>
<span class="normal"><a href="#__codelineno-0-1066">1066</a></span>
<span class="normal"><a href="#__codelineno-0-1067">1067</a></span>
<span class="normal"><a href="#__codelineno-0-1068">1068</a></span>
<span class="normal"><a href="#__codelineno-0-1069">1069</a></span>
<span class="normal"><a href="#__codelineno-0-1070">1070</a></span>
<span class="normal"><a href="#__codelineno-0-1071">1071</a></span>
<span class="normal"><a href="#__codelineno-0-1072">1072</a></span>
<span class="normal"><a href="#__codelineno-0-1073">1073</a></span>
<span class="normal"><a href="#__codelineno-0-1074">1074</a></span>
<span class="normal"><a href="#__codelineno-0-1075">1075</a></span>
<span class="normal"><a href="#__codelineno-0-1076">1076</a></span>
<span class="normal"><a href="#__codelineno-0-1077">1077</a></span>
<span class="normal"><a href="#__codelineno-0-1078">1078</a></span>
<span class="normal"><a href="#__codelineno-0-1079">1079</a></span>
<span class="normal"><a href="#__codelineno-0-1080">1080</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="k">class</span><span class="w"> </span><span class="nc">OneImageAnalysis</span><span class="p">:</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">        This class takes a 3D matrix (2 space and 1 color [BGR] dimensions),</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">        Its methods allow image</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">        - conversion to any bgr/hsv/lab channels</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">        - croping</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">        - rotating</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">        - filtering using some of the mainly used techniques:</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">            - Gaussian, Median, Bilateral, Laplacian, Mexican hat</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">        - segmenting using thresholds or kmeans</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">        - shape selection according to horizontal size or shape (&#39;circle&#39; vs &#39;quadrilateral&#39;)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">        ps: A viewing method displays the image before and after the most advanced modification made in instance</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">shape_number</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">image</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">already_greyscale</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">already_greyscale</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image2</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">drift_correction_already_adjusted</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="c1"># Create empty variables to fill in the following functions</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">previous_binary_image</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validated_shapes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">centroids</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shape_number</span> <span class="o">=</span> <span class="n">shape_number</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">concomp_stats</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y_boundaries</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x_boundaries</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">crop_coord</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cropped</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subtract_background</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subtract_background2</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bgr</span> <span class="o">=</span> <span class="n">image</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colorspace_list</span> <span class="o">=</span> <span class="n">TList</span><span class="p">((</span><span class="s2">&quot;bgr&quot;</span><span class="p">,</span> <span class="s2">&quot;lab&quot;</span><span class="p">,</span> <span class="s2">&quot;hsv&quot;</span><span class="p">,</span> <span class="s2">&quot;luv&quot;</span><span class="p">,</span> <span class="s2">&quot;hls&quot;</span><span class="p">,</span> <span class="s2">&quot;yuv&quot;</span><span class="p">))</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">spot_shapes</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">all_c_spaces</span> <span class="o">=</span> <span class="n">TDict</span><span class="p">()</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">hsv</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">hls</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lab</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">luv</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">yuv</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">greyscale</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">greyscale2</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">first_pc_vector</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">drift_mask_coord</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">convert_and_segment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c_space_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">color_number</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">biomask</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>                            <span class="n">backmask</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subtract_background</span><span class="p">:</span> <span class="n">NDArray</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>                            <span class="n">subtract_background2</span><span class="p">:</span> <span class="n">NDArray</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rolling_window_segmentation</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>                            <span class="n">lighter_background</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>                            <span class="n">allowed_window</span><span class="p">:</span> <span class="n">NDArray</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_spec</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="sd">        Convert an image to grayscale and segment it based on specified parameters.</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="sd">        This method converts the given color space dictionary into grayscale</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">        images, combines them with existing color spaces and performs segmentation.</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="sd">        It has special handling for images that are already in grayscale.</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="sd">        **Args:**</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">        - `c_space_dict` (dict): Dictionary containing color spaces.</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="sd">        - `color_number` (int, optional): Number of colors to use in segmentation. Defaults to 2.</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="sd">        - `biomask` (NDArray[np.uint8], optional): Biomask for segmentation. Defaults to None.</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="sd">        - `backmask` (NDArray[np.uint8], optional): Backmask for segmentation. Defaults to None.</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="sd">        - `subtract_background` (NDArray, optional): Background to subtract. Defaults to None.</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">        - `subtract_background2` (NDArray, optional): Second background to subtract. Defaults to None.</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">        - rolling_window_segmentation (dict, optional): Flag for grid segmentation. Defaults to None.</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="sd">        - `lighter_background` (bool, optional): Flag for lighter background. Defaults to None.</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="sd">        - `mask` (NDArray, optional): Additional mask for segmentation. Defaults to None.</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="sd">        - `filter_spec` (dict, optional): Filter specifications. Defaults to None.</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a><span class="sd">        **Attributes:**</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="sd">        - `self.already_greyscale` (bool): Indicates whether the image is already greyscale.</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="sd">        - `self.all_c_spaces` (list): List of color spaces.</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">already_greyscale</span><span class="p">:</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>            <span class="n">first_dict</span><span class="p">,</span> <span class="n">second_dict</span><span class="p">,</span> <span class="n">c_spaces</span> <span class="o">=</span> <span class="n">split_dict</span><span class="p">(</span><span class="n">c_space_dict</span><span class="p">)</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image2</span><span class="p">,</span> <span class="n">all_c_spaces</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_pc_vector</span> <span class="o">=</span> <span class="n">generate_color_space_combination</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bgr</span><span class="p">,</span> <span class="n">c_spaces</span><span class="p">,</span> <span class="n">first_dict</span><span class="p">,</span> <span class="n">second_dict</span><span class="p">,</span> <span class="n">subtract_background</span><span class="p">,</span> <span class="n">subtract_background2</span><span class="p">)</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_c_spaces</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_c_spaces</span><span class="p">):</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">all_c_spaces</span> <span class="o">=</span> <span class="n">all_c_spaces</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">segmentation</span><span class="p">(</span><span class="n">logical</span><span class="o">=</span><span class="n">c_space_dict</span><span class="p">[</span><span class="s1">&#39;logical&#39;</span><span class="p">],</span> <span class="n">color_number</span><span class="o">=</span><span class="n">color_number</span><span class="p">,</span> <span class="n">biomask</span><span class="o">=</span><span class="n">biomask</span><span class="p">,</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>                          <span class="n">backmask</span><span class="o">=</span><span class="n">backmask</span><span class="p">,</span> <span class="n">rolling_window_segmentation</span><span class="o">=</span><span class="n">rolling_window_segmentation</span><span class="p">,</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>                          <span class="n">lighter_background</span><span class="o">=</span><span class="n">lighter_background</span><span class="p">,</span> <span class="n">allowed_window</span><span class="o">=</span><span class="n">allowed_window</span><span class="p">,</span> <span class="n">filter_spec</span><span class="o">=</span><span class="n">filter_spec</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">segmentation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">color_number</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">biomask</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>                     <span class="n">backmask</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bio_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bio_label2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>                     <span class="n">rolling_window_segmentation</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lighter_background</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allowed_window</span><span class="p">:</span> <span class="n">Tuple</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>                     <span class="n">filter_spec</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><span class="sd">        Implement segmentation on the image using various methods and parameters.</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="sd">            logical (str): Logical operation to perform between two binary images.</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="sd">                           Options are &#39;Or&#39;, &#39;And&#39;, &#39;Xor&#39;. Default is &#39;None&#39;.</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a><span class="sd">            color_number (int): Number of colors to use in segmentation. Must be greater than 2</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="sd">                                for kmeans clustering. Default is 2.</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="sd">            biomask (NDArray[np.uint8]): Binary mask for biological areas. Default is None.</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a><span class="sd">            backmask (NDArray[np.uint8]): Binary mask for background areas. Default is None.</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a><span class="sd">            bio_label (Any): Label for biological features. Default is None.</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="sd">            bio_label2 (Any): Secondary label for biological features. Default is None.</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a><span class="sd">            rolling_window_segmentation (dict): Whether to perform grid segmentation. Default is None.</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a><span class="sd">            lighter_background (bool): Indicates if the background is lighter than objects.</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="sd">                                       Default is None.</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="sd">            allowed_window (Tuple): Mask to apply during segmentation. Default is None.</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><span class="sd">            filter_spec (dict): Dictionary of filters to apply on the image before segmentation.</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="c1"># 1. Check valid pixels for segmentation (e.g. when there is a drift correction)</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>        <span class="k">if</span> <span class="n">allowed_window</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>            <span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>            <span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">=</span> <span class="n">allowed_window</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>        <span class="n">greyscale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">[</span><span class="n">min_y</span><span class="p">:</span><span class="n">max_y</span><span class="p">,</span> <span class="n">min_x</span><span class="p">:</span><span class="n">max_x</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>        <span class="c1"># 2. Apply filter on the greyscale images</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>        <span class="k">if</span> <span class="n">filter_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">filter_spec</span><span class="p">[</span><span class="s2">&quot;filter1_type&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>            <span class="n">greyscale</span> <span class="o">=</span> <span class="n">apply_filter</span><span class="p">(</span><span class="n">greyscale</span><span class="p">,</span> <span class="n">filter_spec</span><span class="p">[</span><span class="s2">&quot;filter1_type&quot;</span><span class="p">],</span> <span class="n">filter_spec</span><span class="p">[</span><span class="s2">&quot;filter1_param&quot;</span><span class="p">])</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>        <span class="n">greyscale2</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>        <span class="k">if</span> <span class="n">logical</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>            <span class="n">greyscale2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image2</span><span class="p">[</span><span class="n">min_y</span><span class="p">:</span><span class="n">max_y</span><span class="p">,</span> <span class="n">min_x</span><span class="p">:</span><span class="n">max_x</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>            <span class="k">if</span> <span class="n">filter_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">filter_spec</span><span class="p">[</span><span class="s2">&quot;filter2_type&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>                <span class="n">greyscale2</span> <span class="o">=</span> <span class="n">apply_filter</span><span class="p">(</span><span class="n">greyscale2</span><span class="p">,</span> <span class="n">filter_spec</span><span class="p">[</span><span class="s2">&quot;filter2_type&quot;</span><span class="p">],</span> <span class="n">filter_spec</span><span class="p">[</span><span class="s2">&quot;filter2_param&quot;</span><span class="p">])</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>        <span class="c1"># 3. Do one of the three segmentation algorithms: kmeans, otsu, windowed</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>        <span class="k">if</span> <span class="n">color_number</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>            <span class="n">binary_image</span><span class="p">,</span> <span class="n">binary_image2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bio_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bio_label2</span>  <span class="o">=</span> <span class="n">kmeans</span><span class="p">(</span><span class="n">greyscale</span><span class="p">,</span> <span class="n">greyscale2</span><span class="p">,</span> <span class="n">color_number</span><span class="p">,</span> <span class="n">biomask</span><span class="p">,</span> <span class="n">backmask</span><span class="p">,</span> <span class="n">logical</span><span class="p">,</span> <span class="n">bio_label</span><span class="p">,</span> <span class="n">bio_label2</span><span class="p">)</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>        <span class="k">elif</span> <span class="n">rolling_window_segmentation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rolling_window_segmentation</span><span class="p">[</span><span class="s1">&#39;do&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>            <span class="n">binary_image</span> <span class="o">=</span> <span class="n">windowed_thresholding</span><span class="p">(</span><span class="n">greyscale</span><span class="p">,</span> <span class="n">lighter_background</span><span class="p">,</span> <span class="n">rolling_window_segmentation</span><span class="p">[</span><span class="s1">&#39;side_len&#39;</span><span class="p">],</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>            <span class="n">rolling_window_segmentation</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">],</span> <span class="n">rolling_window_segmentation</span><span class="p">[</span><span class="s1">&#39;min_int_var&#39;</span><span class="p">])</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>            <span class="n">binary_image</span> <span class="o">=</span> <span class="n">otsu_thresholding</span><span class="p">(</span><span class="n">greyscale</span><span class="p">)</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="k">if</span> <span class="n">logical</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span> <span class="ow">and</span> <span class="n">color_number</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>            <span class="k">if</span> <span class="n">rolling_window_segmentation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rolling_window_segmentation</span><span class="p">[</span><span class="s1">&#39;do&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>                <span class="n">binary_image2</span> <span class="o">=</span> <span class="n">windowed_thresholding</span><span class="p">(</span><span class="n">greyscale2</span><span class="p">,</span> <span class="n">lighter_background</span><span class="p">,</span> <span class="n">rolling_window_segmentation</span><span class="p">[</span><span class="s1">&#39;side_len&#39;</span><span class="p">],</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>                <span class="n">rolling_window_segmentation</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">],</span> <span class="n">rolling_window_segmentation</span><span class="p">[</span><span class="s1">&#39;min_int_var&#39;</span><span class="p">])</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>                <span class="n">binary_image2</span> <span class="o">=</span> <span class="n">otsu_thresholding</span><span class="p">(</span><span class="n">greyscale2</span><span class="p">)</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>        <span class="c1"># 4. Use previous_binary_image to make sure that the specimens are labelled with ones and the background zeros</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous_binary_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>            <span class="n">previous_binary_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous_binary_image</span><span class="p">[</span><span class="n">min_y</span><span class="p">:</span><span class="n">max_y</span><span class="p">,</span> <span class="n">min_x</span><span class="p">:</span><span class="n">max_x</span><span class="p">]</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">binary_image</span> <span class="o">*</span> <span class="n">previous_binary_image</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="p">(</span><span class="n">binary_image</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="n">binary_image</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="n">binary_image</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="n">binary_image</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">all</span><span class="p">()):</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>                <span class="c1"># if (binary_image * (1 - previous_binary_image)).sum() &gt; (binary_image * previous_binary_image).sum() + perimeter(binary_image):</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>                <span class="c1"># Ones of the binary image have more in common with the background than with the specimen</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>                <span class="n">binary_image</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">binary_image</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>            <span class="k">if</span> <span class="n">logical</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>                <span class="k">if</span> <span class="p">(</span><span class="n">binary_image2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">previous_binary_image</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">binary_image2</span> <span class="o">*</span> <span class="n">previous_binary_image</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">():</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>                    <span class="n">binary_image2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">binary_image2</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>        <span class="c1"># 5. Give back the image their original size and combine binary images (optional)</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">[</span><span class="n">min_y</span><span class="p">:</span><span class="n">max_y</span><span class="p">,</span> <span class="n">min_x</span><span class="p">:</span><span class="n">max_x</span><span class="p">]</span> <span class="o">=</span> <span class="n">binary_image</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">greyscale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">greyscale</span><span class="p">[</span><span class="n">min_y</span><span class="p">:</span><span class="n">max_y</span><span class="p">,</span> <span class="n">min_x</span><span class="p">:</span><span class="n">max_x</span><span class="p">]</span> <span class="o">=</span> <span class="n">greyscale</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>        <span class="k">if</span> <span class="n">logical</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span><span class="p">[</span><span class="n">min_y</span><span class="p">:</span><span class="n">max_y</span><span class="p">,</span> <span class="n">min_x</span><span class="p">:</span><span class="n">max_x</span><span class="p">]</span> <span class="o">=</span> <span class="n">binary_image2</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">greyscale2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">greyscale2</span><span class="p">[</span><span class="n">min_y</span><span class="p">:</span><span class="n">max_y</span><span class="p">,</span> <span class="n">min_x</span><span class="p">:</span><span class="n">max_x</span><span class="p">]</span> <span class="o">=</span> <span class="n">greyscale2</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>        <span class="k">if</span> <span class="n">logical</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>            <span class="k">if</span> <span class="n">logical</span> <span class="o">==</span> <span class="s1">&#39;Or&#39;</span><span class="p">:</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span><span class="p">)</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>            <span class="k">elif</span> <span class="n">logical</span> <span class="o">==</span> <span class="s1">&#39;And&#39;</span><span class="p">:</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span><span class="p">)</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>            <span class="k">elif</span> <span class="n">logical</span> <span class="o">==</span> <span class="s1">&#39;Xor&#39;</span><span class="p">:</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_xor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span><span class="p">)</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_all_color_spaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate and store all supported color spaces for the image.&quot;&quot;&quot;</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_c_spaces</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">already_greyscale</span><span class="p">:</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">all_c_spaces</span> <span class="o">=</span> <span class="n">get_color_spaces</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bgr</span><span class="p">)</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_subtract_background</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c_space_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">drift_corrected</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a><span class="sd">        Generate a background-subtracted image using specified color space dictionary.</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a><span class="sd">        This method first checks if color spaces have already been generated or</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a><span class="sd">        if the image is greyscale. If not, it generates color spaces from the BGR</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a><span class="sd">        image. It then converts and segments the image using the provided color space</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a><span class="sd">        dictionary without grid segmentation. A disk-shaped structuring element is</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a><span class="sd">        created and used to perform a morphological opening operation on the image,</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a><span class="sd">        resulting in a background-subtracted version. If there is a second image</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a><span class="sd">        (see Also: image2), the same operation is performed on it.</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a><span class="sd">            c_space_dict (dict): Dictionary containing color space specifications</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a><span class="sd">                for the segmentation process.</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a><span class="sd">        Attributes:</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a><span class="sd">            disk_size: Radius of the disk-shaped structuring element</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a><span class="sd">                used for morphological operations, calculated based on image dimensions.</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a><span class="sd">            subtract_background: Background-subtracted version of `image` obtained</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a><span class="sd">                after morphological operations with the disk-shaped structuring element.</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a><span class="sd">            subtract_background2: Background-subtracted version of `image2` obtained</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a><span class="sd">                after morphological operations with the disk-shaped structuring element,</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a><span class="sd">                if `image2` is present.&quot;&quot;&quot;</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generate background using the generate_subtract_background method of OneImageAnalysis class&quot;</span><span class="p">)</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_color_spaces</span><span class="p">()</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>        <span class="k">if</span> <span class="n">drift_corrected</span><span class="p">:</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>            <span class="c1"># self.adjust_to_drift_correction(c_space_dict[&#39;logical&#39;])</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">check_if_image_border_attest_drift_correction</span><span class="p">()</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">convert_and_segment</span><span class="p">(</span><span class="n">c_space_dict</span><span class="p">,</span> <span class="n">rolling_window_segmentation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allowed_window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">drift_mask_coord</span><span class="p">)</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>        <span class="n">disk_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bgr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))))</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>        <span class="n">disk</span> <span class="o">=</span> <span class="n">create_ellipse</span><span class="p">(</span><span class="n">disk_size</span><span class="p">,</span> <span class="n">disk_size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subtract_background</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">morphologyEx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_OPEN</span><span class="p">,</span> <span class="n">disk</span><span class="p">)</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">subtract_background2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">morphologyEx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image2</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_OPEN</span><span class="p">,</span> <span class="n">disk</span><span class="p">)</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_if_image_border_attest_drift_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a><span class="sd">        Check if the given binary image requires border attenuation and drift correction.</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a><span class="sd">        In order to determine the need for border attenuation or drift correction, this function</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a><span class="sd">        evaluates the borders of a binary image. If any two opposite borders are fully black,</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a><span class="sd">        it assumes that there is an issue requiring correction.</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a><span class="sd">            bool: True if border attenuation or drift correction is required, False otherwise.</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>        <span class="n">l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">drift_mask_coord</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="ow">and</span> <span class="n">b</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">t</span> <span class="ow">and</span> <span class="n">r</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">t</span> <span class="ow">and</span> <span class="n">l</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">t</span> <span class="ow">and</span> <span class="n">r</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">b</span> <span class="ow">and</span> <span class="n">l</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">b</span> <span class="ow">and</span> <span class="n">r</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">l</span> <span class="ow">and</span> <span class="n">r</span><span class="p">):</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>            <span class="n">cc_nb</span><span class="p">,</span> <span class="n">shapes</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">connectedComponents</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>            <span class="k">if</span> <span class="n">cc_nb</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>                <span class="k">if</span> <span class="n">cc_nb</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>                    <span class="n">drift_mask_coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>                    <span class="n">back</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">shapes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>  <span class="n">shapes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">shapes</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>                    <span class="n">drift_mask_coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">shapes</span><span class="p">,</span> <span class="n">back</span><span class="p">[</span><span class="n">back</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])))</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>                <span class="n">drift_mask_coord</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">drift_mask_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">drift_mask_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>                                    <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">drift_mask_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">drift_mask_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">drift_mask_coord</span> <span class="o">=</span> <span class="n">drift_mask_coord</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>                <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>                <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">adjust_to_drift_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a><span class="sd">        Adjust the image and binary image to correct for drift.</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a><span class="sd">        This method applies a drift correction by dilating the binary image, calculating</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a><span class="sd">        the mean value of the drifted region and applying it back to the image. After this,</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a><span class="sd">        it applies Otsu&#39;s thresholding method to determine a new binary image and adjusts</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a><span class="sd">        the second image if present. The logical operation specified is then applied to the</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a><span class="sd">        binary images.</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a><span class="sd">            logical (str): Logical operation (&#39;Or&#39;, &#39;And&#39;, &#39;Xor&#39;) to apply to the binary</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a><span class="sd">                images.&quot;&quot;&quot;</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_correction_already_adjusted</span><span class="p">:</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">drift_correction_already_adjusted</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">dilate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="n">cross_33</span><span class="p">)</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>            <span class="n">mask</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>            <span class="n">drift_correction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">[</span><span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)]</span> <span class="o">=</span> <span class="n">drift_correction</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>            <span class="n">threshold</span> <span class="o">=</span> <span class="n">get_otsu_threshold</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>            <span class="n">binary</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>                <span class="n">drift_correction2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image2</span><span class="p">[</span><span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">image2</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)]</span> <span class="o">=</span> <span class="n">drift_correction2</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>                <span class="n">threshold</span> <span class="o">=</span> <span class="n">get_otsu_threshold</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image2</span><span class="p">)</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>                <span class="n">binary1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image2</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>                <span class="n">binary2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">binary1</span><span class="p">)</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>                <span class="k">if</span> <span class="n">binary1</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">binary2</span><span class="o">.</span><span class="n">sum</span><span class="p">():</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>                    <span class="n">binary</span> <span class="o">=</span> <span class="n">binary1</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>                    <span class="n">binary</span> <span class="o">=</span> <span class="n">binary2</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>                <span class="k">while</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">binary</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span><span class="p">)</span> <span class="ow">and</span> <span class="n">threshold</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>                    <span class="n">threshold</span> <span class="o">-=</span> <span class="mi">1</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>                    <span class="n">binary1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image2</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>                    <span class="n">binary2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">binary1</span><span class="p">)</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>                    <span class="k">if</span> <span class="n">binary1</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">binary2</span><span class="o">.</span><span class="n">sum</span><span class="p">():</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>                        <span class="n">binary</span> <span class="o">=</span> <span class="n">binary1</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>                        <span class="n">binary</span> <span class="o">=</span> <span class="n">binary2</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>                <span class="k">if</span> <span class="n">logical</span> <span class="o">==</span> <span class="s1">&#39;Or&#39;</span><span class="p">:</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span><span class="p">)</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>                <span class="k">elif</span> <span class="n">logical</span> <span class="o">==</span> <span class="s1">&#39;And&#39;</span><span class="p">:</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span><span class="p">)</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>                <span class="k">elif</span> <span class="n">logical</span> <span class="o">==</span> <span class="s1">&#39;Xor&#39;</span><span class="p">:</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_xor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span><span class="p">)</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">find_first_im_csc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_number</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">several_blob_per_arena</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="n">spot_shape</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>                          <span class="n">spot_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kmeans_clust_nb</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">biomask</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>                          <span class="n">backmask</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color_space_dictionaries</span><span class="p">:</span> <span class="n">TList</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">basic</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a><span class="sd">        Prepare color space lists, dictionaries and matrices.</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a><span class="sd">            sample_number: An integer representing the sample number. Defaults to None.</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a><span class="sd">            several_blob_per_arena: A boolean indicating whether there are several blobs per arena. Defaults to True.</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a><span class="sd">            spot_shape: A string representing the shape of the spot. Defaults to None.</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a><span class="sd">            spot_size: An integer representing the size of the spot. Defaults to None.</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a><span class="sd">            kmeans_clust_nb: An integer representing the number of clusters for K-means. Defaults to None.</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a><span class="sd">            biomask: A 2D numpy array of type np.uint8 representing the bio mask. Defaults to None.</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a><span class="sd">            backmask: A 2D numpy array of type np.uint8 representing the background mask. Defaults to None.</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a><span class="sd">            color_space_dictionaries: A list of dictionaries containing color space information. Defaults to None.</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a><span class="sd">            basic: A boolean indicating whether to process the data basic. Defaults to True.</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a><span class="sd">        Note:</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a><span class="sd">            This method processes the input data to find the first image that matches certain criteria, using various color spaces and masks.</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Start automatic detection of the first image&quot;</span><span class="p">)</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span> <span class="o">=</span> <span class="n">TList</span><span class="p">()</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span> <span class="o">=</span> <span class="n">TList</span><span class="p">()</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_color_spaces</span><span class="p">()</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>            <span class="k">if</span> <span class="n">color_space_dictionaries</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>                <span class="k">if</span> <span class="n">basic</span><span class="p">:</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>                    <span class="n">colorspace_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;bgr&quot;</span><span class="p">,</span> <span class="s2">&quot;lab&quot;</span><span class="p">,</span> <span class="s2">&quot;hsv&quot;</span><span class="p">,</span> <span class="s2">&quot;luv&quot;</span><span class="p">,</span> <span class="s2">&quot;hls&quot;</span><span class="p">,</span> <span class="s2">&quot;yuv&quot;</span><span class="p">]</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>                    <span class="n">colorspace_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;bgr&quot;</span><span class="p">]</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>                <span class="n">color_space_dictionaries</span> <span class="o">=</span> <span class="n">TList</span><span class="p">()</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c_space</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">colorspace_list</span><span class="p">):</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>                        <span class="n">channels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>                        <span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>                        <span class="n">csc_dict</span> <span class="o">=</span> <span class="n">TDict</span><span class="p">()</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>                        <span class="n">csc_dict</span><span class="p">[</span><span class="n">c_space</span><span class="p">]</span> <span class="o">=</span> <span class="n">channels</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>                        <span class="n">color_space_dictionaries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">csc_dict</span><span class="p">)</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">color_space_dictionaries</span><span class="p">)</span> <span class="o">+</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>            <span class="n">unaltered_cc_nb</span><span class="p">,</span> <span class="n">cc_nb</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="n">width_std</span><span class="p">,</span> <span class="n">height_std</span><span class="p">,</span> <span class="n">area_std</span><span class="p">,</span> <span class="n">biosum</span><span class="p">,</span> <span class="n">backsum</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">save_combination_thread</span> <span class="o">=</span> <span class="n">SaveCombinationThread</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>            <span class="n">get_one_channel_result</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>            <span class="n">combine_channels</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Try detection with each available color space channel, one by one.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>            <span class="k">for</span> <span class="n">csc_dict</span> <span class="ow">in</span> <span class="n">color_space_dictionaries</span><span class="p">:</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>                <span class="n">list_args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_one_channel_result</span><span class="p">,</span> <span class="n">combine_channels</span><span class="p">,</span> <span class="n">csc_dict</span><span class="p">,</span> <span class="n">several_blob_per_arena</span><span class="p">,</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>                             <span class="n">sample_number</span><span class="p">,</span> <span class="n">spot_size</span><span class="p">,</span> <span class="n">spot_shape</span><span class="p">,</span> <span class="n">kmeans_clust_nb</span><span class="p">,</span> <span class="n">biomask</span><span class="p">,</span> <span class="n">backmask</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>                <span class="n">ProcessFirstImage</span><span class="p">(</span><span class="n">list_args</span><span class="p">)</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>            <span class="k">if</span> <span class="n">sample_number</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">basic</span><span class="p">:</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>                <span class="c1"># Try to add csc together</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>                <span class="n">possibilities</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>                    <span class="n">different_color_spaces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="p">)</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>                    <span class="k">for</span> <span class="n">color_space</span> <span class="ow">in</span> <span class="n">different_color_spaces</span><span class="p">:</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>                        <span class="n">csc_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="p">,</span> <span class="n">color_space</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>                        <span class="n">possibilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">csc_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="n">csc_idx</span><span class="p">,</span> <span class="n">area_std</span><span class="p">]))</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">possibilities</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">:</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>                        <span class="n">remaining_possibilities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="p">))</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>                        <span class="n">remaining_possibilities</span> <span class="o">=</span> <span class="n">remaining_possibilities</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">remaining_possibilities</span><span class="p">,</span> <span class="n">possibilities</span><span class="p">))]</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>                        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">possibilities</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">:</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>                            <span class="n">new_possibility</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="n">remaining_possibilities</span><span class="p">,</span> <span class="n">area_std</span><span class="p">])</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>                            <span class="n">possibilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_possibility</span><span class="p">)</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>                            <span class="n">remaining_possibilities</span> <span class="o">=</span> <span class="n">remaining_possibilities</span><span class="p">[</span><span class="n">remaining_possibilities</span> <span class="o">!=</span> <span class="n">new_possibility</span><span class="p">]</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>                <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">ThreadPool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>                <span class="n">get_one_channel_result</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>                <span class="n">combine_channels</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>                <span class="n">list_args</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_one_channel_result</span><span class="p">,</span> <span class="n">combine_channels</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">several_blob_per_arena</span><span class="p">,</span> <span class="n">sample_number</span><span class="p">,</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>                              <span class="n">spot_size</span><span class="p">,</span> <span class="n">spot_shape</span><span class="p">,</span> <span class="n">kmeans_clust_nb</span><span class="p">,</span> <span class="n">biomask</span><span class="p">,</span> <span class="n">backmask</span><span class="p">,</span> <span class="n">possibilities</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">possibilities</span><span class="p">]</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>                <span class="k">for</span> <span class="n">process_i</span> <span class="ow">in</span> <span class="n">pool</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span><span class="n">ProcessFirstImage</span><span class="p">,</span> <span class="n">list_args</span><span class="p">):</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>                    <span class="k">pass</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>            <span class="c1"># Get the most and the least covered images and the 2 best biomask and backmask scores</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>            <span class="c1"># To try combinations of those</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>                <span class="n">csc_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bgr&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))}</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>                <span class="n">list_args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">csc_dict</span><span class="p">,</span> <span class="n">several_blob_per_arena</span><span class="p">,</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>                             <span class="n">sample_number</span><span class="p">,</span> <span class="n">spot_size</span><span class="p">,</span> <span class="n">spot_shape</span><span class="p">,</span> <span class="n">kmeans_clust_nb</span><span class="p">,</span> <span class="n">biomask</span><span class="p">,</span> <span class="n">backmask</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>                <span class="n">process_i</span> <span class="o">=</span> <span class="n">ProcessFirstImage</span><span class="p">(</span><span class="n">list_args</span><span class="p">)</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>                <span class="n">process_i</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bgr</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>                <span class="n">process_i</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">otsu_thresholding</span><span class="p">(</span><span class="n">process_i</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>                <span class="n">process_i</span><span class="o">.</span><span class="n">csc_dict</span> <span class="o">=</span> <span class="n">csc_dict</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>                <span class="n">process_i</span><span class="o">.</span><span class="n">total_area</span> <span class="o">=</span> <span class="n">process_i</span><span class="o">.</span><span class="n">binary_image</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>                <span class="n">process_i</span><span class="o">.</span><span class="n">process_binary_image</span><span class="p">()</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>                <span class="n">process_i</span><span class="o">.</span><span class="n">unaltered_concomp_nb</span><span class="p">,</span> <span class="n">shapes</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">connectedComponents</span><span class="p">(</span><span class="n">process_i</span><span class="o">.</span><span class="n">validated_shapes</span><span class="p">)</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">save_combination_features</span><span class="p">(</span><span class="n">process_i</span><span class="p">)</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="p">:]</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>                <span class="n">fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">])</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>                <span class="n">coverage</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">area</span><span class="p">])</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>                <span class="n">most1</span> <span class="o">=</span> <span class="n">coverage</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span> <span class="n">most2</span> <span class="o">=</span> <span class="n">coverage</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>                <span class="n">least1</span> <span class="o">=</span> <span class="n">coverage</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">least2</span> <span class="o">=</span> <span class="n">coverage</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>                <span class="k">if</span> <span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>                    <span class="n">bio_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">biosum</span><span class="p">])</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>                    <span class="n">bio1</span> <span class="o">=</span> <span class="n">bio_sort</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span> <span class="n">bio2</span> <span class="o">=</span> <span class="n">bio_sort</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>                <span class="k">if</span> <span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>                    <span class="n">back_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">backsum</span><span class="p">])</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>                    <span class="n">back1</span> <span class="o">=</span> <span class="n">back_sort</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span> <span class="n">back2</span> <span class="o">=</span> <span class="n">back_sort</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>                <span class="c1"># Try a logical And between the most covered images</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>                <span class="c1"># Should only need one instanciation</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>                <span class="n">process_i</span> <span class="o">=</span> <span class="n">ProcessFirstImage</span><span class="p">(</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>                    <span class="p">[</span><span class="bp">self</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">several_blob_per_arena</span><span class="p">,</span> <span class="n">sample_number</span><span class="p">,</span> <span class="n">spot_size</span><span class="p">,</span> <span class="n">spot_shape</span><span class="p">,</span> <span class="n">kmeans_clust_nb</span><span class="p">,</span> <span class="n">biomask</span><span class="p">,</span> <span class="n">backmask</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>                <span class="n">process_i</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="p">[</span><span class="n">most1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="p">[</span><span class="n">most2</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>                <span class="n">process_i</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span><span class="p">[</span><span class="n">most1</span><span class="p">]</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>                <span class="n">process_i</span><span class="o">.</span><span class="n">process_binary_image</span><span class="p">()</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>                <span class="n">process_i</span><span class="o">.</span><span class="n">csc_dict</span> <span class="o">=</span> <span class="p">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="p">[</span><span class="n">most1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="n">most1</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">],</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>                            <span class="s2">&quot;logical&quot;</span><span class="p">:</span> <span class="s2">&quot;And&quot;</span><span class="p">,</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>                            <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="p">[</span><span class="n">most2</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="n">most2</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]}</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>                <span class="n">process_i</span><span class="o">.</span><span class="n">unaltered_concomp_nb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[(</span><span class="n">most1</span><span class="p">,</span> <span class="n">most2</span><span class="p">),</span> <span class="n">unaltered_cc_nb</span><span class="p">])</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>                <span class="n">process_i</span><span class="o">.</span><span class="n">total_area</span> <span class="o">=</span> <span class="n">process_i</span><span class="o">.</span><span class="n">binary_image</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">save_combination_features</span><span class="p">(</span><span class="n">process_i</span><span class="p">)</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>                <span class="n">process_i</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span><span class="p">[</span><span class="n">least1</span><span class="p">]</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>                <span class="n">process_i</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="p">[</span><span class="n">least1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="p">[</span><span class="n">least2</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>                <span class="n">process_i</span><span class="o">.</span><span class="n">process_binary_image</span><span class="p">()</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>                <span class="n">process_i</span><span class="o">.</span><span class="n">csc_dict</span> <span class="o">=</span> <span class="p">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="p">[</span><span class="n">least1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="n">least1</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">],</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>                            <span class="s2">&quot;logical&quot;</span><span class="p">:</span> <span class="s2">&quot;Or&quot;</span><span class="p">,</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>                            <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="p">[</span><span class="n">least2</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="n">least2</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]}</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>                <span class="n">process_i</span><span class="o">.</span><span class="n">unaltered_concomp_nb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[(</span><span class="n">least1</span><span class="p">,</span> <span class="n">least2</span><span class="p">),</span> <span class="n">unaltered_cc_nb</span><span class="p">])</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>                <span class="n">process_i</span><span class="o">.</span><span class="n">total_area</span> <span class="o">=</span> <span class="n">process_i</span><span class="o">.</span><span class="n">binary_image</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">save_combination_features</span><span class="p">(</span><span class="n">process_i</span><span class="p">)</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>                <span class="c1"># self.save_combination_features(csc_dict, unaltered_concomp_nb, self.binary_image.sum(), biomask, backmask)</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>                <span class="c1"># If most images are very low in biosum or backsum, try to mix them together to improve that score</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>                <span class="c1"># Do a logical And between the two best biomasks</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>                <span class="k">if</span> <span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">((</span><span class="n">bio1</span><span class="p">,</span> <span class="n">bio2</span><span class="p">),</span> <span class="p">(</span><span class="n">most1</span><span class="p">,</span> <span class="n">most2</span><span class="p">))):</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>                        <span class="n">process_i</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span><span class="p">[</span><span class="n">bio1</span><span class="p">]</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>                        <span class="n">process_i</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="p">[</span><span class="n">bio1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="p">[</span><span class="n">bio2</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>                        <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>                        <span class="n">process_i</span><span class="o">.</span><span class="n">process_binary_image</span><span class="p">()</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>                        <span class="n">process_i</span><span class="o">.</span><span class="n">csc_dict</span> <span class="o">=</span> <span class="p">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="p">[</span><span class="n">bio1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="n">bio1</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">],</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>                                    <span class="s2">&quot;logical&quot;</span><span class="p">:</span> <span class="s2">&quot;And&quot;</span><span class="p">,</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>                                    <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="p">[</span><span class="n">bio2</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="n">bio2</span><span class="p">,:</span><span class="mi">3</span><span class="p">]}</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>                        <span class="n">process_i</span><span class="o">.</span><span class="n">unaltered_concomp_nb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[(</span><span class="n">bio1</span><span class="p">,</span> <span class="n">bio2</span><span class="p">),</span> <span class="n">unaltered_cc_nb</span><span class="p">])</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>                        <span class="n">process_i</span><span class="o">.</span><span class="n">total_area</span> <span class="o">=</span> <span class="n">process_i</span><span class="o">.</span><span class="n">binary_image</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">save_combination_features</span><span class="p">(</span><span class="n">process_i</span><span class="p">)</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>                <span class="c1"># Do a logical And between the two best backmask</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>                <span class="k">if</span> <span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">((</span><span class="n">back1</span><span class="p">,</span> <span class="n">back2</span><span class="p">),</span> <span class="p">(</span><span class="n">most1</span><span class="p">,</span> <span class="n">most2</span><span class="p">))):</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>                        <span class="n">process_i</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span><span class="p">[</span><span class="n">back1</span><span class="p">]</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>                        <span class="n">process_i</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="p">[</span><span class="n">back1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="p">[</span><span class="n">back2</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>                        <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>                        <span class="n">process_i</span><span class="o">.</span><span class="n">process_binary_image</span><span class="p">()</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>                        <span class="n">process_i</span><span class="o">.</span><span class="n">csc_dict</span> <span class="o">=</span> <span class="p">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="p">[</span><span class="n">back1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="n">back1</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">],</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>                                    <span class="s2">&quot;logical&quot;</span><span class="p">:</span> <span class="s2">&quot;And&quot;</span><span class="p">,</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>                                    <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="p">[</span><span class="n">back2</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="n">back2</span><span class="p">,:</span><span class="mi">3</span><span class="p">]}</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>                        <span class="n">process_i</span><span class="o">.</span><span class="n">unaltered_concomp_nb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[(</span><span class="n">back1</span><span class="p">,</span> <span class="n">back2</span><span class="p">),</span> <span class="n">unaltered_cc_nb</span><span class="p">])</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>                        <span class="n">process_i</span><span class="o">.</span><span class="n">total_area</span> <span class="o">=</span> <span class="n">process_i</span><span class="o">.</span><span class="n">binary_image</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">save_combination_features</span><span class="p">(</span><span class="n">process_i</span><span class="p">)</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>                <span class="c1"># Do a logical Or between the best biomask and the best backmask</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>                <span class="k">if</span> <span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">((</span><span class="n">bio1</span><span class="p">,</span> <span class="n">back1</span><span class="p">),</span> <span class="p">(</span><span class="n">least1</span><span class="p">,</span> <span class="n">least2</span><span class="p">))):</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>                        <span class="n">process_i</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span><span class="p">[</span><span class="n">bio1</span><span class="p">]</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>                        <span class="n">process_i</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="p">[</span><span class="n">bio1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="p">[</span><span class="n">back1</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>                            <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>                        <span class="n">process_i</span><span class="o">.</span><span class="n">process_binary_image</span><span class="p">()</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>                        <span class="n">process_i</span><span class="o">.</span><span class="n">csc_dict</span> <span class="o">=</span> <span class="p">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="p">[</span><span class="n">bio1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="n">bio1</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">],</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>                                    <span class="s2">&quot;logical&quot;</span><span class="p">:</span> <span class="s2">&quot;Or&quot;</span><span class="p">,</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>                                    <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="p">[</span><span class="n">back1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="n">back1</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]}</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>                        <span class="n">process_i</span><span class="o">.</span><span class="n">unaltered_concomp_nb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[(</span><span class="n">bio1</span><span class="p">,</span> <span class="n">back1</span><span class="p">),</span> <span class="n">unaltered_cc_nb</span><span class="p">])</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>                        <span class="c1"># self.save_combination_features(csc_dict, unaltered_concomp_nb, self.binary_image.sum(), biomask,</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>                        <span class="c1">#                                backmask)</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>                        <span class="n">process_i</span><span class="o">.</span><span class="n">total_area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">save_combination_features</span><span class="p">(</span><span class="n">process_i</span><span class="p">)</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_combination_thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">save_combination_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="p">:]</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>                <span class="c1"># Only keep the row that filled conditions</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>                <span class="c1"># Save all combinations if they fulfill the following conditions:</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>                <span class="c1">#   - Their conncomp number is lower than 3 times the smaller conncomp number.</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>                <span class="c1">#   - OR The minimal area variations</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>                <span class="c1">#   - OR The minimal width variations</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>                <span class="c1">#   - OR The minimal height variations</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>                <span class="c1">#   - AND/OR their segmentation fits with biomask and backmask</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>                <span class="n">width_std_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:,</span> <span class="n">width_std</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:,</span> <span class="n">width_std</span><span class="p">])</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>                <span class="n">height_std_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:,</span> <span class="n">height_std</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:,</span> <span class="n">height_std</span><span class="p">])</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>                <span class="n">area_std_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:,</span> <span class="n">area_std</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:,</span> <span class="n">area_std</span><span class="p">])</span> <span class="o">*</span> <span class="mi">10</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>                <span class="n">fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">width_std_fit</span><span class="p">,</span> <span class="n">height_std_fit</span><span class="p">),</span> <span class="n">area_std_fit</span><span class="p">)</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a>                <span class="n">biomask_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a>                <span class="n">backmask_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>                <span class="k">if</span> <span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a>                    <span class="k">if</span> <span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a>                        <span class="n">biomask_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:,</span> <span class="n">biosum</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">biomask</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a>                    <span class="k">if</span> <span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a>                        <span class="n">backmask_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:,</span> <span class="n">backsum</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">backmask</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a>                    <span class="c1"># First test a logical OR between the precedent options and the mask fits.</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a>                    <span class="n">fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">biomask_fit</span><span class="p">,</span> <span class="n">backmask_fit</span><span class="p">))</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>                    <span class="c1"># If this is not stringent enough, use a logical AND and increase progressively the proportion of pixels that</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a>                    <span class="c1"># must match the biomask and the backmask</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>                        <span class="n">to_add</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>                        <span class="k">while</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="ow">and</span> <span class="n">to_add</span> <span class="o">&lt;=</span> <span class="mf">0.25</span><span class="p">:</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>                            <span class="k">if</span> <span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a>                                <span class="n">biomask_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:,</span> <span class="n">biosum</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mf">0.75</span> <span class="o">+</span> <span class="n">to_add</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">biomask</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a>                            <span class="k">if</span> <span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a>                                <span class="n">backmask_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:,</span> <span class="n">backsum</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mf">0.75</span> <span class="o">+</span> <span class="n">to_add</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">backmask</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a>                            <span class="n">test_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">biomask_fit</span><span class="p">,</span> <span class="n">backmask_fit</span><span class="p">))</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a>                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">test_fit</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a>                                <span class="n">fit</span> <span class="o">=</span> <span class="n">test_fit</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>                            <span class="n">to_add</span> <span class="o">+=</span> <span class="mf">0.05</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a>            <span class="c1"># If saved_csc_nb is too low, try bool operators to mix them together to fill holes for instance</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a>            <span class="c1"># Order the table according to the number of shapes that have been removed by filters</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a>            <span class="c1"># cc_efficiency_order = np.argsort(self.combination_features[:, unaltered_cc_nb] - self.combination_features[:, cc_nb])</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a>            <span class="n">cc_efficiency_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:,</span> <span class="n">area_std</span><span class="p">])</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a>            <span class="c1"># Save and return a dictionnary containing the selected color space combinations</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>            <span class="c1"># and their corresponding binary images</span>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a>            <span class="k">for</span> <span class="n">saved_csc</span> <span class="ow">in</span> <span class="n">cc_efficiency_order</span><span class="p">:</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a>                <span class="k">if</span> <span class="n">fit</span><span class="p">[</span><span class="n">saved_csc</span><span class="p">]:</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a>                    <span class="c1"># self.im_combinations.append({})</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>                    <span class="c1"># self.im_combinations[len(self.im_combinations) - 1][&quot;csc&quot;] = self.saved_color_space_list[saved_csc]</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;csc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;csc&quot;</span><span class="p">][</span><span class="s1">&#39;logical&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="p">[</span><span class="n">saved_csc</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;csc&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a>                    <span class="k">if</span> <span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>                        <span class="n">shape_number</span><span class="p">,</span> <span class="n">shapes</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">connectedComponents</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="p">[</span><span class="n">saved_csc</span><span class="p">],</span> <span class="n">connectivity</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">shapes</span><span class="p">[</span><span class="n">backmask</span><span class="p">]):</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>                            <span class="n">shapes</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">shapes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">shapes</span><span class="p">[</span><span class="n">backmask</span><span class="p">]))]</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="p">[</span><span class="n">saved_csc</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">shapes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>                    <span class="k">if</span> <span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="p">[</span><span class="n">saved_csc</span><span class="p">][</span><span class="n">biomask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>                    <span class="k">if</span> <span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="n">saved_csc</span><span class="p">,</span> <span class="n">cc_nb</span><span class="p">],</span> <span class="n">shapes</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">connectedComponents</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="p">[</span><span class="n">saved_csc</span><span class="p">],</span> <span class="n">connectivity</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="n">saved_csc</span><span class="p">,</span> <span class="n">cc_nb</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;binary_image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="p">[</span><span class="n">saved_csc</span><span class="p">]</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;shape_number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="n">saved_csc</span><span class="p">,</span> <span class="n">cc_nb</span><span class="p">]</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;converted_image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span><span class="p">[</span><span class="n">saved_csc</span><span class="p">]</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save_combination_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process_i</span><span class="p">:</span> <span class="nb">object</span><span class="p">):</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a><span class="sd">        Saves the combination features of a given processed image.</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a><span class="sd">            process_i (object): The processed image object containing various attributes</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a><span class="sd">                such as validated_shapes, image, csc_dict, unaltered_concomp_nb,</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a><span class="sd">                shape_number, total_area, stats, biomask, and backmask.</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a><span class="sd">            Attributes:</span>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a><span class="sd">                processed image object</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a><span class="sd">                    validated_shapes (array-like): The validated shapes of the processed image.</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a><span class="sd">                    image (array-like): The image data.</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a><span class="sd">                    csc_dict (dict): Color space conversion dictionary</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a>        <span class="k">if</span> <span class="n">process_i</span><span class="o">.</span><span class="n">validated_shapes</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process_i</span><span class="o">.</span><span class="n">validated_shapes</span><span class="p">)</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">process_i</span><span class="o">.</span><span class="n">image</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process_i</span><span class="o">.</span><span class="n">csc_dict</span><span class="p">)</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">process_i</span><span class="o">.</span><span class="n">csc_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">process_i</span><span class="o">.</span><span class="n">unaltered_concomp_nb</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># unaltered_cc_nb</span>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">process_i</span><span class="o">.</span><span class="n">shape_number</span>  <span class="c1"># cc_nb</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">process_i</span><span class="o">.</span><span class="n">total_area</span>  <span class="c1"># area</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">process_i</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">2</span><span class="p">])</span>  <span class="c1"># width_std</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">process_i</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">3</span><span class="p">])</span>  <span class="c1"># height_std</span>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">process_i</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">4</span><span class="p">])</span>  <span class="c1"># area_std</span>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a>            <span class="k">if</span> <span class="n">process_i</span><span class="o">.</span><span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a>                    <span class="n">process_i</span><span class="o">.</span><span class="n">validated_shapes</span><span class="p">[</span><span class="n">process_i</span><span class="o">.</span><span class="n">biomask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">process_i</span><span class="o">.</span><span class="n">biomask</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a>            <span class="k">if</span> <span class="n">process_i</span><span class="o">.</span><span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a>                    <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">process_i</span><span class="o">.</span><span class="n">validated_shapes</span><span class="p">)[</span><span class="n">process_i</span><span class="o">.</span><span class="n">backmask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">process_i</span><span class="o">.</span><span class="n">backmask</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_current_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_combination_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a><span class="sd">        Update the current images based on a given combination ID.</span>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a><span class="sd">        This method updates two attributes of the instance: `image` and</span>
<a id="__codelineno-0-630" name="__codelineno-0-630"></a><span class="sd">        `validated_shapes`. The `image` attribute is set to the value of the key</span>
<a id="__codelineno-0-631" name="__codelineno-0-631"></a><span class="sd">        &quot;converted_image&quot; from a dictionary in `im_combinations` which is</span>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a><span class="sd">        indexed by the provided `current_combination_id`. Similarly, the</span>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a><span class="sd">        `validated_shapes` attribute is set to the value of the key &quot;binary_image&quot;</span>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a><span class="sd">        from the same dictionary.</span>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a><span class="sd">            current_combination_id (int): The ID of the combination whose</span>
<a id="__codelineno-0-638" name="__codelineno-0-638"></a><span class="sd">                images should be set as the current ones.</span>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="n">current_combination_id</span><span class="p">][</span><span class="s2">&quot;converted_image&quot;</span><span class="p">]</span>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validated_shapes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="n">current_combination_id</span><span class="p">][</span><span class="s2">&quot;binary_image&quot;</span><span class="p">]</span>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a>
<a id="__codelineno-0-644" name="__codelineno-0-644"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">find_last_im_csc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concomp_nb</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">total_surfarea</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_shape_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">arenas_mask</span><span class="p">:</span> <span class="n">NDArray</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-645" name="__codelineno-0-645"></a>                         <span class="n">ref_image</span><span class="p">:</span> <span class="n">NDArray</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subtract_background</span><span class="p">:</span> <span class="n">NDArray</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kmeans_clust_nb</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-646" name="__codelineno-0-646"></a>                         <span class="n">biomask</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">backmask</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a>                         <span class="n">color_space_dictionaries</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">basic</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a><span class="sd">        Find the last image color space configurations that meets given criteria.</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a><span class="sd">            concomp_nb (int): A tuple of two integers representing the minimum and maximum number of connected components.</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a><span class="sd">            total_surfarea (int): The total surface area required for the image.</span>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a><span class="sd">            max_shape_size (int): The maximum shape size allowed in the image.</span>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a><span class="sd">            arenas_mask (NDArray, optional): A numpy array representing areas inside the field of interest.</span>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a><span class="sd">            ref_image (NDArray, optional): A reference image for comparison.</span>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a><span class="sd">            subtract_background (NDArray, optional): A numpy array representing the background to be subtracted.</span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a><span class="sd">            kmeans_clust_nb (int, optional): The number of clusters for k-means clustering.</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a><span class="sd">            biomask (NDArray[np.uint8], optional): A binary mask for biological structures.</span>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a><span class="sd">            backmask (NDArray[np.uint8], optional): A binary mask for background areas.</span>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a><span class="sd">            color_space_dictionaries (dict, optional): Dictionaries of color space configurations.</span>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a><span class="sd">            basic (bool, optional): A flag indicating whether to process colorspaces basic.</span>
<a id="__codelineno-0-663" name="__codelineno-0-663"></a>
<a id="__codelineno-0-664" name="__codelineno-0-664"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-665" name="__codelineno-0-665"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Start automatic detection of the last image&quot;</span><span class="p">)</span>
<a id="__codelineno-0-666" name="__codelineno-0-666"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-667" name="__codelineno-0-667"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span> <span class="o">=</span> <span class="n">TList</span><span class="p">()</span>
<a id="__codelineno-0-668" name="__codelineno-0-668"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span> <span class="o">=</span> <span class="n">TList</span><span class="p">()</span>
<a id="__codelineno-0-669" name="__codelineno-0-669"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<a id="__codelineno-0-670" name="__codelineno-0-670"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-671" name="__codelineno-0-671"></a>
<a id="__codelineno-0-672" name="__codelineno-0-672"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<a id="__codelineno-0-673" name="__codelineno-0-673"></a>            <span class="k">if</span> <span class="n">arenas_mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-674" name="__codelineno-0-674"></a>                <span class="n">arenas_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-675" name="__codelineno-0-675"></a>            <span class="n">out_of_arenas</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">arenas_mask</span>
<a id="__codelineno-0-676" name="__codelineno-0-676"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_color_spaces</span><span class="p">()</span>
<a id="__codelineno-0-677" name="__codelineno-0-677"></a>            <span class="k">if</span> <span class="n">color_space_dictionaries</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-678" name="__codelineno-0-678"></a>                <span class="k">if</span> <span class="n">basic</span><span class="p">:</span>
<a id="__codelineno-0-679" name="__codelineno-0-679"></a>                    <span class="n">colorspace_list</span> <span class="o">=</span> <span class="n">TList</span><span class="p">((</span><span class="s2">&quot;bgr&quot;</span><span class="p">,</span> <span class="s2">&quot;lab&quot;</span><span class="p">,</span> <span class="s2">&quot;hsv&quot;</span><span class="p">,</span> <span class="s2">&quot;luv&quot;</span><span class="p">,</span> <span class="s2">&quot;hls&quot;</span><span class="p">,</span> <span class="s2">&quot;yuv&quot;</span><span class="p">))</span>
<a id="__codelineno-0-680" name="__codelineno-0-680"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-681" name="__codelineno-0-681"></a>                    <span class="n">colorspace_list</span> <span class="o">=</span> <span class="n">TList</span><span class="p">((</span><span class="s2">&quot;lab&quot;</span><span class="p">,</span> <span class="s2">&quot;hsv&quot;</span><span class="p">))</span>
<a id="__codelineno-0-682" name="__codelineno-0-682"></a>                <span class="n">color_space_dictionaries</span> <span class="o">=</span> <span class="n">TList</span><span class="p">()</span>
<a id="__codelineno-0-683" name="__codelineno-0-683"></a>                <span class="n">channels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
<a id="__codelineno-0-684" name="__codelineno-0-684"></a>                <span class="n">csc_dict</span> <span class="o">=</span> <span class="n">TDict</span><span class="p">()</span>
<a id="__codelineno-0-685" name="__codelineno-0-685"></a>                <span class="n">csc_dict</span><span class="p">[</span><span class="s2">&quot;bgr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">channels</span>
<a id="__codelineno-0-686" name="__codelineno-0-686"></a>                <span class="n">color_space_dictionaries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">csc_dict</span><span class="p">)</span>
<a id="__codelineno-0-687" name="__codelineno-0-687"></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c_space</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">colorspace_list</span><span class="p">):</span>
<a id="__codelineno-0-688" name="__codelineno-0-688"></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
<a id="__codelineno-0-689" name="__codelineno-0-689"></a>                        <span class="n">channels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
<a id="__codelineno-0-690" name="__codelineno-0-690"></a>                        <span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-0-691" name="__codelineno-0-691"></a>                        <span class="n">csc_dict</span> <span class="o">=</span> <span class="n">TDict</span><span class="p">()</span>
<a id="__codelineno-0-692" name="__codelineno-0-692"></a>                        <span class="n">csc_dict</span><span class="p">[</span><span class="n">c_space</span><span class="p">]</span> <span class="o">=</span> <span class="n">channels</span>
<a id="__codelineno-0-693" name="__codelineno-0-693"></a>                        <span class="n">color_space_dictionaries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">csc_dict</span><span class="p">)</span>
<a id="__codelineno-0-694" name="__codelineno-0-694"></a>            <span class="k">if</span> <span class="n">ref_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-695" name="__codelineno-0-695"></a>                <span class="n">ref_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">dilate</span><span class="p">(</span><span class="n">ref_image</span><span class="p">,</span> <span class="n">cross_33</span><span class="p">)</span>
<a id="__codelineno-0-696" name="__codelineno-0-696"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-697" name="__codelineno-0-697"></a>                <span class="n">ref_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bgr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-698" name="__codelineno-0-698"></a>            <span class="n">out_of_arenas_threshold</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">out_of_arenas</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-699" name="__codelineno-0-699"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">color_space_dictionaries</span><span class="p">)</span> <span class="o">+</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
<a id="__codelineno-0-700" name="__codelineno-0-700"></a>            <span class="n">cc_nb_idx</span><span class="p">,</span> <span class="n">area_idx</span><span class="p">,</span> <span class="n">out_of_arenas_idx</span><span class="p">,</span> <span class="n">in_arena_idx</span><span class="p">,</span> <span class="n">surf_in_common_idx</span><span class="p">,</span> <span class="n">biosum_idx</span><span class="p">,</span> <span class="n">backsum_idx</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span>
<a id="__codelineno-0-701" name="__codelineno-0-701"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">save_combination_thread</span> <span class="o">=</span> <span class="n">SaveCombinationThread</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-702" name="__codelineno-0-702"></a>
<a id="__codelineno-0-703" name="__codelineno-0-703"></a>            <span class="c1"># Start with a PCA:</span>
<a id="__codelineno-0-704" name="__codelineno-0-704"></a>            <span class="n">pca_dict</span> <span class="o">=</span> <span class="n">TDict</span><span class="p">()</span>
<a id="__codelineno-0-705" name="__codelineno-0-705"></a>            <span class="n">pca_dict</span><span class="p">[</span><span class="s1">&#39;PCA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
<a id="__codelineno-0-706" name="__codelineno-0-706"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">explained_variance_ratio</span><span class="p">,</span> <span class="n">first_pc_vector</span> <span class="o">=</span> <span class="n">extract_first_pc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bgr</span><span class="p">)</span>
<a id="__codelineno-0-707" name="__codelineno-0-707"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">otsu_thresholding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-0-708" name="__codelineno-0-708"></a>            <span class="n">nb</span><span class="p">,</span> <span class="n">shapes</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">connectedComponents</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-709" name="__codelineno-0-709"></a>            <span class="n">nb</span> <span class="o">-=</span> <span class="mi">1</span>
<a id="__codelineno-0-710" name="__codelineno-0-710"></a>            <span class="n">surf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-711" name="__codelineno-0-711"></a>            <span class="n">outside_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">*</span> <span class="n">out_of_arenas</span><span class="p">)</span>
<a id="__codelineno-0-712" name="__codelineno-0-712"></a>            <span class="n">inside_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">*</span> <span class="n">arenas_mask</span><span class="p">)</span>
<a id="__codelineno-0-713" name="__codelineno-0-713"></a>            <span class="n">in_common</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ref_image</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-714" name="__codelineno-0-714"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-0-715" name="__codelineno-0-715"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-716" name="__codelineno-0-716"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pca_dict</span><span class="p">)</span>
<a id="__codelineno-0-717" name="__codelineno-0-717"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pca_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-718" name="__codelineno-0-718"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">cc_nb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">nb</span>
<a id="__codelineno-0-719" name="__codelineno-0-719"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">area_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">surf</span>
<a id="__codelineno-0-720" name="__codelineno-0-720"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">out_of_arenas_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">outside_pixels</span>
<a id="__codelineno-0-721" name="__codelineno-0-721"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">in_arena_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">inside_pixels</span>
<a id="__codelineno-0-722" name="__codelineno-0-722"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">surf_in_common_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_common</span>
<a id="__codelineno-0-723" name="__codelineno-0-723"></a>            <span class="k">if</span> <span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-724" name="__codelineno-0-724"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">biosum_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
<a id="__codelineno-0-725" name="__codelineno-0-725"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">[</span><span class="n">biomask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">biomask</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-726" name="__codelineno-0-726"></a>            <span class="k">if</span> <span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-727" name="__codelineno-0-727"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">backsum_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
<a id="__codelineno-0-728" name="__codelineno-0-728"></a>                    <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)[</span><span class="n">backmask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">backmask</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-729" name="__codelineno-0-729"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-730" name="__codelineno-0-730"></a>
<a id="__codelineno-0-731" name="__codelineno-0-731"></a>            <span class="n">potentials</span> <span class="o">=</span> <span class="n">TDict</span><span class="p">()</span>
<a id="__codelineno-0-732" name="__codelineno-0-732"></a>            <span class="c1"># One channel processing</span>
<a id="__codelineno-0-733" name="__codelineno-0-733"></a>            <span class="k">for</span> <span class="n">csc_dict</span> <span class="ow">in</span> <span class="n">color_space_dictionaries</span><span class="p">:</span>
<a id="__codelineno-0-734" name="__codelineno-0-734"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">combine_color_spaces</span><span class="p">(</span><span class="n">csc_dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_c_spaces</span><span class="p">,</span> <span class="n">subtract_background</span><span class="p">)</span>
<a id="__codelineno-0-735" name="__codelineno-0-735"></a>                <span class="k">if</span> <span class="n">kmeans_clust_nb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-736" name="__codelineno-0-736"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bio_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bio_label2</span> <span class="o">=</span> <span class="n">kmeans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image2</span><span class="p">,</span> <span class="n">kmeans_clust_nb</span><span class="p">,</span> <span class="n">biomask</span><span class="p">,</span> <span class="n">backmask</span><span class="p">)</span>
<a id="__codelineno-0-737" name="__codelineno-0-737"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-738" name="__codelineno-0-738"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">otsu_thresholding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-0-739" name="__codelineno-0-739"></a>                <span class="n">surf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-740" name="__codelineno-0-740"></a>                <span class="k">if</span> <span class="n">surf</span> <span class="o">&lt;</span> <span class="n">total_surfarea</span><span class="p">:</span>
<a id="__codelineno-0-741" name="__codelineno-0-741"></a>                    <span class="n">nb</span><span class="p">,</span> <span class="n">shapes</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">connectedComponents</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-742" name="__codelineno-0-742"></a>                    <span class="n">outside_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">*</span> <span class="n">out_of_arenas</span><span class="p">)</span>
<a id="__codelineno-0-743" name="__codelineno-0-743"></a>                    <span class="n">inside_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">*</span> <span class="n">arenas_mask</span><span class="p">)</span>
<a id="__codelineno-0-744" name="__codelineno-0-744"></a>                    <span class="k">if</span> <span class="n">outside_pixels</span> <span class="o">&lt;</span> <span class="n">inside_pixels</span><span class="p">:</span>
<a id="__codelineno-0-745" name="__codelineno-0-745"></a>                        <span class="k">if</span> <span class="p">(</span><span class="n">nb</span> <span class="o">&gt;</span> <span class="n">concomp_nb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">nb</span> <span class="o">&lt;</span> <span class="n">concomp_nb</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
<a id="__codelineno-0-746" name="__codelineno-0-746"></a>                            <span class="n">in_common</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ref_image</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-747" name="__codelineno-0-747"></a>                            <span class="k">if</span> <span class="n">in_common</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-748" name="__codelineno-0-748"></a>                                <span class="n">nb</span><span class="p">,</span> <span class="n">shapes</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">centroids</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">connectedComponentsWithStats</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-749" name="__codelineno-0-749"></a>                                <span class="n">nb</span> <span class="o">-=</span> <span class="mi">1</span>
<a id="__codelineno-0-750" name="__codelineno-0-750"></a>                                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">stats</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">])[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">max_shape_size</span><span class="p">):</span>
<a id="__codelineno-0-751" name="__codelineno-0-751"></a>                                    <span class="n">c_space</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">csc_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-752" name="__codelineno-0-752"></a>                                    <span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-0-753" name="__codelineno-0-753"></a>                                    <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-754" name="__codelineno-0-754"></a>                                    <span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">csc_dict</span><span class="p">)</span>
<a id="__codelineno-0-755" name="__codelineno-0-755"></a>                                    <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">csc_dict</span><span class="p">[</span><span class="n">c_space</span><span class="p">]</span>
<a id="__codelineno-0-756" name="__codelineno-0-756"></a>                                    <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">cc_nb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">nb</span>
<a id="__codelineno-0-757" name="__codelineno-0-757"></a>                                    <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">area_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">surf</span>
<a id="__codelineno-0-758" name="__codelineno-0-758"></a>                                    <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">out_of_arenas_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">outside_pixels</span>
<a id="__codelineno-0-759" name="__codelineno-0-759"></a>                                    <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">in_arena_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">inside_pixels</span>
<a id="__codelineno-0-760" name="__codelineno-0-760"></a>                                    <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">surf_in_common_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_common</span>
<a id="__codelineno-0-761" name="__codelineno-0-761"></a>                                    <span class="k">if</span> <span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-762" name="__codelineno-0-762"></a>                                        <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">biosum_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
<a id="__codelineno-0-763" name="__codelineno-0-763"></a>                                            <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">[</span><span class="n">biomask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">biomask</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-764" name="__codelineno-0-764"></a>                                    <span class="k">if</span> <span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-765" name="__codelineno-0-765"></a>                                        <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">backsum_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
<a id="__codelineno-0-766" name="__codelineno-0-766"></a>                                            <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)[</span><span class="n">backmask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">backmask</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-767" name="__codelineno-0-767"></a>                                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">c_space</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">potentials</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
<a id="__codelineno-0-768" name="__codelineno-0-768"></a>                                        <span class="n">potentials</span><span class="p">[</span><span class="n">c_space</span><span class="p">]</span> <span class="o">+=</span> <span class="n">csc_dict</span><span class="p">[</span><span class="n">c_space</span><span class="p">]</span>
<a id="__codelineno-0-769" name="__codelineno-0-769"></a>                                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-770" name="__codelineno-0-770"></a>                                        <span class="n">potentials</span><span class="p">[</span><span class="n">c_space</span><span class="p">]</span> <span class="o">=</span> <span class="n">csc_dict</span><span class="p">[</span><span class="n">c_space</span><span class="p">]</span>
<a id="__codelineno-0-771" name="__codelineno-0-771"></a>                                    <span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-772" name="__codelineno-0-772"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">potentials</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-773" name="__codelineno-0-773"></a>                <span class="c1"># All combination processing</span>
<a id="__codelineno-0-774" name="__codelineno-0-774"></a>
<a id="__codelineno-0-775" name="__codelineno-0-775"></a>                <span class="c1"># Add a combination of all selected channels :</span>
<a id="__codelineno-0-776" name="__codelineno-0-776"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">potentials</span><span class="p">)</span>
<a id="__codelineno-0-777" name="__codelineno-0-777"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">combine_color_spaces</span><span class="p">(</span><span class="n">potentials</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_c_spaces</span><span class="p">,</span> <span class="n">subtract_background</span><span class="p">)</span>
<a id="__codelineno-0-778" name="__codelineno-0-778"></a>                <span class="k">if</span> <span class="n">kmeans_clust_nb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-779" name="__codelineno-0-779"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bio_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bio_label2</span> <span class="o">=</span> <span class="n">kmeans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">kmeans_clust_nb</span><span class="o">=</span><span class="n">kmeans_clust_nb</span><span class="p">,</span> <span class="n">biomask</span><span class="o">=</span><span class="n">biomask</span><span class="p">,</span> <span class="n">backmask</span><span class="o">=</span><span class="n">backmask</span><span class="p">)</span>
<a id="__codelineno-0-780" name="__codelineno-0-780"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-781" name="__codelineno-0-781"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">otsu_thresholding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-0-782" name="__codelineno-0-782"></a>                <span class="n">surf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-783" name="__codelineno-0-783"></a>                <span class="n">nb</span><span class="p">,</span> <span class="n">shapes</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">connectedComponents</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-784" name="__codelineno-0-784"></a>                <span class="n">nb</span> <span class="o">-=</span> <span class="mi">1</span>
<a id="__codelineno-0-785" name="__codelineno-0-785"></a>                <span class="n">outside_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">*</span> <span class="n">out_of_arenas</span><span class="p">)</span>
<a id="__codelineno-0-786" name="__codelineno-0-786"></a>                <span class="n">inside_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">*</span> <span class="n">arenas_mask</span><span class="p">)</span>
<a id="__codelineno-0-787" name="__codelineno-0-787"></a>                <span class="n">in_common</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ref_image</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-788" name="__codelineno-0-788"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-0-789" name="__codelineno-0-789"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-790" name="__codelineno-0-790"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">potentials</span><span class="p">)</span>
<a id="__codelineno-0-791" name="__codelineno-0-791"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">potentials</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-792" name="__codelineno-0-792"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">cc_nb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">nb</span>
<a id="__codelineno-0-793" name="__codelineno-0-793"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">area_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">surf</span>
<a id="__codelineno-0-794" name="__codelineno-0-794"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">out_of_arenas_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">outside_pixels</span>
<a id="__codelineno-0-795" name="__codelineno-0-795"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">in_arena_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">inside_pixels</span>
<a id="__codelineno-0-796" name="__codelineno-0-796"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">surf_in_common_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_common</span>
<a id="__codelineno-0-797" name="__codelineno-0-797"></a>                <span class="k">if</span> <span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-798" name="__codelineno-0-798"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">biosum_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
<a id="__codelineno-0-799" name="__codelineno-0-799"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">[</span><span class="n">biomask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">biomask</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-800" name="__codelineno-0-800"></a>                <span class="k">if</span> <span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-801" name="__codelineno-0-801"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">backsum_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
<a id="__codelineno-0-802" name="__codelineno-0-802"></a>                        <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)[</span><span class="n">backmask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">backmask</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-803" name="__codelineno-0-803"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-804" name="__codelineno-0-804"></a>            <span class="c1"># All combination processing</span>
<a id="__codelineno-0-805" name="__codelineno-0-805"></a>            <span class="c1"># Try to remove color space one by one</span>
<a id="__codelineno-0-806" name="__codelineno-0-806"></a>            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-807" name="__codelineno-0-807"></a>            <span class="n">original_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">potentials</span><span class="p">)</span>
<a id="__codelineno-0-808" name="__codelineno-0-808"></a>            <span class="k">while</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">potentials</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">original_length</span> <span class="o">//</span> <span class="mi">2</span><span class="p">):</span>
<a id="__codelineno-0-809" name="__codelineno-0-809"></a>                <span class="n">color_space_to_remove</span> <span class="o">=</span> <span class="n">TList</span><span class="p">()</span>
<a id="__codelineno-0-810" name="__codelineno-0-810"></a>                <span class="c1"># The while loop until one col space remains or the removal of one implies a strong enough area change</span>
<a id="__codelineno-0-811" name="__codelineno-0-811"></a>                <span class="n">previous_c_space</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">potentials</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-812" name="__codelineno-0-812"></a>                <span class="k">for</span> <span class="n">c_space</span> <span class="ow">in</span> <span class="n">potentials</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-813" name="__codelineno-0-813"></a>                    <span class="n">try_potentials</span> <span class="o">=</span> <span class="n">potentials</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-814" name="__codelineno-0-814"></a>                    <span class="n">try_potentials</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">c_space</span><span class="p">)</span>
<a id="__codelineno-0-815" name="__codelineno-0-815"></a>                    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-816" name="__codelineno-0-816"></a>                        <span class="n">try_potentials</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">previous_c_space</span><span class="p">)</span>
<a id="__codelineno-0-817" name="__codelineno-0-817"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">combine_color_spaces</span><span class="p">(</span><span class="n">try_potentials</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_c_spaces</span><span class="p">,</span> <span class="n">subtract_background</span><span class="p">)</span>
<a id="__codelineno-0-818" name="__codelineno-0-818"></a>                    <span class="k">if</span> <span class="n">kmeans_clust_nb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-819" name="__codelineno-0-819"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bio_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bio_label2</span>  <span class="o">=</span> <span class="n">kmeans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">kmeans_clust_nb</span><span class="o">=</span><span class="n">kmeans_clust_nb</span><span class="p">,</span> <span class="n">biomask</span><span class="o">=</span><span class="n">biomask</span><span class="p">,</span> <span class="n">backmask</span><span class="o">=</span><span class="n">backmask</span><span class="p">)</span>
<a id="__codelineno-0-820" name="__codelineno-0-820"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-821" name="__codelineno-0-821"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">otsu_thresholding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-0-822" name="__codelineno-0-822"></a>                    <span class="n">surf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-823" name="__codelineno-0-823"></a>                    <span class="k">if</span> <span class="n">surf</span> <span class="o">&lt;</span> <span class="n">total_surfarea</span><span class="p">:</span>
<a id="__codelineno-0-824" name="__codelineno-0-824"></a>                        <span class="n">nb</span><span class="p">,</span> <span class="n">shapes</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">connectedComponents</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-825" name="__codelineno-0-825"></a>                        <span class="n">outside_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">*</span> <span class="n">out_of_arenas</span><span class="p">)</span>
<a id="__codelineno-0-826" name="__codelineno-0-826"></a>                        <span class="n">inside_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">*</span> <span class="n">arenas_mask</span><span class="p">)</span>
<a id="__codelineno-0-827" name="__codelineno-0-827"></a>                        <span class="k">if</span> <span class="n">outside_pixels</span> <span class="o">&lt;</span> <span class="n">inside_pixels</span><span class="p">:</span>
<a id="__codelineno-0-828" name="__codelineno-0-828"></a>                            <span class="k">if</span> <span class="p">(</span><span class="n">nb</span> <span class="o">&gt;</span> <span class="n">concomp_nb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">nb</span> <span class="o">&lt;</span> <span class="n">concomp_nb</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
<a id="__codelineno-0-829" name="__codelineno-0-829"></a>                                <span class="n">in_common</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ref_image</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-830" name="__codelineno-0-830"></a>                                <span class="k">if</span> <span class="n">in_common</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-831" name="__codelineno-0-831"></a>                                    <span class="n">nb</span><span class="p">,</span> <span class="n">shapes</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">centroids</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">connectedComponentsWithStats</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-832" name="__codelineno-0-832"></a>                                    <span class="n">nb</span> <span class="o">-=</span> <span class="mi">1</span>
<a id="__codelineno-0-833" name="__codelineno-0-833"></a>                                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">stats</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">])[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">max_shape_size</span><span class="p">):</span>
<a id="__codelineno-0-834" name="__codelineno-0-834"></a>                                        <span class="c1"># If a color space remove fits in the requirements, we store its values</span>
<a id="__codelineno-0-835" name="__codelineno-0-835"></a>                                        <span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-0-836" name="__codelineno-0-836"></a>                                        <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-837" name="__codelineno-0-837"></a>                                        <span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">try_potentials</span><span class="p">)</span>
<a id="__codelineno-0-838" name="__codelineno-0-838"></a>                                        <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">cc_nb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">nb</span>
<a id="__codelineno-0-839" name="__codelineno-0-839"></a>                                        <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">area_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">surf</span>
<a id="__codelineno-0-840" name="__codelineno-0-840"></a>                                        <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">out_of_arenas_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">outside_pixels</span>
<a id="__codelineno-0-841" name="__codelineno-0-841"></a>                                        <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">in_arena_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">inside_pixels</span>
<a id="__codelineno-0-842" name="__codelineno-0-842"></a>                                        <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">surf_in_common_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_common</span>
<a id="__codelineno-0-843" name="__codelineno-0-843"></a>                                        <span class="k">if</span> <span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-844" name="__codelineno-0-844"></a>                                            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">biosum_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
<a id="__codelineno-0-845" name="__codelineno-0-845"></a>                                                <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">[</span><span class="n">biomask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">biomask</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-846" name="__codelineno-0-846"></a>                                        <span class="k">if</span> <span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-847" name="__codelineno-0-847"></a>                                            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">backsum_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
<a id="__codelineno-0-848" name="__codelineno-0-848"></a>                                                <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)[</span><span class="n">backmask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">backmask</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-849" name="__codelineno-0-849"></a>                                        <span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-850" name="__codelineno-0-850"></a>                                        <span class="n">color_space_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_space</span><span class="p">)</span>
<a id="__codelineno-0-851" name="__codelineno-0-851"></a>                                        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-852" name="__codelineno-0-852"></a>                                            <span class="n">color_space_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">previous_c_space</span><span class="p">)</span>
<a id="__codelineno-0-853" name="__codelineno-0-853"></a>                    <span class="c1"># If it does not (if it did not pass every &quot;if&quot; layers), we definitely remove that color space</span>
<a id="__codelineno-0-854" name="__codelineno-0-854"></a>                    <span class="n">previous_c_space</span> <span class="o">=</span> <span class="n">c_space</span>
<a id="__codelineno-0-855" name="__codelineno-0-855"></a>                <span class="n">color_space_to_remove</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">color_space_to_remove</span><span class="p">)</span>
<a id="__codelineno-0-856" name="__codelineno-0-856"></a>                <span class="k">for</span> <span class="n">remove_col_space</span> <span class="ow">in</span> <span class="n">color_space_to_remove</span><span class="p">:</span>
<a id="__codelineno-0-857" name="__codelineno-0-857"></a>                    <span class="n">potentials</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">remove_col_space</span><span class="p">)</span>
<a id="__codelineno-0-858" name="__codelineno-0-858"></a>                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-859" name="__codelineno-0-859"></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">potentials</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-0-860" name="__codelineno-0-860"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-0-861" name="__codelineno-0-861"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-862" name="__codelineno-0-862"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">potentials</span><span class="p">)</span>
<a id="__codelineno-0-863" name="__codelineno-0-863"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">potentials</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-864" name="__codelineno-0-864"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">cc_nb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">nb</span>
<a id="__codelineno-0-865" name="__codelineno-0-865"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">area_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">surf</span>
<a id="__codelineno-0-866" name="__codelineno-0-866"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">out_of_arenas_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">outside_pixels</span>
<a id="__codelineno-0-867" name="__codelineno-0-867"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">in_arena_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">inside_pixels</span>
<a id="__codelineno-0-868" name="__codelineno-0-868"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">surf_in_common_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_common</span>
<a id="__codelineno-0-869" name="__codelineno-0-869"></a>                <span class="k">if</span> <span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-870" name="__codelineno-0-870"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">biosum_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
<a id="__codelineno-0-871" name="__codelineno-0-871"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">[</span><span class="n">biomask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">biomask</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-872" name="__codelineno-0-872"></a>                <span class="k">if</span> <span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-873" name="__codelineno-0-873"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">backsum_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
<a id="__codelineno-0-874" name="__codelineno-0-874"></a>                        <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)[</span><span class="n">backmask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">backmask</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-875" name="__codelineno-0-875"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-876" name="__codelineno-0-876"></a>
<a id="__codelineno-0-877" name="__codelineno-0-877"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="p">:]</span>
<a id="__codelineno-0-878" name="__codelineno-0-878"></a>            <span class="c1"># Among all potentials, select the best one, according to criterion decreasing in importance</span>
<a id="__codelineno-0-879" name="__codelineno-0-879"></a>            <span class="n">cc_efficiency_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:,</span> <span class="n">surf_in_common_idx</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:,</span> <span class="n">in_arena_idx</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:,</span> <span class="n">out_of_arenas_idx</span><span class="p">])</span>
<a id="__codelineno-0-880" name="__codelineno-0-880"></a>
<a id="__codelineno-0-881" name="__codelineno-0-881"></a>            <span class="c1"># Save and return a dictionnary containing the selected color space combinations</span>
<a id="__codelineno-0-882" name="__codelineno-0-882"></a>            <span class="c1"># and their corresponding binary images</span>
<a id="__codelineno-0-883" name="__codelineno-0-883"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-884" name="__codelineno-0-884"></a>            <span class="k">for</span> <span class="n">saved_csc</span> <span class="ow">in</span> <span class="n">cc_efficiency_order</span><span class="p">:</span>
<a id="__codelineno-0-885" name="__codelineno-0-885"></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="p">[</span><span class="n">saved_csc</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-886" name="__codelineno-0-886"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
<a id="__codelineno-0-887" name="__codelineno-0-887"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;csc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-888" name="__codelineno-0-888"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;csc&quot;</span><span class="p">][</span><span class="s1">&#39;logical&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
<a id="__codelineno-0-889" name="__codelineno-0-889"></a>                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="p">[</span><span class="n">saved_csc</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-890" name="__codelineno-0-890"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;csc&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
<a id="__codelineno-0-891" name="__codelineno-0-891"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;binary_image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="p">[</span><span class="n">saved_csc</span><span class="p">]</span>
<a id="__codelineno-0-892" name="__codelineno-0-892"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;converted_image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span><span class="p">[</span>
<a id="__codelineno-0-893" name="__codelineno-0-893"></a>                        <span class="n">saved_csc</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-894" name="__codelineno-0-894"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-895" name="__codelineno-0-895"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-896" name="__codelineno-0-896"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-897" name="__codelineno-0-897"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-898" name="__codelineno-0-898"></a>
<a id="__codelineno-0-899" name="__codelineno-0-899"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">network_detection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arenas_mask</span><span class="p">:</span> <span class="n">NDArray</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pseudopod_min_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">csc_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">biomask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">backmask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-900" name="__codelineno-0-900"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-901" name="__codelineno-0-901"></a><span class="sd">        Network Detection Function</span>
<a id="__codelineno-0-902" name="__codelineno-0-902"></a>
<a id="__codelineno-0-903" name="__codelineno-0-903"></a><span class="sd">        Perform network detection and pseudopod analysis on an image.</span>
<a id="__codelineno-0-904" name="__codelineno-0-904"></a>
<a id="__codelineno-0-905" name="__codelineno-0-905"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-906" name="__codelineno-0-906"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-907" name="__codelineno-0-907"></a><span class="sd">        arenas_mask : NDArray, optional</span>
<a id="__codelineno-0-908" name="__codelineno-0-908"></a><span class="sd">            The mask indicating the arena regions in the image.</span>
<a id="__codelineno-0-909" name="__codelineno-0-909"></a><span class="sd">        pseudopod_min_size : int, optional</span>
<a id="__codelineno-0-910" name="__codelineno-0-910"></a><span class="sd">            The minimum size for pseudopods to be detected.</span>
<a id="__codelineno-0-911" name="__codelineno-0-911"></a><span class="sd">        csc_dict : dict, optional</span>
<a id="__codelineno-0-912" name="__codelineno-0-912"></a><span class="sd">            A dictionary containing color space conversion parameters. If None,</span>
<a id="__codelineno-0-913" name="__codelineno-0-913"></a><span class="sd">            defaults to {&#39;bgr&#39;: np.array((1, 1, 1), np.int8), &#39;logical&#39;: &#39;None&#39;}</span>
<a id="__codelineno-0-914" name="__codelineno-0-914"></a><span class="sd">        biomask : NDArray, optional</span>
<a id="__codelineno-0-915" name="__codelineno-0-915"></a><span class="sd">            The mask for biological objects in the image.</span>
<a id="__codelineno-0-916" name="__codelineno-0-916"></a><span class="sd">        backmask : NDArray, optional</span>
<a id="__codelineno-0-917" name="__codelineno-0-917"></a><span class="sd">            The background mask.</span>
<a id="__codelineno-0-918" name="__codelineno-0-918"></a>
<a id="__codelineno-0-919" name="__codelineno-0-919"></a><span class="sd">        Notes</span>
<a id="__codelineno-0-920" name="__codelineno-0-920"></a><span class="sd">        -----</span>
<a id="__codelineno-0-921" name="__codelineno-0-921"></a><span class="sd">        This function modifies the object&#39;s state by setting `self.im_combinations`</span>
<a id="__codelineno-0-922" name="__codelineno-0-922"></a><span class="sd">        with the results of network detection and pseudopod analysis.</span>
<a id="__codelineno-0-923" name="__codelineno-0-923"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-924" name="__codelineno-0-924"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Start automatic detection of network(s) in the last image&quot;</span><span class="p">)</span>
<a id="__codelineno-0-925" name="__codelineno-0-925"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bgr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
<a id="__codelineno-0-926" name="__codelineno-0-926"></a>            <span class="k">if</span> <span class="n">csc_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-927" name="__codelineno-0-927"></a>                <span class="n">csc_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bgr&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">),</span> <span class="s1">&#39;logical&#39;</span><span class="p">:</span> <span class="s1">&#39;None&#39;</span><span class="p">}</span>
<a id="__codelineno-0-928" name="__codelineno-0-928"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_color_spaces</span><span class="p">()</span>
<a id="__codelineno-0-929" name="__codelineno-0-929"></a>            <span class="c1"># csc_dict = translate_dict(csc_dict)</span>
<a id="__codelineno-0-930" name="__codelineno-0-930"></a>            <span class="c1"># self.image = combine_color_spaces(csc_dict, self.all_c_spaces)</span>
<a id="__codelineno-0-931" name="__codelineno-0-931"></a>            <span class="n">first_dict</span><span class="p">,</span> <span class="n">second_dict</span><span class="p">,</span> <span class="n">c_spaces</span> <span class="o">=</span> <span class="n">split_dict</span><span class="p">(</span><span class="n">csc_dict</span><span class="p">)</span>
<a id="__codelineno-0-932" name="__codelineno-0-932"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">first_pc_vector</span> <span class="o">=</span> <span class="n">generate_color_space_combination</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bgr</span><span class="p">,</span> <span class="n">c_spaces</span><span class="p">,</span> <span class="n">first_dict</span><span class="p">,</span> <span class="n">second_dict</span><span class="p">,</span> <span class="n">all_c_spaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">all_c_spaces</span><span class="p">)</span>
<a id="__codelineno-0-933" name="__codelineno-0-933"></a>            <span class="c1"># if first_pc_vector is not None:</span>
<a id="__codelineno-0-934" name="__codelineno-0-934"></a>            <span class="c1">#     csc_dict = {&quot;bgr&quot;: first_pc_vector, &quot;logical&quot;: &#39;None&#39;}</span>
<a id="__codelineno-0-935" name="__codelineno-0-935"></a>        <span class="n">greyscale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span>
<a id="__codelineno-0-936" name="__codelineno-0-936"></a>        <span class="n">NetDet</span> <span class="o">=</span> <span class="n">NetworkDetection</span><span class="p">(</span><span class="n">greyscale</span><span class="p">,</span> <span class="n">possibly_filled_pixels</span><span class="o">=</span><span class="n">arenas_mask</span><span class="p">)</span>
<a id="__codelineno-0-937" name="__codelineno-0-937"></a>        <span class="n">NetDet</span><span class="o">.</span><span class="n">get_best_network_detection_method</span><span class="p">()</span>
<a id="__codelineno-0-938" name="__codelineno-0-938"></a>        <span class="n">lighter_background</span> <span class="o">=</span> <span class="n">NetDet</span><span class="o">.</span><span class="n">greyscale_image</span><span class="p">[</span><span class="n">arenas_mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">NetDet</span><span class="o">.</span><span class="n">greyscale_image</span><span class="p">[</span><span class="n">arenas_mask</span><span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<a id="__codelineno-0-939" name="__codelineno-0-939"></a>        <span class="n">NetDet</span><span class="o">.</span><span class="n">detect_pseudopods</span><span class="p">(</span><span class="n">lighter_background</span><span class="p">,</span> <span class="n">pseudopod_min_size</span><span class="o">=</span><span class="n">pseudopod_min_size</span><span class="p">,</span> <span class="n">only_one_connected_component</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-940" name="__codelineno-0-940"></a>        <span class="n">NetDet</span><span class="o">.</span><span class="n">merge_network_with_pseudopods</span><span class="p">()</span>
<a id="__codelineno-0-941" name="__codelineno-0-941"></a>        <span class="n">cc_efficiency_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">NetDet</span><span class="o">.</span><span class="n">quality_metrics</span><span class="p">)</span>
<a id="__codelineno-0-942" name="__codelineno-0-942"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-943" name="__codelineno-0-943"></a>        <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="n">cc_efficiency_order</span><span class="p">:</span>
<a id="__codelineno-0-944" name="__codelineno-0-944"></a>            <span class="n">res_i</span> <span class="o">=</span> <span class="n">NetDet</span><span class="o">.</span><span class="n">all_results</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span>
<a id="__codelineno-0-945" name="__codelineno-0-945"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
<a id="__codelineno-0-946" name="__codelineno-0-946"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;csc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">csc_dict</span>
<a id="__codelineno-0-947" name="__codelineno-0-947"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;converted_image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bracket_to_uint8_image_contrast</span><span class="p">(</span><span class="n">res_i</span><span class="p">[</span><span class="s1">&#39;filtered&#39;</span><span class="p">])</span>
<a id="__codelineno-0-948" name="__codelineno-0-948"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;binary_image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_i</span><span class="p">[</span><span class="s1">&#39;binary&#39;</span><span class="p">]</span>
<a id="__codelineno-0-949" name="__codelineno-0-949"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;filter_spec&#39;</span><span class="p">]</span><span class="o">=</span> <span class="p">{</span><span class="s1">&#39;filter1_type&#39;</span><span class="p">:</span> <span class="n">res_i</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">],</span> <span class="s1">&#39;filter1_param&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">res_i</span><span class="p">[</span><span class="s1">&#39;sigmas&#39;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">res_i</span><span class="p">[</span><span class="s1">&#39;sigmas&#39;</span><span class="p">])],</span> <span class="s1">&#39;filter2_type&#39;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s1">&#39;filter2_param&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]}</span>
<a id="__codelineno-0-950" name="__codelineno-0-950"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;rolling_window&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">res_i</span><span class="p">[</span><span class="s1">&#39;rolling_window&#39;</span><span class="p">]</span>
<a id="__codelineno-0-951" name="__codelineno-0-951"></a>
<a id="__codelineno-0-952" name="__codelineno-0-952"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_crop_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-953" name="__codelineno-0-953"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-954" name="__codelineno-0-954"></a><span class="sd">        Get the crop coordinates for image processing.</span>
<a id="__codelineno-0-955" name="__codelineno-0-955"></a>
<a id="__codelineno-0-956" name="__codelineno-0-956"></a><span class="sd">        This function projects the image on both x and y axes to detect rows</span>
<a id="__codelineno-0-957" name="__codelineno-0-957"></a><span class="sd">        and columns of arenas, calculates the boundaries for cropping,</span>
<a id="__codelineno-0-958" name="__codelineno-0-958"></a><span class="sd">        and determines if the arenas are zigzagged.-</span>
<a id="__codelineno-0-959" name="__codelineno-0-959"></a>
<a id="__codelineno-0-960" name="__codelineno-0-960"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-961" name="__codelineno-0-961"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Project the image on the y axis to detect rows of arenas&quot;</span><span class="p">)</span>
<a id="__codelineno-0-962" name="__codelineno-0-962"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y_boundaries</span><span class="p">,</span> <span class="n">y_max_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection_to_get_peaks_boundaries</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-963" name="__codelineno-0-963"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Project the image on the x axis to detect columns of arenas&quot;</span><span class="p">)</span>
<a id="__codelineno-0-964" name="__codelineno-0-964"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x_boundaries</span><span class="p">,</span> <span class="n">x_max_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection_to_get_peaks_boundaries</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-965" name="__codelineno-0-965"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Get crop coordinates using the get_crop_coordinates method of OneImageAnalysis class&quot;</span><span class="p">)</span>
<a id="__codelineno-0-966" name="__codelineno-0-966"></a>        <span class="n">row_number</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_boundaries</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">//</span> <span class="mi">2</span>
<a id="__codelineno-0-967" name="__codelineno-0-967"></a>        <span class="n">col_number</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_boundaries</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">//</span> <span class="mi">2</span>
<a id="__codelineno-0-968" name="__codelineno-0-968"></a>        <span class="n">are_zigzag</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-969" name="__codelineno-0-969"></a>        <span class="k">if</span> <span class="n">col_number</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">row_number</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-970" name="__codelineno-0-970"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">x_max_sum</span> <span class="o">/</span> <span class="n">col_number</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">y_max_sum</span> <span class="o">/</span> <span class="n">row_number</span><span class="p">):</span>
<a id="__codelineno-0-971" name="__codelineno-0-971"></a>                <span class="n">are_zigzag</span> <span class="o">=</span> <span class="s2">&quot;columns&quot;</span>
<a id="__codelineno-0-972" name="__codelineno-0-972"></a>            <span class="k">elif</span> <span class="p">(</span><span class="n">x_max_sum</span> <span class="o">/</span> <span class="n">col_number</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">y_max_sum</span> <span class="o">/</span> <span class="n">row_number</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-0-973" name="__codelineno-0-973"></a>                <span class="n">are_zigzag</span> <span class="o">=</span> <span class="s2">&quot;rows&quot;</span>
<a id="__codelineno-0-974" name="__codelineno-0-974"></a>        <span class="c1"># here automatically determine if are zigzag</span>
<a id="__codelineno-0-975" name="__codelineno-0-975"></a>        <span class="n">x_boundary_number</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_boundaries</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-976" name="__codelineno-0-976"></a>        <span class="k">if</span> <span class="n">x_boundary_number</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-977" name="__codelineno-0-977"></a>            <span class="k">if</span> <span class="n">x_boundary_number</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
<a id="__codelineno-0-978" name="__codelineno-0-978"></a>                <span class="n">x_interval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_boundaries</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])))</span> <span class="o">//</span> <span class="mi">2</span>
<a id="__codelineno-0-979" name="__codelineno-0-979"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-980" name="__codelineno-0-980"></a>                <span class="k">if</span> <span class="n">are_zigzag</span> <span class="o">==</span> <span class="s2">&quot;columns&quot;</span><span class="p">:</span>
<a id="__codelineno-0-981" name="__codelineno-0-981"></a>                    <span class="n">x_interval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_boundaries</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][::</span><span class="mi">2</span><span class="p">])))</span> <span class="o">//</span> <span class="mi">2</span>
<a id="__codelineno-0-982" name="__codelineno-0-982"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-983" name="__codelineno-0-983"></a>                    <span class="n">x_interval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_boundaries</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])))</span> <span class="o">//</span> <span class="mi">2</span>
<a id="__codelineno-0-984" name="__codelineno-0-984"></a>            <span class="n">cx_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_boundaries</span> <span class="o">==</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_interval</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-0-985" name="__codelineno-0-985"></a>            <span class="n">cx_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_boundaries</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="n">col_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">x_interval</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-0-986" name="__codelineno-0-986"></a>            <span class="k">if</span> <span class="n">cx_min</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">cx_min</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-987" name="__codelineno-0-987"></a>            <span class="k">if</span> <span class="n">cx_max</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_boundaries</span><span class="p">):</span> <span class="n">cx_max</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_boundaries</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
<a id="__codelineno-0-988" name="__codelineno-0-988"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-989" name="__codelineno-0-989"></a>            <span class="n">cx_min</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-990" name="__codelineno-0-990"></a>            <span class="n">cx_max</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_boundaries</span><span class="p">)</span><span class="c1"># - 1</span>
<a id="__codelineno-0-991" name="__codelineno-0-991"></a>
<a id="__codelineno-0-992" name="__codelineno-0-992"></a>        <span class="n">y_boundary_number</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_boundaries</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-993" name="__codelineno-0-993"></a>        <span class="k">if</span> <span class="n">y_boundary_number</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-994" name="__codelineno-0-994"></a>            <span class="k">if</span> <span class="n">y_boundary_number</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
<a id="__codelineno-0-995" name="__codelineno-0-995"></a>                <span class="n">y_interval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_boundaries</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])))</span> <span class="o">//</span> <span class="mi">2</span>
<a id="__codelineno-0-996" name="__codelineno-0-996"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-997" name="__codelineno-0-997"></a>                <span class="k">if</span> <span class="n">are_zigzag</span> <span class="o">==</span> <span class="s2">&quot;rows&quot;</span><span class="p">:</span>
<a id="__codelineno-0-998" name="__codelineno-0-998"></a>                    <span class="n">y_interval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_boundaries</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][::</span><span class="mi">2</span><span class="p">])))</span> <span class="o">//</span> <span class="mi">2</span>
<a id="__codelineno-0-999" name="__codelineno-0-999"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1000" name="__codelineno-0-1000"></a>                    <span class="n">y_interval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_boundaries</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])))</span> <span class="o">//</span> <span class="mi">2</span>
<a id="__codelineno-0-1001" name="__codelineno-0-1001"></a>            <span class="n">cy_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_boundaries</span> <span class="o">==</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_interval</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-0-1002" name="__codelineno-0-1002"></a>            <span class="n">cy_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_boundaries</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="n">row_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">y_interval</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-0-1003" name="__codelineno-0-1003"></a>            <span class="k">if</span> <span class="n">cy_min</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">cy_min</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-1004" name="__codelineno-0-1004"></a>            <span class="k">if</span> <span class="n">cy_max</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_boundaries</span><span class="p">):</span> <span class="n">cy_max</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_boundaries</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
<a id="__codelineno-0-1005" name="__codelineno-0-1005"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1006" name="__codelineno-0-1006"></a>            <span class="n">cy_min</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-1007" name="__codelineno-0-1007"></a>            <span class="n">cy_max</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_boundaries</span><span class="p">)</span><span class="c1"># - 1</span>
<a id="__codelineno-0-1008" name="__codelineno-0-1008"></a>
<a id="__codelineno-0-1009" name="__codelineno-0-1009"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">crop_coord</span> <span class="o">=</span> <span class="p">[</span><span class="n">cy_min</span><span class="p">,</span> <span class="n">cy_max</span><span class="p">,</span> <span class="n">cx_min</span><span class="p">,</span> <span class="n">cx_max</span><span class="p">]</span>
<a id="__codelineno-0-1010" name="__codelineno-0-1010"></a>
<a id="__codelineno-0-1011" name="__codelineno-0-1011"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">projection_to_get_peaks_boundaries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<a id="__codelineno-0-1012" name="__codelineno-0-1012"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1013" name="__codelineno-0-1013"></a>
<a id="__codelineno-0-1014" name="__codelineno-0-1014"></a><span class="sd">        Projection to get peaks&#39; boundaries.</span>
<a id="__codelineno-0-1015" name="__codelineno-0-1015"></a>
<a id="__codelineno-0-1016" name="__codelineno-0-1016"></a><span class="sd">        Calculate the projection of an array along a specified axis and</span>
<a id="__codelineno-0-1017" name="__codelineno-0-1017"></a><span class="sd">        identify the boundaries of non-zero peaks.</span>
<a id="__codelineno-0-1018" name="__codelineno-0-1018"></a>
<a id="__codelineno-0-1019" name="__codelineno-0-1019"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-1020" name="__codelineno-0-1020"></a><span class="sd">            axis: int,</span>
<a id="__codelineno-0-1021" name="__codelineno-0-1021"></a><span class="sd">                The axis along which to calculate the projection and identify</span>
<a id="__codelineno-0-1022" name="__codelineno-0-1022"></a><span class="sd">                peaks&#39; boundaries.</span>
<a id="__codelineno-0-1023" name="__codelineno-0-1023"></a>
<a id="__codelineno-0-1024" name="__codelineno-0-1024"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-1025" name="__codelineno-0-1025"></a><span class="sd">            Tuple[NDArray, int]:</span>
<a id="__codelineno-0-1026" name="__codelineno-0-1026"></a><span class="sd">                A tuple containing two elements: an array representing the slopes</span>
<a id="__codelineno-0-1027" name="__codelineno-0-1027"></a><span class="sd">                of peaks&#39; boundaries and an integer representing the maximum sum</span>
<a id="__codelineno-0-1028" name="__codelineno-0-1028"></a><span class="sd">                along the specified axis.</span>
<a id="__codelineno-0-1029" name="__codelineno-0-1029"></a>
<a id="__codelineno-0-1030" name="__codelineno-0-1030"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-1031" name="__codelineno-0-1031"></a>        <span class="n">sums</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validated_shapes</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
<a id="__codelineno-0-1032" name="__codelineno-0-1032"></a>        <span class="n">slopes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">sums</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1033" name="__codelineno-0-1033"></a>        <span class="n">slopes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">slopes</span><span class="p">))</span>
<a id="__codelineno-0-1034" name="__codelineno-0-1034"></a>        <span class="n">coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">slopes</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-1035" name="__codelineno-0-1035"></a>        <span class="k">for</span> <span class="n">ci</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coord</span><span class="p">)):</span>
<a id="__codelineno-0-1036" name="__codelineno-0-1036"></a>            <span class="k">if</span> <span class="n">ci</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-1037" name="__codelineno-0-1037"></a>                <span class="n">slopes</span><span class="p">[</span><span class="n">coord</span><span class="p">[</span><span class="n">ci</span><span class="p">]]</span> <span class="o">=</span> <span class="o">-</span> <span class="mi">1</span>
<a id="__codelineno-0-1038" name="__codelineno-0-1038"></a>        <span class="k">return</span> <span class="n">slopes</span><span class="p">,</span> <span class="n">sums</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<a id="__codelineno-0-1039" name="__codelineno-0-1039"></a>
<a id="__codelineno-0-1040" name="__codelineno-0-1040"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">automatically_crop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">crop_coord</span><span class="p">):</span>
<a id="__codelineno-0-1041" name="__codelineno-0-1041"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1042" name="__codelineno-0-1042"></a><span class="sd">        Automatically crops the image using the given crop coordinates.</span>
<a id="__codelineno-0-1043" name="__codelineno-0-1043"></a>
<a id="__codelineno-0-1044" name="__codelineno-0-1044"></a><span class="sd">        This method crops various attributes of the image such as the main image,</span>
<a id="__codelineno-0-1045" name="__codelineno-0-1045"></a><span class="sd">        binary image, and color spaces. It also updates internal states related to</span>
<a id="__codelineno-0-1046" name="__codelineno-0-1046"></a><span class="sd">        cropping.</span>
<a id="__codelineno-0-1047" name="__codelineno-0-1047"></a>
<a id="__codelineno-0-1048" name="__codelineno-0-1048"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-1049" name="__codelineno-0-1049"></a><span class="sd">            crop_coord (tuple): The coordinates for cropping in the format</span>
<a id="__codelineno-0-1050" name="__codelineno-0-1050"></a><span class="sd">                (start_y, end_y, start_x, end_x), representing the bounding box region</span>
<a id="__codelineno-0-1051" name="__codelineno-0-1051"></a><span class="sd">                to crop from the image.</span>
<a id="__codelineno-0-1052" name="__codelineno-0-1052"></a>
<a id="__codelineno-0-1053" name="__codelineno-0-1053"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-1054" name="__codelineno-0-1054"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cropped</span><span class="p">:</span>
<a id="__codelineno-0-1055" name="__codelineno-0-1055"></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Crop using the automatically_crop method of OneImageAnalysis class&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1056" name="__codelineno-0-1056"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cropped</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-1057" name="__codelineno-0-1057"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">[</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">crop_coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span>
<a id="__codelineno-0-1058" name="__codelineno-0-1058"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">bgr</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bgr</span><span class="p">[</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">crop_coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">...</span><span class="p">])</span>
<a id="__codelineno-0-1059" name="__codelineno-0-1059"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_color_spaces</span><span class="p">()</span>
<a id="__codelineno-0-1060" name="__codelineno-0-1060"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1061" name="__codelineno-0-1061"></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)):</span>
<a id="__codelineno-0-1062" name="__codelineno-0-1062"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;binary_image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;binary_image&quot;</span><span class="p">][</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">crop_coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
<a id="__codelineno-0-1063" name="__codelineno-0-1063"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;converted_image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;converted_image&quot;</span><span class="p">][</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">crop_coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
<a id="__codelineno-0-1064" name="__codelineno-0-1064"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">[</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">crop_coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
<a id="__codelineno-0-1065" name="__codelineno-0-1065"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">greyscale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1066" name="__codelineno-0-1066"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">greyscale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">greyscale</span><span class="p">[</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">crop_coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span>
<a id="__codelineno-0-1067" name="__codelineno-0-1067"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">greyscale2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1068" name="__codelineno-0-1068"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">greyscale2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">greyscale2</span><span class="p">[</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">crop_coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span>
<a id="__codelineno-0-1069" name="__codelineno-0-1069"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1070" name="__codelineno-0-1070"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">image2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image2</span><span class="p">[</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">crop_coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span>
<a id="__codelineno-0-1071" name="__codelineno-0-1071"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1072" name="__codelineno-0-1072"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span><span class="p">[</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">crop_coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span>
<a id="__codelineno-0-1073" name="__codelineno-0-1073"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subtract_background</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1074" name="__codelineno-0-1074"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">subtract_background</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subtract_background</span><span class="p">[</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">crop_coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span>
<a id="__codelineno-0-1075" name="__codelineno-0-1075"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subtract_background2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1076" name="__codelineno-0-1076"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">subtract_background2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subtract_background2</span><span class="p">[</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">crop_coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span>
<a id="__codelineno-0-1077" name="__codelineno-0-1077"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">validated_shapes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validated_shapes</span><span class="p">[</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">crop_coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
<a id="__codelineno-0-1078" name="__codelineno-0-1078"></a>
<a id="__codelineno-0-1079" name="__codelineno-0-1079"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y_boundaries</span><span class="p">,</span> <span class="n">y_max_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection_to_get_peaks_boundaries</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-1080" name="__codelineno-0-1080"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x_boundaries</span><span class="p">,</span> <span class="n">x_max_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection_to_get_peaks_boundaries</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="cellects.core.one_image_analysis.OneImageAnalysis.adjust_to_drift_correction" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">adjust_to_drift_correction</span><span class="p">(</span><span class="n">logical</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Adjust the image and binary image to correct for drift.</p>
<p>This method applies a drift correction by dilating the binary image, calculating
the mean value of the drifted region and applying it back to the image. After this,
it applies Otsu's thresholding method to determine a new binary image and adjusts
the second image if present. The logical operation specified is then applied to the
binary images.</p>
<p>Args:
    logical (str): Logical operation ('Or', 'And', 'Xor') to apply to the binary
        images.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/cellects/core/one_image_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-290" name="__codelineno-0-290"></a><span class="k">def</span><span class="w"> </span><span class="nf">adjust_to_drift_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a><span class="sd">    Adjust the image and binary image to correct for drift.</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a><span class="sd">    This method applies a drift correction by dilating the binary image, calculating</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a><span class="sd">    the mean value of the drifted region and applying it back to the image. After this,</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a><span class="sd">    it applies Otsu&#39;s thresholding method to determine a new binary image and adjusts</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a><span class="sd">    the second image if present. The logical operation specified is then applied to the</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a><span class="sd">    binary images.</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a><span class="sd">        logical (str): Logical operation (&#39;Or&#39;, &#39;And&#39;, &#39;Xor&#39;) to apply to the binary</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a><span class="sd">            images.&quot;&quot;&quot;</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_correction_already_adjusted</span><span class="p">:</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">drift_correction_already_adjusted</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">dilate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="n">cross_33</span><span class="p">)</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>        <span class="n">mask</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>        <span class="n">drift_correction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">[</span><span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)]</span> <span class="o">=</span> <span class="n">drift_correction</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>        <span class="n">threshold</span> <span class="o">=</span> <span class="n">get_otsu_threshold</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>        <span class="n">binary</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>            <span class="n">drift_correction2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image2</span><span class="p">[</span><span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image2</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)]</span> <span class="o">=</span> <span class="n">drift_correction2</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>            <span class="n">threshold</span> <span class="o">=</span> <span class="n">get_otsu_threshold</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image2</span><span class="p">)</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>            <span class="n">binary1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image2</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>            <span class="n">binary2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">binary1</span><span class="p">)</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>            <span class="k">if</span> <span class="n">binary1</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">binary2</span><span class="o">.</span><span class="n">sum</span><span class="p">():</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>                <span class="n">binary</span> <span class="o">=</span> <span class="n">binary1</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>                <span class="n">binary</span> <span class="o">=</span> <span class="n">binary2</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>            <span class="k">while</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">binary</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span><span class="p">)</span> <span class="ow">and</span> <span class="n">threshold</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>                <span class="n">threshold</span> <span class="o">-=</span> <span class="mi">1</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>                <span class="n">binary1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image2</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>                <span class="n">binary2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">binary1</span><span class="p">)</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>                <span class="k">if</span> <span class="n">binary1</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">binary2</span><span class="o">.</span><span class="n">sum</span><span class="p">():</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>                    <span class="n">binary</span> <span class="o">=</span> <span class="n">binary1</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>                    <span class="n">binary</span> <span class="o">=</span> <span class="n">binary2</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>            <span class="k">if</span> <span class="n">logical</span> <span class="o">==</span> <span class="s1">&#39;Or&#39;</span><span class="p">:</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span><span class="p">)</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>            <span class="k">elif</span> <span class="n">logical</span> <span class="o">==</span> <span class="s1">&#39;And&#39;</span><span class="p">:</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span><span class="p">)</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>            <span class="k">elif</span> <span class="n">logical</span> <span class="o">==</span> <span class="s1">&#39;Xor&#39;</span><span class="p">:</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_xor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span><span class="p">)</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cellects.core.one_image_analysis.OneImageAnalysis.automatically_crop" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">automatically_crop</span><span class="p">(</span><span class="n">crop_coord</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Automatically crops the image using the given crop coordinates.</p>
<p>This method crops various attributes of the image such as the main image,
binary image, and color spaces. It also updates internal states related to
cropping.</p>
<p>Args:
    crop_coord (tuple): The coordinates for cropping in the format
        (start_y, end_y, start_x, end_x), representing the bounding box region
        to crop from the image.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/cellects/core/one_image_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1040">1040</a></span>
<span class="normal"><a href="#__codelineno-0-1041">1041</a></span>
<span class="normal"><a href="#__codelineno-0-1042">1042</a></span>
<span class="normal"><a href="#__codelineno-0-1043">1043</a></span>
<span class="normal"><a href="#__codelineno-0-1044">1044</a></span>
<span class="normal"><a href="#__codelineno-0-1045">1045</a></span>
<span class="normal"><a href="#__codelineno-0-1046">1046</a></span>
<span class="normal"><a href="#__codelineno-0-1047">1047</a></span>
<span class="normal"><a href="#__codelineno-0-1048">1048</a></span>
<span class="normal"><a href="#__codelineno-0-1049">1049</a></span>
<span class="normal"><a href="#__codelineno-0-1050">1050</a></span>
<span class="normal"><a href="#__codelineno-0-1051">1051</a></span>
<span class="normal"><a href="#__codelineno-0-1052">1052</a></span>
<span class="normal"><a href="#__codelineno-0-1053">1053</a></span>
<span class="normal"><a href="#__codelineno-0-1054">1054</a></span>
<span class="normal"><a href="#__codelineno-0-1055">1055</a></span>
<span class="normal"><a href="#__codelineno-0-1056">1056</a></span>
<span class="normal"><a href="#__codelineno-0-1057">1057</a></span>
<span class="normal"><a href="#__codelineno-0-1058">1058</a></span>
<span class="normal"><a href="#__codelineno-0-1059">1059</a></span>
<span class="normal"><a href="#__codelineno-0-1060">1060</a></span>
<span class="normal"><a href="#__codelineno-0-1061">1061</a></span>
<span class="normal"><a href="#__codelineno-0-1062">1062</a></span>
<span class="normal"><a href="#__codelineno-0-1063">1063</a></span>
<span class="normal"><a href="#__codelineno-0-1064">1064</a></span>
<span class="normal"><a href="#__codelineno-0-1065">1065</a></span>
<span class="normal"><a href="#__codelineno-0-1066">1066</a></span>
<span class="normal"><a href="#__codelineno-0-1067">1067</a></span>
<span class="normal"><a href="#__codelineno-0-1068">1068</a></span>
<span class="normal"><a href="#__codelineno-0-1069">1069</a></span>
<span class="normal"><a href="#__codelineno-0-1070">1070</a></span>
<span class="normal"><a href="#__codelineno-0-1071">1071</a></span>
<span class="normal"><a href="#__codelineno-0-1072">1072</a></span>
<span class="normal"><a href="#__codelineno-0-1073">1073</a></span>
<span class="normal"><a href="#__codelineno-0-1074">1074</a></span>
<span class="normal"><a href="#__codelineno-0-1075">1075</a></span>
<span class="normal"><a href="#__codelineno-0-1076">1076</a></span>
<span class="normal"><a href="#__codelineno-0-1077">1077</a></span>
<span class="normal"><a href="#__codelineno-0-1078">1078</a></span>
<span class="normal"><a href="#__codelineno-0-1079">1079</a></span>
<span class="normal"><a href="#__codelineno-0-1080">1080</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1040" name="__codelineno-0-1040"></a><span class="k">def</span><span class="w"> </span><span class="nf">automatically_crop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">crop_coord</span><span class="p">):</span>
<a id="__codelineno-0-1041" name="__codelineno-0-1041"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1042" name="__codelineno-0-1042"></a><span class="sd">    Automatically crops the image using the given crop coordinates.</span>
<a id="__codelineno-0-1043" name="__codelineno-0-1043"></a>
<a id="__codelineno-0-1044" name="__codelineno-0-1044"></a><span class="sd">    This method crops various attributes of the image such as the main image,</span>
<a id="__codelineno-0-1045" name="__codelineno-0-1045"></a><span class="sd">    binary image, and color spaces. It also updates internal states related to</span>
<a id="__codelineno-0-1046" name="__codelineno-0-1046"></a><span class="sd">    cropping.</span>
<a id="__codelineno-0-1047" name="__codelineno-0-1047"></a>
<a id="__codelineno-0-1048" name="__codelineno-0-1048"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1049" name="__codelineno-0-1049"></a><span class="sd">        crop_coord (tuple): The coordinates for cropping in the format</span>
<a id="__codelineno-0-1050" name="__codelineno-0-1050"></a><span class="sd">            (start_y, end_y, start_x, end_x), representing the bounding box region</span>
<a id="__codelineno-0-1051" name="__codelineno-0-1051"></a><span class="sd">            to crop from the image.</span>
<a id="__codelineno-0-1052" name="__codelineno-0-1052"></a>
<a id="__codelineno-0-1053" name="__codelineno-0-1053"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1054" name="__codelineno-0-1054"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cropped</span><span class="p">:</span>
<a id="__codelineno-0-1055" name="__codelineno-0-1055"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Crop using the automatically_crop method of OneImageAnalysis class&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1056" name="__codelineno-0-1056"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cropped</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-1057" name="__codelineno-0-1057"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">[</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">crop_coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span>
<a id="__codelineno-0-1058" name="__codelineno-0-1058"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bgr</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bgr</span><span class="p">[</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">crop_coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">...</span><span class="p">])</span>
<a id="__codelineno-0-1059" name="__codelineno-0-1059"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_color_spaces</span><span class="p">()</span>
<a id="__codelineno-0-1060" name="__codelineno-0-1060"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1061" name="__codelineno-0-1061"></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)):</span>
<a id="__codelineno-0-1062" name="__codelineno-0-1062"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;binary_image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;binary_image&quot;</span><span class="p">][</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">crop_coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
<a id="__codelineno-0-1063" name="__codelineno-0-1063"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;converted_image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;converted_image&quot;</span><span class="p">][</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">crop_coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
<a id="__codelineno-0-1064" name="__codelineno-0-1064"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">[</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">crop_coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
<a id="__codelineno-0-1065" name="__codelineno-0-1065"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">greyscale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1066" name="__codelineno-0-1066"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">greyscale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">greyscale</span><span class="p">[</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">crop_coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span>
<a id="__codelineno-0-1067" name="__codelineno-0-1067"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">greyscale2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1068" name="__codelineno-0-1068"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">greyscale2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">greyscale2</span><span class="p">[</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">crop_coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span>
<a id="__codelineno-0-1069" name="__codelineno-0-1069"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1070" name="__codelineno-0-1070"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image2</span><span class="p">[</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">crop_coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span>
<a id="__codelineno-0-1071" name="__codelineno-0-1071"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1072" name="__codelineno-0-1072"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span><span class="p">[</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">crop_coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span>
<a id="__codelineno-0-1073" name="__codelineno-0-1073"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subtract_background</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1074" name="__codelineno-0-1074"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">subtract_background</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subtract_background</span><span class="p">[</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">crop_coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span>
<a id="__codelineno-0-1075" name="__codelineno-0-1075"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subtract_background2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1076" name="__codelineno-0-1076"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">subtract_background2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subtract_background2</span><span class="p">[</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">crop_coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span>
<a id="__codelineno-0-1077" name="__codelineno-0-1077"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validated_shapes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validated_shapes</span><span class="p">[</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">crop_coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">crop_coord</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
<a id="__codelineno-0-1078" name="__codelineno-0-1078"></a>
<a id="__codelineno-0-1079" name="__codelineno-0-1079"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y_boundaries</span><span class="p">,</span> <span class="n">y_max_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection_to_get_peaks_boundaries</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-1080" name="__codelineno-0-1080"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x_boundaries</span><span class="p">,</span> <span class="n">x_max_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection_to_get_peaks_boundaries</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cellects.core.one_image_analysis.OneImageAnalysis.check_if_image_border_attest_drift_correction" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">check_if_image_border_attest_drift_correction</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Check if the given binary image requires border attenuation and drift correction.</p>
<p>In order to determine the need for border attenuation or drift correction, this function
evaluates the borders of a binary image. If any two opposite borders are fully black,
it assumes that there is an issue requiring correction.</p>
<p>Returns:
    bool: True if border attenuation or drift correction is required, False otherwise.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/cellects/core/one_image_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-256" name="__codelineno-0-256"></a><span class="k">def</span><span class="w"> </span><span class="nf">check_if_image_border_attest_drift_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a><span class="sd">    Check if the given binary image requires border attenuation and drift correction.</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a><span class="sd">    In order to determine the need for border attenuation or drift correction, this function</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a><span class="sd">    evaluates the borders of a binary image. If any two opposite borders are fully black,</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a><span class="sd">    it assumes that there is an issue requiring correction.</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a><span class="sd">        bool: True if border attenuation or drift correction is required, False otherwise.</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>    <span class="n">l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">drift_mask_coord</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="ow">and</span> <span class="n">b</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">t</span> <span class="ow">and</span> <span class="n">r</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">t</span> <span class="ow">and</span> <span class="n">l</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">t</span> <span class="ow">and</span> <span class="n">r</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">b</span> <span class="ow">and</span> <span class="n">l</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">b</span> <span class="ow">and</span> <span class="n">r</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">l</span> <span class="ow">and</span> <span class="n">r</span><span class="p">):</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>        <span class="n">cc_nb</span><span class="p">,</span> <span class="n">shapes</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">connectedComponents</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>        <span class="k">if</span> <span class="n">cc_nb</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>            <span class="k">if</span> <span class="n">cc_nb</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>                <span class="n">drift_mask_coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>                <span class="n">back</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">shapes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>  <span class="n">shapes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">shapes</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>                <span class="n">drift_mask_coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">shapes</span><span class="p">,</span> <span class="n">back</span><span class="p">[</span><span class="n">back</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])))</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>            <span class="n">drift_mask_coord</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">drift_mask_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">drift_mask_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>                                <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">drift_mask_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">drift_mask_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">drift_mask_coord</span> <span class="o">=</span> <span class="n">drift_mask_coord</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cellects.core.one_image_analysis.OneImageAnalysis.convert_and_segment" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">convert_and_segment</span><span class="p">(</span><span class="n">c_space_dict</span><span class="p">,</span> <span class="n">color_number</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">biomask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">backmask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subtract_background</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subtract_background2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rolling_window_segmentation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lighter_background</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allowed_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_spec</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Convert an image to grayscale and segment it based on specified parameters.</p>
<p>This method converts the given color space dictionary into grayscale
images, combines them with existing color spaces and performs segmentation.
It has special handling for images that are already in grayscale.</p>
<p><strong>Args:</strong></p>
<ul>
<li><code>c_space_dict</code> (dict): Dictionary containing color spaces.</li>
<li><code>color_number</code> (int, optional): Number of colors to use in segmentation. Defaults to 2.</li>
<li><code>biomask</code> (NDArray[np.uint8], optional): Biomask for segmentation. Defaults to None.</li>
<li><code>backmask</code> (NDArray[np.uint8], optional): Backmask for segmentation. Defaults to None.</li>
<li><code>subtract_background</code> (NDArray, optional): Background to subtract. Defaults to None.</li>
<li><code>subtract_background2</code> (NDArray, optional): Second background to subtract. Defaults to None.</li>
<li>rolling_window_segmentation (dict, optional): Flag for grid segmentation. Defaults to None.</li>
<li><code>lighter_background</code> (bool, optional): Flag for lighter background. Defaults to None.</li>
<li><code>mask</code> (NDArray, optional): Additional mask for segmentation. Defaults to None.</li>
<li><code>filter_spec</code> (dict, optional): Filter specifications. Defaults to None.</li>
</ul>
<p><strong>Attributes:</strong></p>
<ul>
<li><code>self.already_greyscale</code> (bool): Indicates whether the image is already greyscale.</li>
<li><code>self.all_c_spaces</code> (list): List of color spaces.</li>
</ul>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/cellects/core/one_image_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="k">def</span><span class="w"> </span><span class="nf">convert_and_segment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c_space_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">color_number</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">biomask</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>                        <span class="n">backmask</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subtract_background</span><span class="p">:</span> <span class="n">NDArray</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>                        <span class="n">subtract_background2</span><span class="p">:</span> <span class="n">NDArray</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rolling_window_segmentation</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>                        <span class="n">lighter_background</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>                        <span class="n">allowed_window</span><span class="p">:</span> <span class="n">NDArray</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_spec</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="sd">    Convert an image to grayscale and segment it based on specified parameters.</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="sd">    This method converts the given color space dictionary into grayscale</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">    images, combines them with existing color spaces and performs segmentation.</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="sd">    It has special handling for images that are already in grayscale.</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="sd">    **Args:**</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">    - `c_space_dict` (dict): Dictionary containing color spaces.</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="sd">    - `color_number` (int, optional): Number of colors to use in segmentation. Defaults to 2.</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="sd">    - `biomask` (NDArray[np.uint8], optional): Biomask for segmentation. Defaults to None.</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="sd">    - `backmask` (NDArray[np.uint8], optional): Backmask for segmentation. Defaults to None.</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="sd">    - `subtract_background` (NDArray, optional): Background to subtract. Defaults to None.</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">    - `subtract_background2` (NDArray, optional): Second background to subtract. Defaults to None.</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">    - rolling_window_segmentation (dict, optional): Flag for grid segmentation. Defaults to None.</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="sd">    - `lighter_background` (bool, optional): Flag for lighter background. Defaults to None.</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="sd">    - `mask` (NDArray, optional): Additional mask for segmentation. Defaults to None.</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="sd">    - `filter_spec` (dict, optional): Filter specifications. Defaults to None.</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a><span class="sd">    **Attributes:**</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="sd">    - `self.already_greyscale` (bool): Indicates whether the image is already greyscale.</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="sd">    - `self.all_c_spaces` (list): List of color spaces.</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">already_greyscale</span><span class="p">:</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="n">first_dict</span><span class="p">,</span> <span class="n">second_dict</span><span class="p">,</span> <span class="n">c_spaces</span> <span class="o">=</span> <span class="n">split_dict</span><span class="p">(</span><span class="n">c_space_dict</span><span class="p">)</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image2</span><span class="p">,</span> <span class="n">all_c_spaces</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_pc_vector</span> <span class="o">=</span> <span class="n">generate_color_space_combination</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bgr</span><span class="p">,</span> <span class="n">c_spaces</span><span class="p">,</span> <span class="n">first_dict</span><span class="p">,</span> <span class="n">second_dict</span><span class="p">,</span> <span class="n">subtract_background</span><span class="p">,</span> <span class="n">subtract_background2</span><span class="p">)</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_c_spaces</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_c_spaces</span><span class="p">):</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">all_c_spaces</span> <span class="o">=</span> <span class="n">all_c_spaces</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">segmentation</span><span class="p">(</span><span class="n">logical</span><span class="o">=</span><span class="n">c_space_dict</span><span class="p">[</span><span class="s1">&#39;logical&#39;</span><span class="p">],</span> <span class="n">color_number</span><span class="o">=</span><span class="n">color_number</span><span class="p">,</span> <span class="n">biomask</span><span class="o">=</span><span class="n">biomask</span><span class="p">,</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>                      <span class="n">backmask</span><span class="o">=</span><span class="n">backmask</span><span class="p">,</span> <span class="n">rolling_window_segmentation</span><span class="o">=</span><span class="n">rolling_window_segmentation</span><span class="p">,</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>                      <span class="n">lighter_background</span><span class="o">=</span><span class="n">lighter_background</span><span class="p">,</span> <span class="n">allowed_window</span><span class="o">=</span><span class="n">allowed_window</span><span class="p">,</span> <span class="n">filter_spec</span><span class="o">=</span><span class="n">filter_spec</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cellects.core.one_image_analysis.OneImageAnalysis.find_first_im_csc" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">find_first_im_csc</span><span class="p">(</span><span class="n">sample_number</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">several_blob_per_arena</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">spot_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spot_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kmeans_clust_nb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">biomask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">backmask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color_space_dictionaries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">basic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Prepare color space lists, dictionaries and matrices.</p>
<p>Args:
    sample_number: An integer representing the sample number. Defaults to None.
    several_blob_per_arena: A boolean indicating whether there are several blobs per arena. Defaults to True.
    spot_shape: A string representing the shape of the spot. Defaults to None.
    spot_size: An integer representing the size of the spot. Defaults to None.
    kmeans_clust_nb: An integer representing the number of clusters for K-means. Defaults to None.
    biomask: A 2D numpy array of type np.uint8 representing the bio mask. Defaults to None.
    backmask: A 2D numpy array of type np.uint8 representing the background mask. Defaults to None.
    color_space_dictionaries: A list of dictionaries containing color space information. Defaults to None.
    basic: A boolean indicating whether to process the data basic. Defaults to True.</p>
<p>Note:
    This method processes the input data to find the first image that matches certain criteria, using various color spaces and masks.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/cellects/core/one_image_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span>
<span class="normal"><a href="#__codelineno-0-584">584</a></span>
<span class="normal"><a href="#__codelineno-0-585">585</a></span>
<span class="normal"><a href="#__codelineno-0-586">586</a></span>
<span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-342" name="__codelineno-0-342"></a><span class="k">def</span><span class="w"> </span><span class="nf">find_first_im_csc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_number</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">several_blob_per_arena</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="n">spot_shape</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>                      <span class="n">spot_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kmeans_clust_nb</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">biomask</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>                      <span class="n">backmask</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color_space_dictionaries</span><span class="p">:</span> <span class="n">TList</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">basic</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a><span class="sd">    Prepare color space lists, dictionaries and matrices.</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a><span class="sd">        sample_number: An integer representing the sample number. Defaults to None.</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a><span class="sd">        several_blob_per_arena: A boolean indicating whether there are several blobs per arena. Defaults to True.</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a><span class="sd">        spot_shape: A string representing the shape of the spot. Defaults to None.</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a><span class="sd">        spot_size: An integer representing the size of the spot. Defaults to None.</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a><span class="sd">        kmeans_clust_nb: An integer representing the number of clusters for K-means. Defaults to None.</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a><span class="sd">        biomask: A 2D numpy array of type np.uint8 representing the bio mask. Defaults to None.</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a><span class="sd">        backmask: A 2D numpy array of type np.uint8 representing the background mask. Defaults to None.</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a><span class="sd">        color_space_dictionaries: A list of dictionaries containing color space information. Defaults to None.</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a><span class="sd">        basic: A boolean indicating whether to process the data basic. Defaults to True.</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a><span class="sd">    Note:</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a><span class="sd">        This method processes the input data to find the first image that matches certain criteria, using various color spaces and masks.</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Start automatic detection of the first image&quot;</span><span class="p">)</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span> <span class="o">=</span> <span class="n">TList</span><span class="p">()</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span> <span class="o">=</span> <span class="n">TList</span><span class="p">()</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_color_spaces</span><span class="p">()</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>        <span class="k">if</span> <span class="n">color_space_dictionaries</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>            <span class="k">if</span> <span class="n">basic</span><span class="p">:</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>                <span class="n">colorspace_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;bgr&quot;</span><span class="p">,</span> <span class="s2">&quot;lab&quot;</span><span class="p">,</span> <span class="s2">&quot;hsv&quot;</span><span class="p">,</span> <span class="s2">&quot;luv&quot;</span><span class="p">,</span> <span class="s2">&quot;hls&quot;</span><span class="p">,</span> <span class="s2">&quot;yuv&quot;</span><span class="p">]</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>                <span class="n">colorspace_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;bgr&quot;</span><span class="p">]</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>            <span class="n">color_space_dictionaries</span> <span class="o">=</span> <span class="n">TList</span><span class="p">()</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c_space</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">colorspace_list</span><span class="p">):</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>                    <span class="n">channels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>                    <span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>                    <span class="n">csc_dict</span> <span class="o">=</span> <span class="n">TDict</span><span class="p">()</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>                    <span class="n">csc_dict</span><span class="p">[</span><span class="n">c_space</span><span class="p">]</span> <span class="o">=</span> <span class="n">channels</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>                    <span class="n">color_space_dictionaries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">csc_dict</span><span class="p">)</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">color_space_dictionaries</span><span class="p">)</span> <span class="o">+</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>        <span class="n">unaltered_cc_nb</span><span class="p">,</span> <span class="n">cc_nb</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="n">width_std</span><span class="p">,</span> <span class="n">height_std</span><span class="p">,</span> <span class="n">area_std</span><span class="p">,</span> <span class="n">biosum</span><span class="p">,</span> <span class="n">backsum</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">save_combination_thread</span> <span class="o">=</span> <span class="n">SaveCombinationThread</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>        <span class="n">get_one_channel_result</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>        <span class="n">combine_channels</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Try detection with each available color space channel, one by one.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>        <span class="k">for</span> <span class="n">csc_dict</span> <span class="ow">in</span> <span class="n">color_space_dictionaries</span><span class="p">:</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>            <span class="n">list_args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_one_channel_result</span><span class="p">,</span> <span class="n">combine_channels</span><span class="p">,</span> <span class="n">csc_dict</span><span class="p">,</span> <span class="n">several_blob_per_arena</span><span class="p">,</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>                         <span class="n">sample_number</span><span class="p">,</span> <span class="n">spot_size</span><span class="p">,</span> <span class="n">spot_shape</span><span class="p">,</span> <span class="n">kmeans_clust_nb</span><span class="p">,</span> <span class="n">biomask</span><span class="p">,</span> <span class="n">backmask</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>            <span class="n">ProcessFirstImage</span><span class="p">(</span><span class="n">list_args</span><span class="p">)</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>        <span class="k">if</span> <span class="n">sample_number</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">basic</span><span class="p">:</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>            <span class="c1"># Try to add csc together</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>            <span class="n">possibilities</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>                <span class="n">different_color_spaces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="p">)</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>                <span class="k">for</span> <span class="n">color_space</span> <span class="ow">in</span> <span class="n">different_color_spaces</span><span class="p">:</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>                    <span class="n">csc_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="p">,</span> <span class="n">color_space</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>                    <span class="n">possibilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">csc_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="n">csc_idx</span><span class="p">,</span> <span class="n">area_std</span><span class="p">]))</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">possibilities</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">:</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>                    <span class="n">remaining_possibilities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="p">))</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>                    <span class="n">remaining_possibilities</span> <span class="o">=</span> <span class="n">remaining_possibilities</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">remaining_possibilities</span><span class="p">,</span> <span class="n">possibilities</span><span class="p">))]</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>                    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">possibilities</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">:</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>                        <span class="n">new_possibility</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="n">remaining_possibilities</span><span class="p">,</span> <span class="n">area_std</span><span class="p">])</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>                        <span class="n">possibilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_possibility</span><span class="p">)</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>                        <span class="n">remaining_possibilities</span> <span class="o">=</span> <span class="n">remaining_possibilities</span><span class="p">[</span><span class="n">remaining_possibilities</span> <span class="o">!=</span> <span class="n">new_possibility</span><span class="p">]</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>            <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">ThreadPool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>            <span class="n">get_one_channel_result</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>            <span class="n">combine_channels</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>            <span class="n">list_args</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_one_channel_result</span><span class="p">,</span> <span class="n">combine_channels</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">several_blob_per_arena</span><span class="p">,</span> <span class="n">sample_number</span><span class="p">,</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>                          <span class="n">spot_size</span><span class="p">,</span> <span class="n">spot_shape</span><span class="p">,</span> <span class="n">kmeans_clust_nb</span><span class="p">,</span> <span class="n">biomask</span><span class="p">,</span> <span class="n">backmask</span><span class="p">,</span> <span class="n">possibilities</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">possibilities</span><span class="p">]</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>            <span class="k">for</span> <span class="n">process_i</span> <span class="ow">in</span> <span class="n">pool</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span><span class="n">ProcessFirstImage</span><span class="p">,</span> <span class="n">list_args</span><span class="p">):</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>                <span class="k">pass</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>        <span class="c1"># Get the most and the least covered images and the 2 best biomask and backmask scores</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>        <span class="c1"># To try combinations of those</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>            <span class="n">csc_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bgr&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))}</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>            <span class="n">list_args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">csc_dict</span><span class="p">,</span> <span class="n">several_blob_per_arena</span><span class="p">,</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>                         <span class="n">sample_number</span><span class="p">,</span> <span class="n">spot_size</span><span class="p">,</span> <span class="n">spot_shape</span><span class="p">,</span> <span class="n">kmeans_clust_nb</span><span class="p">,</span> <span class="n">biomask</span><span class="p">,</span> <span class="n">backmask</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>            <span class="n">process_i</span> <span class="o">=</span> <span class="n">ProcessFirstImage</span><span class="p">(</span><span class="n">list_args</span><span class="p">)</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>            <span class="n">process_i</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bgr</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>            <span class="n">process_i</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">otsu_thresholding</span><span class="p">(</span><span class="n">process_i</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>            <span class="n">process_i</span><span class="o">.</span><span class="n">csc_dict</span> <span class="o">=</span> <span class="n">csc_dict</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>            <span class="n">process_i</span><span class="o">.</span><span class="n">total_area</span> <span class="o">=</span> <span class="n">process_i</span><span class="o">.</span><span class="n">binary_image</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>            <span class="n">process_i</span><span class="o">.</span><span class="n">process_binary_image</span><span class="p">()</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>            <span class="n">process_i</span><span class="o">.</span><span class="n">unaltered_concomp_nb</span><span class="p">,</span> <span class="n">shapes</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">connectedComponents</span><span class="p">(</span><span class="n">process_i</span><span class="o">.</span><span class="n">validated_shapes</span><span class="p">)</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">save_combination_features</span><span class="p">(</span><span class="n">process_i</span><span class="p">)</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="p">:]</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>            <span class="n">fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">])</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>            <span class="n">coverage</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">area</span><span class="p">])</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>            <span class="n">most1</span> <span class="o">=</span> <span class="n">coverage</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span> <span class="n">most2</span> <span class="o">=</span> <span class="n">coverage</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>            <span class="n">least1</span> <span class="o">=</span> <span class="n">coverage</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">least2</span> <span class="o">=</span> <span class="n">coverage</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>            <span class="k">if</span> <span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>                <span class="n">bio_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">biosum</span><span class="p">])</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>                <span class="n">bio1</span> <span class="o">=</span> <span class="n">bio_sort</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span> <span class="n">bio2</span> <span class="o">=</span> <span class="n">bio_sort</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>            <span class="k">if</span> <span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>                <span class="n">back_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">backsum</span><span class="p">])</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>                <span class="n">back1</span> <span class="o">=</span> <span class="n">back_sort</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span> <span class="n">back2</span> <span class="o">=</span> <span class="n">back_sort</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>            <span class="c1"># Try a logical And between the most covered images</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>            <span class="c1"># Should only need one instanciation</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>            <span class="n">process_i</span> <span class="o">=</span> <span class="n">ProcessFirstImage</span><span class="p">(</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>                <span class="p">[</span><span class="bp">self</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">several_blob_per_arena</span><span class="p">,</span> <span class="n">sample_number</span><span class="p">,</span> <span class="n">spot_size</span><span class="p">,</span> <span class="n">spot_shape</span><span class="p">,</span> <span class="n">kmeans_clust_nb</span><span class="p">,</span> <span class="n">biomask</span><span class="p">,</span> <span class="n">backmask</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>            <span class="n">process_i</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="p">[</span><span class="n">most1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="p">[</span><span class="n">most2</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>            <span class="n">process_i</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span><span class="p">[</span><span class="n">most1</span><span class="p">]</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>            <span class="n">process_i</span><span class="o">.</span><span class="n">process_binary_image</span><span class="p">()</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>            <span class="n">process_i</span><span class="o">.</span><span class="n">csc_dict</span> <span class="o">=</span> <span class="p">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="p">[</span><span class="n">most1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="n">most1</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">],</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>                        <span class="s2">&quot;logical&quot;</span><span class="p">:</span> <span class="s2">&quot;And&quot;</span><span class="p">,</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>                        <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="p">[</span><span class="n">most2</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="n">most2</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]}</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>            <span class="n">process_i</span><span class="o">.</span><span class="n">unaltered_concomp_nb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[(</span><span class="n">most1</span><span class="p">,</span> <span class="n">most2</span><span class="p">),</span> <span class="n">unaltered_cc_nb</span><span class="p">])</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>            <span class="n">process_i</span><span class="o">.</span><span class="n">total_area</span> <span class="o">=</span> <span class="n">process_i</span><span class="o">.</span><span class="n">binary_image</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">save_combination_features</span><span class="p">(</span><span class="n">process_i</span><span class="p">)</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>            <span class="n">process_i</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span><span class="p">[</span><span class="n">least1</span><span class="p">]</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>            <span class="n">process_i</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="p">[</span><span class="n">least1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="p">[</span><span class="n">least2</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>            <span class="n">process_i</span><span class="o">.</span><span class="n">process_binary_image</span><span class="p">()</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>            <span class="n">process_i</span><span class="o">.</span><span class="n">csc_dict</span> <span class="o">=</span> <span class="p">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="p">[</span><span class="n">least1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="n">least1</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">],</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>                        <span class="s2">&quot;logical&quot;</span><span class="p">:</span> <span class="s2">&quot;Or&quot;</span><span class="p">,</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>                        <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="p">[</span><span class="n">least2</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="n">least2</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]}</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>            <span class="n">process_i</span><span class="o">.</span><span class="n">unaltered_concomp_nb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[(</span><span class="n">least1</span><span class="p">,</span> <span class="n">least2</span><span class="p">),</span> <span class="n">unaltered_cc_nb</span><span class="p">])</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>            <span class="n">process_i</span><span class="o">.</span><span class="n">total_area</span> <span class="o">=</span> <span class="n">process_i</span><span class="o">.</span><span class="n">binary_image</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">save_combination_features</span><span class="p">(</span><span class="n">process_i</span><span class="p">)</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>            <span class="c1"># self.save_combination_features(csc_dict, unaltered_concomp_nb, self.binary_image.sum(), biomask, backmask)</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>            <span class="c1"># If most images are very low in biosum or backsum, try to mix them together to improve that score</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>            <span class="c1"># Do a logical And between the two best biomasks</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>            <span class="k">if</span> <span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">((</span><span class="n">bio1</span><span class="p">,</span> <span class="n">bio2</span><span class="p">),</span> <span class="p">(</span><span class="n">most1</span><span class="p">,</span> <span class="n">most2</span><span class="p">))):</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>                    <span class="n">process_i</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span><span class="p">[</span><span class="n">bio1</span><span class="p">]</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>                    <span class="n">process_i</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="p">[</span><span class="n">bio1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="p">[</span><span class="n">bio2</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>                    <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>                    <span class="n">process_i</span><span class="o">.</span><span class="n">process_binary_image</span><span class="p">()</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>                    <span class="n">process_i</span><span class="o">.</span><span class="n">csc_dict</span> <span class="o">=</span> <span class="p">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="p">[</span><span class="n">bio1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="n">bio1</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">],</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>                                <span class="s2">&quot;logical&quot;</span><span class="p">:</span> <span class="s2">&quot;And&quot;</span><span class="p">,</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>                                <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="p">[</span><span class="n">bio2</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="n">bio2</span><span class="p">,:</span><span class="mi">3</span><span class="p">]}</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>                    <span class="n">process_i</span><span class="o">.</span><span class="n">unaltered_concomp_nb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[(</span><span class="n">bio1</span><span class="p">,</span> <span class="n">bio2</span><span class="p">),</span> <span class="n">unaltered_cc_nb</span><span class="p">])</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>                    <span class="n">process_i</span><span class="o">.</span><span class="n">total_area</span> <span class="o">=</span> <span class="n">process_i</span><span class="o">.</span><span class="n">binary_image</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">save_combination_features</span><span class="p">(</span><span class="n">process_i</span><span class="p">)</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>            <span class="c1"># Do a logical And between the two best backmask</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>            <span class="k">if</span> <span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">((</span><span class="n">back1</span><span class="p">,</span> <span class="n">back2</span><span class="p">),</span> <span class="p">(</span><span class="n">most1</span><span class="p">,</span> <span class="n">most2</span><span class="p">))):</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>                    <span class="n">process_i</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span><span class="p">[</span><span class="n">back1</span><span class="p">]</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>                    <span class="n">process_i</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="p">[</span><span class="n">back1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="p">[</span><span class="n">back2</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>                    <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>                    <span class="n">process_i</span><span class="o">.</span><span class="n">process_binary_image</span><span class="p">()</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>                    <span class="n">process_i</span><span class="o">.</span><span class="n">csc_dict</span> <span class="o">=</span> <span class="p">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="p">[</span><span class="n">back1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="n">back1</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">],</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>                                <span class="s2">&quot;logical&quot;</span><span class="p">:</span> <span class="s2">&quot;And&quot;</span><span class="p">,</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>                                <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="p">[</span><span class="n">back2</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="n">back2</span><span class="p">,:</span><span class="mi">3</span><span class="p">]}</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>                    <span class="n">process_i</span><span class="o">.</span><span class="n">unaltered_concomp_nb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[(</span><span class="n">back1</span><span class="p">,</span> <span class="n">back2</span><span class="p">),</span> <span class="n">unaltered_cc_nb</span><span class="p">])</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>                    <span class="n">process_i</span><span class="o">.</span><span class="n">total_area</span> <span class="o">=</span> <span class="n">process_i</span><span class="o">.</span><span class="n">binary_image</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">save_combination_features</span><span class="p">(</span><span class="n">process_i</span><span class="p">)</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>            <span class="c1"># Do a logical Or between the best biomask and the best backmask</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>            <span class="k">if</span> <span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">((</span><span class="n">bio1</span><span class="p">,</span> <span class="n">back1</span><span class="p">),</span> <span class="p">(</span><span class="n">least1</span><span class="p">,</span> <span class="n">least2</span><span class="p">))):</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>                    <span class="n">process_i</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span><span class="p">[</span><span class="n">bio1</span><span class="p">]</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>                    <span class="n">process_i</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="p">[</span><span class="n">bio1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="p">[</span><span class="n">back1</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>                        <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>                    <span class="n">process_i</span><span class="o">.</span><span class="n">process_binary_image</span><span class="p">()</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>                    <span class="n">process_i</span><span class="o">.</span><span class="n">csc_dict</span> <span class="o">=</span> <span class="p">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="p">[</span><span class="n">bio1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="n">bio1</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">],</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>                                <span class="s2">&quot;logical&quot;</span><span class="p">:</span> <span class="s2">&quot;Or&quot;</span><span class="p">,</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>                                <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="p">[</span><span class="n">back1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="n">back1</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]}</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>                    <span class="n">process_i</span><span class="o">.</span><span class="n">unaltered_concomp_nb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[(</span><span class="n">bio1</span><span class="p">,</span> <span class="n">back1</span><span class="p">),</span> <span class="n">unaltered_cc_nb</span><span class="p">])</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>                    <span class="c1"># self.save_combination_features(csc_dict, unaltered_concomp_nb, self.binary_image.sum(), biomask,</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>                    <span class="c1">#                                backmask)</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>                    <span class="n">process_i</span><span class="o">.</span><span class="n">total_area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">save_combination_features</span><span class="p">(</span><span class="n">process_i</span><span class="p">)</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_combination_thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">save_combination_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="p">:]</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>            <span class="c1"># Only keep the row that filled conditions</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>            <span class="c1"># Save all combinations if they fulfill the following conditions:</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>            <span class="c1">#   - Their conncomp number is lower than 3 times the smaller conncomp number.</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>            <span class="c1">#   - OR The minimal area variations</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>            <span class="c1">#   - OR The minimal width variations</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>            <span class="c1">#   - OR The minimal height variations</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>            <span class="c1">#   - AND/OR their segmentation fits with biomask and backmask</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>            <span class="n">width_std_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:,</span> <span class="n">width_std</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:,</span> <span class="n">width_std</span><span class="p">])</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>            <span class="n">height_std_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:,</span> <span class="n">height_std</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:,</span> <span class="n">height_std</span><span class="p">])</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>            <span class="n">area_std_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:,</span> <span class="n">area_std</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:,</span> <span class="n">area_std</span><span class="p">])</span> <span class="o">*</span> <span class="mi">10</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>            <span class="n">fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">width_std_fit</span><span class="p">,</span> <span class="n">height_std_fit</span><span class="p">),</span> <span class="n">area_std_fit</span><span class="p">)</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a>            <span class="n">biomask_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a>            <span class="n">backmask_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>            <span class="k">if</span> <span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a>                <span class="k">if</span> <span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a>                    <span class="n">biomask_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:,</span> <span class="n">biosum</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">biomask</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a>                <span class="k">if</span> <span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a>                    <span class="n">backmask_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:,</span> <span class="n">backsum</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">backmask</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a>                <span class="c1"># First test a logical OR between the precedent options and the mask fits.</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a>                <span class="n">fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">biomask_fit</span><span class="p">,</span> <span class="n">backmask_fit</span><span class="p">))</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>                <span class="c1"># If this is not stringent enough, use a logical AND and increase progressively the proportion of pixels that</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a>                <span class="c1"># must match the biomask and the backmask</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>                    <span class="n">to_add</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>                    <span class="k">while</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="ow">and</span> <span class="n">to_add</span> <span class="o">&lt;=</span> <span class="mf">0.25</span><span class="p">:</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>                        <span class="k">if</span> <span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a>                            <span class="n">biomask_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:,</span> <span class="n">biosum</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mf">0.75</span> <span class="o">+</span> <span class="n">to_add</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">biomask</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a>                        <span class="k">if</span> <span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a>                            <span class="n">backmask_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:,</span> <span class="n">backsum</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mf">0.75</span> <span class="o">+</span> <span class="n">to_add</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">backmask</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a>                        <span class="n">test_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">biomask_fit</span><span class="p">,</span> <span class="n">backmask_fit</span><span class="p">))</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a>                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">test_fit</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a>                            <span class="n">fit</span> <span class="o">=</span> <span class="n">test_fit</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>                        <span class="n">to_add</span> <span class="o">+=</span> <span class="mf">0.05</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a>        <span class="c1"># If saved_csc_nb is too low, try bool operators to mix them together to fill holes for instance</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a>        <span class="c1"># Order the table according to the number of shapes that have been removed by filters</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a>        <span class="c1"># cc_efficiency_order = np.argsort(self.combination_features[:, unaltered_cc_nb] - self.combination_features[:, cc_nb])</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a>        <span class="n">cc_efficiency_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:,</span> <span class="n">area_std</span><span class="p">])</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a>        <span class="c1"># Save and return a dictionnary containing the selected color space combinations</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>        <span class="c1"># and their corresponding binary images</span>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a>        <span class="k">for</span> <span class="n">saved_csc</span> <span class="ow">in</span> <span class="n">cc_efficiency_order</span><span class="p">:</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a>            <span class="k">if</span> <span class="n">fit</span><span class="p">[</span><span class="n">saved_csc</span><span class="p">]:</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a>                <span class="c1"># self.im_combinations.append({})</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>                <span class="c1"># self.im_combinations[len(self.im_combinations) - 1][&quot;csc&quot;] = self.saved_color_space_list[saved_csc]</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;csc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;csc&quot;</span><span class="p">][</span><span class="s1">&#39;logical&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="p">[</span><span class="n">saved_csc</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;csc&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a>                <span class="k">if</span> <span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>                    <span class="n">shape_number</span><span class="p">,</span> <span class="n">shapes</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">connectedComponents</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="p">[</span><span class="n">saved_csc</span><span class="p">],</span> <span class="n">connectivity</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">shapes</span><span class="p">[</span><span class="n">backmask</span><span class="p">]):</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>                        <span class="n">shapes</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">shapes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">shapes</span><span class="p">[</span><span class="n">backmask</span><span class="p">]))]</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="p">[</span><span class="n">saved_csc</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">shapes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>                <span class="k">if</span> <span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="p">[</span><span class="n">saved_csc</span><span class="p">][</span><span class="n">biomask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>                <span class="k">if</span> <span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="n">saved_csc</span><span class="p">,</span> <span class="n">cc_nb</span><span class="p">],</span> <span class="n">shapes</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">connectedComponents</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="p">[</span><span class="n">saved_csc</span><span class="p">],</span> <span class="n">connectivity</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="n">saved_csc</span><span class="p">,</span> <span class="n">cc_nb</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;binary_image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="p">[</span><span class="n">saved_csc</span><span class="p">]</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;shape_number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="n">saved_csc</span><span class="p">,</span> <span class="n">cc_nb</span><span class="p">]</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;converted_image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span><span class="p">[</span><span class="n">saved_csc</span><span class="p">]</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cellects.core.one_image_analysis.OneImageAnalysis.find_last_im_csc" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">find_last_im_csc</span><span class="p">(</span><span class="n">concomp_nb</span><span class="p">,</span> <span class="n">total_surfarea</span><span class="p">,</span> <span class="n">max_shape_size</span><span class="p">,</span> <span class="n">arenas_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subtract_background</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kmeans_clust_nb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">biomask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">backmask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color_space_dictionaries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">basic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Find the last image color space configurations that meets given criteria.</p>
<p>Args:
    concomp_nb (int): A tuple of two integers representing the minimum and maximum number of connected components.
    total_surfarea (int): The total surface area required for the image.
    max_shape_size (int): The maximum shape size allowed in the image.
    arenas_mask (NDArray, optional): A numpy array representing areas inside the field of interest.
    ref_image (NDArray, optional): A reference image for comparison.
    subtract_background (NDArray, optional): A numpy array representing the background to be subtracted.
    kmeans_clust_nb (int, optional): The number of clusters for k-means clustering.
    biomask (NDArray[np.uint8], optional): A binary mask for biological structures.
    backmask (NDArray[np.uint8], optional): A binary mask for background areas.
    color_space_dictionaries (dict, optional): Dictionaries of color space configurations.
    basic (bool, optional): A flag indicating whether to process colorspaces basic.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/cellects/core/one_image_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-644">644</a></span>
<span class="normal"><a href="#__codelineno-0-645">645</a></span>
<span class="normal"><a href="#__codelineno-0-646">646</a></span>
<span class="normal"><a href="#__codelineno-0-647">647</a></span>
<span class="normal"><a href="#__codelineno-0-648">648</a></span>
<span class="normal"><a href="#__codelineno-0-649">649</a></span>
<span class="normal"><a href="#__codelineno-0-650">650</a></span>
<span class="normal"><a href="#__codelineno-0-651">651</a></span>
<span class="normal"><a href="#__codelineno-0-652">652</a></span>
<span class="normal"><a href="#__codelineno-0-653">653</a></span>
<span class="normal"><a href="#__codelineno-0-654">654</a></span>
<span class="normal"><a href="#__codelineno-0-655">655</a></span>
<span class="normal"><a href="#__codelineno-0-656">656</a></span>
<span class="normal"><a href="#__codelineno-0-657">657</a></span>
<span class="normal"><a href="#__codelineno-0-658">658</a></span>
<span class="normal"><a href="#__codelineno-0-659">659</a></span>
<span class="normal"><a href="#__codelineno-0-660">660</a></span>
<span class="normal"><a href="#__codelineno-0-661">661</a></span>
<span class="normal"><a href="#__codelineno-0-662">662</a></span>
<span class="normal"><a href="#__codelineno-0-663">663</a></span>
<span class="normal"><a href="#__codelineno-0-664">664</a></span>
<span class="normal"><a href="#__codelineno-0-665">665</a></span>
<span class="normal"><a href="#__codelineno-0-666">666</a></span>
<span class="normal"><a href="#__codelineno-0-667">667</a></span>
<span class="normal"><a href="#__codelineno-0-668">668</a></span>
<span class="normal"><a href="#__codelineno-0-669">669</a></span>
<span class="normal"><a href="#__codelineno-0-670">670</a></span>
<span class="normal"><a href="#__codelineno-0-671">671</a></span>
<span class="normal"><a href="#__codelineno-0-672">672</a></span>
<span class="normal"><a href="#__codelineno-0-673">673</a></span>
<span class="normal"><a href="#__codelineno-0-674">674</a></span>
<span class="normal"><a href="#__codelineno-0-675">675</a></span>
<span class="normal"><a href="#__codelineno-0-676">676</a></span>
<span class="normal"><a href="#__codelineno-0-677">677</a></span>
<span class="normal"><a href="#__codelineno-0-678">678</a></span>
<span class="normal"><a href="#__codelineno-0-679">679</a></span>
<span class="normal"><a href="#__codelineno-0-680">680</a></span>
<span class="normal"><a href="#__codelineno-0-681">681</a></span>
<span class="normal"><a href="#__codelineno-0-682">682</a></span>
<span class="normal"><a href="#__codelineno-0-683">683</a></span>
<span class="normal"><a href="#__codelineno-0-684">684</a></span>
<span class="normal"><a href="#__codelineno-0-685">685</a></span>
<span class="normal"><a href="#__codelineno-0-686">686</a></span>
<span class="normal"><a href="#__codelineno-0-687">687</a></span>
<span class="normal"><a href="#__codelineno-0-688">688</a></span>
<span class="normal"><a href="#__codelineno-0-689">689</a></span>
<span class="normal"><a href="#__codelineno-0-690">690</a></span>
<span class="normal"><a href="#__codelineno-0-691">691</a></span>
<span class="normal"><a href="#__codelineno-0-692">692</a></span>
<span class="normal"><a href="#__codelineno-0-693">693</a></span>
<span class="normal"><a href="#__codelineno-0-694">694</a></span>
<span class="normal"><a href="#__codelineno-0-695">695</a></span>
<span class="normal"><a href="#__codelineno-0-696">696</a></span>
<span class="normal"><a href="#__codelineno-0-697">697</a></span>
<span class="normal"><a href="#__codelineno-0-698">698</a></span>
<span class="normal"><a href="#__codelineno-0-699">699</a></span>
<span class="normal"><a href="#__codelineno-0-700">700</a></span>
<span class="normal"><a href="#__codelineno-0-701">701</a></span>
<span class="normal"><a href="#__codelineno-0-702">702</a></span>
<span class="normal"><a href="#__codelineno-0-703">703</a></span>
<span class="normal"><a href="#__codelineno-0-704">704</a></span>
<span class="normal"><a href="#__codelineno-0-705">705</a></span>
<span class="normal"><a href="#__codelineno-0-706">706</a></span>
<span class="normal"><a href="#__codelineno-0-707">707</a></span>
<span class="normal"><a href="#__codelineno-0-708">708</a></span>
<span class="normal"><a href="#__codelineno-0-709">709</a></span>
<span class="normal"><a href="#__codelineno-0-710">710</a></span>
<span class="normal"><a href="#__codelineno-0-711">711</a></span>
<span class="normal"><a href="#__codelineno-0-712">712</a></span>
<span class="normal"><a href="#__codelineno-0-713">713</a></span>
<span class="normal"><a href="#__codelineno-0-714">714</a></span>
<span class="normal"><a href="#__codelineno-0-715">715</a></span>
<span class="normal"><a href="#__codelineno-0-716">716</a></span>
<span class="normal"><a href="#__codelineno-0-717">717</a></span>
<span class="normal"><a href="#__codelineno-0-718">718</a></span>
<span class="normal"><a href="#__codelineno-0-719">719</a></span>
<span class="normal"><a href="#__codelineno-0-720">720</a></span>
<span class="normal"><a href="#__codelineno-0-721">721</a></span>
<span class="normal"><a href="#__codelineno-0-722">722</a></span>
<span class="normal"><a href="#__codelineno-0-723">723</a></span>
<span class="normal"><a href="#__codelineno-0-724">724</a></span>
<span class="normal"><a href="#__codelineno-0-725">725</a></span>
<span class="normal"><a href="#__codelineno-0-726">726</a></span>
<span class="normal"><a href="#__codelineno-0-727">727</a></span>
<span class="normal"><a href="#__codelineno-0-728">728</a></span>
<span class="normal"><a href="#__codelineno-0-729">729</a></span>
<span class="normal"><a href="#__codelineno-0-730">730</a></span>
<span class="normal"><a href="#__codelineno-0-731">731</a></span>
<span class="normal"><a href="#__codelineno-0-732">732</a></span>
<span class="normal"><a href="#__codelineno-0-733">733</a></span>
<span class="normal"><a href="#__codelineno-0-734">734</a></span>
<span class="normal"><a href="#__codelineno-0-735">735</a></span>
<span class="normal"><a href="#__codelineno-0-736">736</a></span>
<span class="normal"><a href="#__codelineno-0-737">737</a></span>
<span class="normal"><a href="#__codelineno-0-738">738</a></span>
<span class="normal"><a href="#__codelineno-0-739">739</a></span>
<span class="normal"><a href="#__codelineno-0-740">740</a></span>
<span class="normal"><a href="#__codelineno-0-741">741</a></span>
<span class="normal"><a href="#__codelineno-0-742">742</a></span>
<span class="normal"><a href="#__codelineno-0-743">743</a></span>
<span class="normal"><a href="#__codelineno-0-744">744</a></span>
<span class="normal"><a href="#__codelineno-0-745">745</a></span>
<span class="normal"><a href="#__codelineno-0-746">746</a></span>
<span class="normal"><a href="#__codelineno-0-747">747</a></span>
<span class="normal"><a href="#__codelineno-0-748">748</a></span>
<span class="normal"><a href="#__codelineno-0-749">749</a></span>
<span class="normal"><a href="#__codelineno-0-750">750</a></span>
<span class="normal"><a href="#__codelineno-0-751">751</a></span>
<span class="normal"><a href="#__codelineno-0-752">752</a></span>
<span class="normal"><a href="#__codelineno-0-753">753</a></span>
<span class="normal"><a href="#__codelineno-0-754">754</a></span>
<span class="normal"><a href="#__codelineno-0-755">755</a></span>
<span class="normal"><a href="#__codelineno-0-756">756</a></span>
<span class="normal"><a href="#__codelineno-0-757">757</a></span>
<span class="normal"><a href="#__codelineno-0-758">758</a></span>
<span class="normal"><a href="#__codelineno-0-759">759</a></span>
<span class="normal"><a href="#__codelineno-0-760">760</a></span>
<span class="normal"><a href="#__codelineno-0-761">761</a></span>
<span class="normal"><a href="#__codelineno-0-762">762</a></span>
<span class="normal"><a href="#__codelineno-0-763">763</a></span>
<span class="normal"><a href="#__codelineno-0-764">764</a></span>
<span class="normal"><a href="#__codelineno-0-765">765</a></span>
<span class="normal"><a href="#__codelineno-0-766">766</a></span>
<span class="normal"><a href="#__codelineno-0-767">767</a></span>
<span class="normal"><a href="#__codelineno-0-768">768</a></span>
<span class="normal"><a href="#__codelineno-0-769">769</a></span>
<span class="normal"><a href="#__codelineno-0-770">770</a></span>
<span class="normal"><a href="#__codelineno-0-771">771</a></span>
<span class="normal"><a href="#__codelineno-0-772">772</a></span>
<span class="normal"><a href="#__codelineno-0-773">773</a></span>
<span class="normal"><a href="#__codelineno-0-774">774</a></span>
<span class="normal"><a href="#__codelineno-0-775">775</a></span>
<span class="normal"><a href="#__codelineno-0-776">776</a></span>
<span class="normal"><a href="#__codelineno-0-777">777</a></span>
<span class="normal"><a href="#__codelineno-0-778">778</a></span>
<span class="normal"><a href="#__codelineno-0-779">779</a></span>
<span class="normal"><a href="#__codelineno-0-780">780</a></span>
<span class="normal"><a href="#__codelineno-0-781">781</a></span>
<span class="normal"><a href="#__codelineno-0-782">782</a></span>
<span class="normal"><a href="#__codelineno-0-783">783</a></span>
<span class="normal"><a href="#__codelineno-0-784">784</a></span>
<span class="normal"><a href="#__codelineno-0-785">785</a></span>
<span class="normal"><a href="#__codelineno-0-786">786</a></span>
<span class="normal"><a href="#__codelineno-0-787">787</a></span>
<span class="normal"><a href="#__codelineno-0-788">788</a></span>
<span class="normal"><a href="#__codelineno-0-789">789</a></span>
<span class="normal"><a href="#__codelineno-0-790">790</a></span>
<span class="normal"><a href="#__codelineno-0-791">791</a></span>
<span class="normal"><a href="#__codelineno-0-792">792</a></span>
<span class="normal"><a href="#__codelineno-0-793">793</a></span>
<span class="normal"><a href="#__codelineno-0-794">794</a></span>
<span class="normal"><a href="#__codelineno-0-795">795</a></span>
<span class="normal"><a href="#__codelineno-0-796">796</a></span>
<span class="normal"><a href="#__codelineno-0-797">797</a></span>
<span class="normal"><a href="#__codelineno-0-798">798</a></span>
<span class="normal"><a href="#__codelineno-0-799">799</a></span>
<span class="normal"><a href="#__codelineno-0-800">800</a></span>
<span class="normal"><a href="#__codelineno-0-801">801</a></span>
<span class="normal"><a href="#__codelineno-0-802">802</a></span>
<span class="normal"><a href="#__codelineno-0-803">803</a></span>
<span class="normal"><a href="#__codelineno-0-804">804</a></span>
<span class="normal"><a href="#__codelineno-0-805">805</a></span>
<span class="normal"><a href="#__codelineno-0-806">806</a></span>
<span class="normal"><a href="#__codelineno-0-807">807</a></span>
<span class="normal"><a href="#__codelineno-0-808">808</a></span>
<span class="normal"><a href="#__codelineno-0-809">809</a></span>
<span class="normal"><a href="#__codelineno-0-810">810</a></span>
<span class="normal"><a href="#__codelineno-0-811">811</a></span>
<span class="normal"><a href="#__codelineno-0-812">812</a></span>
<span class="normal"><a href="#__codelineno-0-813">813</a></span>
<span class="normal"><a href="#__codelineno-0-814">814</a></span>
<span class="normal"><a href="#__codelineno-0-815">815</a></span>
<span class="normal"><a href="#__codelineno-0-816">816</a></span>
<span class="normal"><a href="#__codelineno-0-817">817</a></span>
<span class="normal"><a href="#__codelineno-0-818">818</a></span>
<span class="normal"><a href="#__codelineno-0-819">819</a></span>
<span class="normal"><a href="#__codelineno-0-820">820</a></span>
<span class="normal"><a href="#__codelineno-0-821">821</a></span>
<span class="normal"><a href="#__codelineno-0-822">822</a></span>
<span class="normal"><a href="#__codelineno-0-823">823</a></span>
<span class="normal"><a href="#__codelineno-0-824">824</a></span>
<span class="normal"><a href="#__codelineno-0-825">825</a></span>
<span class="normal"><a href="#__codelineno-0-826">826</a></span>
<span class="normal"><a href="#__codelineno-0-827">827</a></span>
<span class="normal"><a href="#__codelineno-0-828">828</a></span>
<span class="normal"><a href="#__codelineno-0-829">829</a></span>
<span class="normal"><a href="#__codelineno-0-830">830</a></span>
<span class="normal"><a href="#__codelineno-0-831">831</a></span>
<span class="normal"><a href="#__codelineno-0-832">832</a></span>
<span class="normal"><a href="#__codelineno-0-833">833</a></span>
<span class="normal"><a href="#__codelineno-0-834">834</a></span>
<span class="normal"><a href="#__codelineno-0-835">835</a></span>
<span class="normal"><a href="#__codelineno-0-836">836</a></span>
<span class="normal"><a href="#__codelineno-0-837">837</a></span>
<span class="normal"><a href="#__codelineno-0-838">838</a></span>
<span class="normal"><a href="#__codelineno-0-839">839</a></span>
<span class="normal"><a href="#__codelineno-0-840">840</a></span>
<span class="normal"><a href="#__codelineno-0-841">841</a></span>
<span class="normal"><a href="#__codelineno-0-842">842</a></span>
<span class="normal"><a href="#__codelineno-0-843">843</a></span>
<span class="normal"><a href="#__codelineno-0-844">844</a></span>
<span class="normal"><a href="#__codelineno-0-845">845</a></span>
<span class="normal"><a href="#__codelineno-0-846">846</a></span>
<span class="normal"><a href="#__codelineno-0-847">847</a></span>
<span class="normal"><a href="#__codelineno-0-848">848</a></span>
<span class="normal"><a href="#__codelineno-0-849">849</a></span>
<span class="normal"><a href="#__codelineno-0-850">850</a></span>
<span class="normal"><a href="#__codelineno-0-851">851</a></span>
<span class="normal"><a href="#__codelineno-0-852">852</a></span>
<span class="normal"><a href="#__codelineno-0-853">853</a></span>
<span class="normal"><a href="#__codelineno-0-854">854</a></span>
<span class="normal"><a href="#__codelineno-0-855">855</a></span>
<span class="normal"><a href="#__codelineno-0-856">856</a></span>
<span class="normal"><a href="#__codelineno-0-857">857</a></span>
<span class="normal"><a href="#__codelineno-0-858">858</a></span>
<span class="normal"><a href="#__codelineno-0-859">859</a></span>
<span class="normal"><a href="#__codelineno-0-860">860</a></span>
<span class="normal"><a href="#__codelineno-0-861">861</a></span>
<span class="normal"><a href="#__codelineno-0-862">862</a></span>
<span class="normal"><a href="#__codelineno-0-863">863</a></span>
<span class="normal"><a href="#__codelineno-0-864">864</a></span>
<span class="normal"><a href="#__codelineno-0-865">865</a></span>
<span class="normal"><a href="#__codelineno-0-866">866</a></span>
<span class="normal"><a href="#__codelineno-0-867">867</a></span>
<span class="normal"><a href="#__codelineno-0-868">868</a></span>
<span class="normal"><a href="#__codelineno-0-869">869</a></span>
<span class="normal"><a href="#__codelineno-0-870">870</a></span>
<span class="normal"><a href="#__codelineno-0-871">871</a></span>
<span class="normal"><a href="#__codelineno-0-872">872</a></span>
<span class="normal"><a href="#__codelineno-0-873">873</a></span>
<span class="normal"><a href="#__codelineno-0-874">874</a></span>
<span class="normal"><a href="#__codelineno-0-875">875</a></span>
<span class="normal"><a href="#__codelineno-0-876">876</a></span>
<span class="normal"><a href="#__codelineno-0-877">877</a></span>
<span class="normal"><a href="#__codelineno-0-878">878</a></span>
<span class="normal"><a href="#__codelineno-0-879">879</a></span>
<span class="normal"><a href="#__codelineno-0-880">880</a></span>
<span class="normal"><a href="#__codelineno-0-881">881</a></span>
<span class="normal"><a href="#__codelineno-0-882">882</a></span>
<span class="normal"><a href="#__codelineno-0-883">883</a></span>
<span class="normal"><a href="#__codelineno-0-884">884</a></span>
<span class="normal"><a href="#__codelineno-0-885">885</a></span>
<span class="normal"><a href="#__codelineno-0-886">886</a></span>
<span class="normal"><a href="#__codelineno-0-887">887</a></span>
<span class="normal"><a href="#__codelineno-0-888">888</a></span>
<span class="normal"><a href="#__codelineno-0-889">889</a></span>
<span class="normal"><a href="#__codelineno-0-890">890</a></span>
<span class="normal"><a href="#__codelineno-0-891">891</a></span>
<span class="normal"><a href="#__codelineno-0-892">892</a></span>
<span class="normal"><a href="#__codelineno-0-893">893</a></span>
<span class="normal"><a href="#__codelineno-0-894">894</a></span>
<span class="normal"><a href="#__codelineno-0-895">895</a></span>
<span class="normal"><a href="#__codelineno-0-896">896</a></span>
<span class="normal"><a href="#__codelineno-0-897">897</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-644" name="__codelineno-0-644"></a><span class="k">def</span><span class="w"> </span><span class="nf">find_last_im_csc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concomp_nb</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">total_surfarea</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_shape_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">arenas_mask</span><span class="p">:</span> <span class="n">NDArray</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-645" name="__codelineno-0-645"></a>                     <span class="n">ref_image</span><span class="p">:</span> <span class="n">NDArray</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subtract_background</span><span class="p">:</span> <span class="n">NDArray</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kmeans_clust_nb</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-646" name="__codelineno-0-646"></a>                     <span class="n">biomask</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">backmask</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a>                     <span class="n">color_space_dictionaries</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">basic</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a><span class="sd">    Find the last image color space configurations that meets given criteria.</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a><span class="sd">        concomp_nb (int): A tuple of two integers representing the minimum and maximum number of connected components.</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a><span class="sd">        total_surfarea (int): The total surface area required for the image.</span>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a><span class="sd">        max_shape_size (int): The maximum shape size allowed in the image.</span>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a><span class="sd">        arenas_mask (NDArray, optional): A numpy array representing areas inside the field of interest.</span>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a><span class="sd">        ref_image (NDArray, optional): A reference image for comparison.</span>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a><span class="sd">        subtract_background (NDArray, optional): A numpy array representing the background to be subtracted.</span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a><span class="sd">        kmeans_clust_nb (int, optional): The number of clusters for k-means clustering.</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a><span class="sd">        biomask (NDArray[np.uint8], optional): A binary mask for biological structures.</span>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a><span class="sd">        backmask (NDArray[np.uint8], optional): A binary mask for background areas.</span>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a><span class="sd">        color_space_dictionaries (dict, optional): Dictionaries of color space configurations.</span>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a><span class="sd">        basic (bool, optional): A flag indicating whether to process colorspaces basic.</span>
<a id="__codelineno-0-663" name="__codelineno-0-663"></a>
<a id="__codelineno-0-664" name="__codelineno-0-664"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-665" name="__codelineno-0-665"></a>    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Start automatic detection of the last image&quot;</span><span class="p">)</span>
<a id="__codelineno-0-666" name="__codelineno-0-666"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-667" name="__codelineno-0-667"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span> <span class="o">=</span> <span class="n">TList</span><span class="p">()</span>
<a id="__codelineno-0-668" name="__codelineno-0-668"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span> <span class="o">=</span> <span class="n">TList</span><span class="p">()</span>
<a id="__codelineno-0-669" name="__codelineno-0-669"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<a id="__codelineno-0-670" name="__codelineno-0-670"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-671" name="__codelineno-0-671"></a>
<a id="__codelineno-0-672" name="__codelineno-0-672"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<a id="__codelineno-0-673" name="__codelineno-0-673"></a>        <span class="k">if</span> <span class="n">arenas_mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-674" name="__codelineno-0-674"></a>            <span class="n">arenas_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-675" name="__codelineno-0-675"></a>        <span class="n">out_of_arenas</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">arenas_mask</span>
<a id="__codelineno-0-676" name="__codelineno-0-676"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_color_spaces</span><span class="p">()</span>
<a id="__codelineno-0-677" name="__codelineno-0-677"></a>        <span class="k">if</span> <span class="n">color_space_dictionaries</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-678" name="__codelineno-0-678"></a>            <span class="k">if</span> <span class="n">basic</span><span class="p">:</span>
<a id="__codelineno-0-679" name="__codelineno-0-679"></a>                <span class="n">colorspace_list</span> <span class="o">=</span> <span class="n">TList</span><span class="p">((</span><span class="s2">&quot;bgr&quot;</span><span class="p">,</span> <span class="s2">&quot;lab&quot;</span><span class="p">,</span> <span class="s2">&quot;hsv&quot;</span><span class="p">,</span> <span class="s2">&quot;luv&quot;</span><span class="p">,</span> <span class="s2">&quot;hls&quot;</span><span class="p">,</span> <span class="s2">&quot;yuv&quot;</span><span class="p">))</span>
<a id="__codelineno-0-680" name="__codelineno-0-680"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-681" name="__codelineno-0-681"></a>                <span class="n">colorspace_list</span> <span class="o">=</span> <span class="n">TList</span><span class="p">((</span><span class="s2">&quot;lab&quot;</span><span class="p">,</span> <span class="s2">&quot;hsv&quot;</span><span class="p">))</span>
<a id="__codelineno-0-682" name="__codelineno-0-682"></a>            <span class="n">color_space_dictionaries</span> <span class="o">=</span> <span class="n">TList</span><span class="p">()</span>
<a id="__codelineno-0-683" name="__codelineno-0-683"></a>            <span class="n">channels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
<a id="__codelineno-0-684" name="__codelineno-0-684"></a>            <span class="n">csc_dict</span> <span class="o">=</span> <span class="n">TDict</span><span class="p">()</span>
<a id="__codelineno-0-685" name="__codelineno-0-685"></a>            <span class="n">csc_dict</span><span class="p">[</span><span class="s2">&quot;bgr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">channels</span>
<a id="__codelineno-0-686" name="__codelineno-0-686"></a>            <span class="n">color_space_dictionaries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">csc_dict</span><span class="p">)</span>
<a id="__codelineno-0-687" name="__codelineno-0-687"></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c_space</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">colorspace_list</span><span class="p">):</span>
<a id="__codelineno-0-688" name="__codelineno-0-688"></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
<a id="__codelineno-0-689" name="__codelineno-0-689"></a>                    <span class="n">channels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
<a id="__codelineno-0-690" name="__codelineno-0-690"></a>                    <span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-0-691" name="__codelineno-0-691"></a>                    <span class="n">csc_dict</span> <span class="o">=</span> <span class="n">TDict</span><span class="p">()</span>
<a id="__codelineno-0-692" name="__codelineno-0-692"></a>                    <span class="n">csc_dict</span><span class="p">[</span><span class="n">c_space</span><span class="p">]</span> <span class="o">=</span> <span class="n">channels</span>
<a id="__codelineno-0-693" name="__codelineno-0-693"></a>                    <span class="n">color_space_dictionaries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">csc_dict</span><span class="p">)</span>
<a id="__codelineno-0-694" name="__codelineno-0-694"></a>        <span class="k">if</span> <span class="n">ref_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-695" name="__codelineno-0-695"></a>            <span class="n">ref_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">dilate</span><span class="p">(</span><span class="n">ref_image</span><span class="p">,</span> <span class="n">cross_33</span><span class="p">)</span>
<a id="__codelineno-0-696" name="__codelineno-0-696"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-697" name="__codelineno-0-697"></a>            <span class="n">ref_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bgr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-698" name="__codelineno-0-698"></a>        <span class="n">out_of_arenas_threshold</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">out_of_arenas</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-699" name="__codelineno-0-699"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">color_space_dictionaries</span><span class="p">)</span> <span class="o">+</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
<a id="__codelineno-0-700" name="__codelineno-0-700"></a>        <span class="n">cc_nb_idx</span><span class="p">,</span> <span class="n">area_idx</span><span class="p">,</span> <span class="n">out_of_arenas_idx</span><span class="p">,</span> <span class="n">in_arena_idx</span><span class="p">,</span> <span class="n">surf_in_common_idx</span><span class="p">,</span> <span class="n">biosum_idx</span><span class="p">,</span> <span class="n">backsum_idx</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span>
<a id="__codelineno-0-701" name="__codelineno-0-701"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">save_combination_thread</span> <span class="o">=</span> <span class="n">SaveCombinationThread</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-702" name="__codelineno-0-702"></a>
<a id="__codelineno-0-703" name="__codelineno-0-703"></a>        <span class="c1"># Start with a PCA:</span>
<a id="__codelineno-0-704" name="__codelineno-0-704"></a>        <span class="n">pca_dict</span> <span class="o">=</span> <span class="n">TDict</span><span class="p">()</span>
<a id="__codelineno-0-705" name="__codelineno-0-705"></a>        <span class="n">pca_dict</span><span class="p">[</span><span class="s1">&#39;PCA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
<a id="__codelineno-0-706" name="__codelineno-0-706"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">explained_variance_ratio</span><span class="p">,</span> <span class="n">first_pc_vector</span> <span class="o">=</span> <span class="n">extract_first_pc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bgr</span><span class="p">)</span>
<a id="__codelineno-0-707" name="__codelineno-0-707"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">otsu_thresholding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-0-708" name="__codelineno-0-708"></a>        <span class="n">nb</span><span class="p">,</span> <span class="n">shapes</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">connectedComponents</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-709" name="__codelineno-0-709"></a>        <span class="n">nb</span> <span class="o">-=</span> <span class="mi">1</span>
<a id="__codelineno-0-710" name="__codelineno-0-710"></a>        <span class="n">surf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-711" name="__codelineno-0-711"></a>        <span class="n">outside_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">*</span> <span class="n">out_of_arenas</span><span class="p">)</span>
<a id="__codelineno-0-712" name="__codelineno-0-712"></a>        <span class="n">inside_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">*</span> <span class="n">arenas_mask</span><span class="p">)</span>
<a id="__codelineno-0-713" name="__codelineno-0-713"></a>        <span class="n">in_common</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ref_image</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-714" name="__codelineno-0-714"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-0-715" name="__codelineno-0-715"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-716" name="__codelineno-0-716"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pca_dict</span><span class="p">)</span>
<a id="__codelineno-0-717" name="__codelineno-0-717"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pca_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-718" name="__codelineno-0-718"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">cc_nb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">nb</span>
<a id="__codelineno-0-719" name="__codelineno-0-719"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">area_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">surf</span>
<a id="__codelineno-0-720" name="__codelineno-0-720"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">out_of_arenas_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">outside_pixels</span>
<a id="__codelineno-0-721" name="__codelineno-0-721"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">in_arena_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">inside_pixels</span>
<a id="__codelineno-0-722" name="__codelineno-0-722"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">surf_in_common_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_common</span>
<a id="__codelineno-0-723" name="__codelineno-0-723"></a>        <span class="k">if</span> <span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-724" name="__codelineno-0-724"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">biosum_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
<a id="__codelineno-0-725" name="__codelineno-0-725"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">[</span><span class="n">biomask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">biomask</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-726" name="__codelineno-0-726"></a>        <span class="k">if</span> <span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-727" name="__codelineno-0-727"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">backsum_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
<a id="__codelineno-0-728" name="__codelineno-0-728"></a>                <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)[</span><span class="n">backmask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">backmask</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-729" name="__codelineno-0-729"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-730" name="__codelineno-0-730"></a>
<a id="__codelineno-0-731" name="__codelineno-0-731"></a>        <span class="n">potentials</span> <span class="o">=</span> <span class="n">TDict</span><span class="p">()</span>
<a id="__codelineno-0-732" name="__codelineno-0-732"></a>        <span class="c1"># One channel processing</span>
<a id="__codelineno-0-733" name="__codelineno-0-733"></a>        <span class="k">for</span> <span class="n">csc_dict</span> <span class="ow">in</span> <span class="n">color_space_dictionaries</span><span class="p">:</span>
<a id="__codelineno-0-734" name="__codelineno-0-734"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">combine_color_spaces</span><span class="p">(</span><span class="n">csc_dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_c_spaces</span><span class="p">,</span> <span class="n">subtract_background</span><span class="p">)</span>
<a id="__codelineno-0-735" name="__codelineno-0-735"></a>            <span class="k">if</span> <span class="n">kmeans_clust_nb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-736" name="__codelineno-0-736"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bio_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bio_label2</span> <span class="o">=</span> <span class="n">kmeans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image2</span><span class="p">,</span> <span class="n">kmeans_clust_nb</span><span class="p">,</span> <span class="n">biomask</span><span class="p">,</span> <span class="n">backmask</span><span class="p">)</span>
<a id="__codelineno-0-737" name="__codelineno-0-737"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-738" name="__codelineno-0-738"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">otsu_thresholding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-0-739" name="__codelineno-0-739"></a>            <span class="n">surf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-740" name="__codelineno-0-740"></a>            <span class="k">if</span> <span class="n">surf</span> <span class="o">&lt;</span> <span class="n">total_surfarea</span><span class="p">:</span>
<a id="__codelineno-0-741" name="__codelineno-0-741"></a>                <span class="n">nb</span><span class="p">,</span> <span class="n">shapes</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">connectedComponents</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-742" name="__codelineno-0-742"></a>                <span class="n">outside_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">*</span> <span class="n">out_of_arenas</span><span class="p">)</span>
<a id="__codelineno-0-743" name="__codelineno-0-743"></a>                <span class="n">inside_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">*</span> <span class="n">arenas_mask</span><span class="p">)</span>
<a id="__codelineno-0-744" name="__codelineno-0-744"></a>                <span class="k">if</span> <span class="n">outside_pixels</span> <span class="o">&lt;</span> <span class="n">inside_pixels</span><span class="p">:</span>
<a id="__codelineno-0-745" name="__codelineno-0-745"></a>                    <span class="k">if</span> <span class="p">(</span><span class="n">nb</span> <span class="o">&gt;</span> <span class="n">concomp_nb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">nb</span> <span class="o">&lt;</span> <span class="n">concomp_nb</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
<a id="__codelineno-0-746" name="__codelineno-0-746"></a>                        <span class="n">in_common</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ref_image</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-747" name="__codelineno-0-747"></a>                        <span class="k">if</span> <span class="n">in_common</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-748" name="__codelineno-0-748"></a>                            <span class="n">nb</span><span class="p">,</span> <span class="n">shapes</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">centroids</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">connectedComponentsWithStats</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-749" name="__codelineno-0-749"></a>                            <span class="n">nb</span> <span class="o">-=</span> <span class="mi">1</span>
<a id="__codelineno-0-750" name="__codelineno-0-750"></a>                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">stats</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">])[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">max_shape_size</span><span class="p">):</span>
<a id="__codelineno-0-751" name="__codelineno-0-751"></a>                                <span class="n">c_space</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">csc_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-752" name="__codelineno-0-752"></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-0-753" name="__codelineno-0-753"></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-754" name="__codelineno-0-754"></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">csc_dict</span><span class="p">)</span>
<a id="__codelineno-0-755" name="__codelineno-0-755"></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">csc_dict</span><span class="p">[</span><span class="n">c_space</span><span class="p">]</span>
<a id="__codelineno-0-756" name="__codelineno-0-756"></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">cc_nb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">nb</span>
<a id="__codelineno-0-757" name="__codelineno-0-757"></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">area_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">surf</span>
<a id="__codelineno-0-758" name="__codelineno-0-758"></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">out_of_arenas_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">outside_pixels</span>
<a id="__codelineno-0-759" name="__codelineno-0-759"></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">in_arena_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">inside_pixels</span>
<a id="__codelineno-0-760" name="__codelineno-0-760"></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">surf_in_common_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_common</span>
<a id="__codelineno-0-761" name="__codelineno-0-761"></a>                                <span class="k">if</span> <span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-762" name="__codelineno-0-762"></a>                                    <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">biosum_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
<a id="__codelineno-0-763" name="__codelineno-0-763"></a>                                        <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">[</span><span class="n">biomask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">biomask</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-764" name="__codelineno-0-764"></a>                                <span class="k">if</span> <span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-765" name="__codelineno-0-765"></a>                                    <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">backsum_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
<a id="__codelineno-0-766" name="__codelineno-0-766"></a>                                        <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)[</span><span class="n">backmask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">backmask</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-767" name="__codelineno-0-767"></a>                                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">c_space</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">potentials</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
<a id="__codelineno-0-768" name="__codelineno-0-768"></a>                                    <span class="n">potentials</span><span class="p">[</span><span class="n">c_space</span><span class="p">]</span> <span class="o">+=</span> <span class="n">csc_dict</span><span class="p">[</span><span class="n">c_space</span><span class="p">]</span>
<a id="__codelineno-0-769" name="__codelineno-0-769"></a>                                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-770" name="__codelineno-0-770"></a>                                    <span class="n">potentials</span><span class="p">[</span><span class="n">c_space</span><span class="p">]</span> <span class="o">=</span> <span class="n">csc_dict</span><span class="p">[</span><span class="n">c_space</span><span class="p">]</span>
<a id="__codelineno-0-771" name="__codelineno-0-771"></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-772" name="__codelineno-0-772"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">potentials</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-773" name="__codelineno-0-773"></a>            <span class="c1"># All combination processing</span>
<a id="__codelineno-0-774" name="__codelineno-0-774"></a>
<a id="__codelineno-0-775" name="__codelineno-0-775"></a>            <span class="c1"># Add a combination of all selected channels :</span>
<a id="__codelineno-0-776" name="__codelineno-0-776"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">potentials</span><span class="p">)</span>
<a id="__codelineno-0-777" name="__codelineno-0-777"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">combine_color_spaces</span><span class="p">(</span><span class="n">potentials</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_c_spaces</span><span class="p">,</span> <span class="n">subtract_background</span><span class="p">)</span>
<a id="__codelineno-0-778" name="__codelineno-0-778"></a>            <span class="k">if</span> <span class="n">kmeans_clust_nb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-779" name="__codelineno-0-779"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bio_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bio_label2</span> <span class="o">=</span> <span class="n">kmeans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">kmeans_clust_nb</span><span class="o">=</span><span class="n">kmeans_clust_nb</span><span class="p">,</span> <span class="n">biomask</span><span class="o">=</span><span class="n">biomask</span><span class="p">,</span> <span class="n">backmask</span><span class="o">=</span><span class="n">backmask</span><span class="p">)</span>
<a id="__codelineno-0-780" name="__codelineno-0-780"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-781" name="__codelineno-0-781"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">otsu_thresholding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-0-782" name="__codelineno-0-782"></a>            <span class="n">surf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-783" name="__codelineno-0-783"></a>            <span class="n">nb</span><span class="p">,</span> <span class="n">shapes</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">connectedComponents</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-784" name="__codelineno-0-784"></a>            <span class="n">nb</span> <span class="o">-=</span> <span class="mi">1</span>
<a id="__codelineno-0-785" name="__codelineno-0-785"></a>            <span class="n">outside_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">*</span> <span class="n">out_of_arenas</span><span class="p">)</span>
<a id="__codelineno-0-786" name="__codelineno-0-786"></a>            <span class="n">inside_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">*</span> <span class="n">arenas_mask</span><span class="p">)</span>
<a id="__codelineno-0-787" name="__codelineno-0-787"></a>            <span class="n">in_common</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ref_image</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-788" name="__codelineno-0-788"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-0-789" name="__codelineno-0-789"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-790" name="__codelineno-0-790"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">potentials</span><span class="p">)</span>
<a id="__codelineno-0-791" name="__codelineno-0-791"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">potentials</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-792" name="__codelineno-0-792"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">cc_nb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">nb</span>
<a id="__codelineno-0-793" name="__codelineno-0-793"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">area_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">surf</span>
<a id="__codelineno-0-794" name="__codelineno-0-794"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">out_of_arenas_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">outside_pixels</span>
<a id="__codelineno-0-795" name="__codelineno-0-795"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">in_arena_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">inside_pixels</span>
<a id="__codelineno-0-796" name="__codelineno-0-796"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">surf_in_common_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_common</span>
<a id="__codelineno-0-797" name="__codelineno-0-797"></a>            <span class="k">if</span> <span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-798" name="__codelineno-0-798"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">biosum_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
<a id="__codelineno-0-799" name="__codelineno-0-799"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">[</span><span class="n">biomask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">biomask</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-800" name="__codelineno-0-800"></a>            <span class="k">if</span> <span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-801" name="__codelineno-0-801"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">backsum_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
<a id="__codelineno-0-802" name="__codelineno-0-802"></a>                    <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)[</span><span class="n">backmask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">backmask</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-803" name="__codelineno-0-803"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-804" name="__codelineno-0-804"></a>        <span class="c1"># All combination processing</span>
<a id="__codelineno-0-805" name="__codelineno-0-805"></a>        <span class="c1"># Try to remove color space one by one</span>
<a id="__codelineno-0-806" name="__codelineno-0-806"></a>        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-807" name="__codelineno-0-807"></a>        <span class="n">original_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">potentials</span><span class="p">)</span>
<a id="__codelineno-0-808" name="__codelineno-0-808"></a>        <span class="k">while</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">potentials</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">original_length</span> <span class="o">//</span> <span class="mi">2</span><span class="p">):</span>
<a id="__codelineno-0-809" name="__codelineno-0-809"></a>            <span class="n">color_space_to_remove</span> <span class="o">=</span> <span class="n">TList</span><span class="p">()</span>
<a id="__codelineno-0-810" name="__codelineno-0-810"></a>            <span class="c1"># The while loop until one col space remains or the removal of one implies a strong enough area change</span>
<a id="__codelineno-0-811" name="__codelineno-0-811"></a>            <span class="n">previous_c_space</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">potentials</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-812" name="__codelineno-0-812"></a>            <span class="k">for</span> <span class="n">c_space</span> <span class="ow">in</span> <span class="n">potentials</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-813" name="__codelineno-0-813"></a>                <span class="n">try_potentials</span> <span class="o">=</span> <span class="n">potentials</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-814" name="__codelineno-0-814"></a>                <span class="n">try_potentials</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">c_space</span><span class="p">)</span>
<a id="__codelineno-0-815" name="__codelineno-0-815"></a>                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-816" name="__codelineno-0-816"></a>                    <span class="n">try_potentials</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">previous_c_space</span><span class="p">)</span>
<a id="__codelineno-0-817" name="__codelineno-0-817"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">combine_color_spaces</span><span class="p">(</span><span class="n">try_potentials</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_c_spaces</span><span class="p">,</span> <span class="n">subtract_background</span><span class="p">)</span>
<a id="__codelineno-0-818" name="__codelineno-0-818"></a>                <span class="k">if</span> <span class="n">kmeans_clust_nb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-819" name="__codelineno-0-819"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bio_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bio_label2</span>  <span class="o">=</span> <span class="n">kmeans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">kmeans_clust_nb</span><span class="o">=</span><span class="n">kmeans_clust_nb</span><span class="p">,</span> <span class="n">biomask</span><span class="o">=</span><span class="n">biomask</span><span class="p">,</span> <span class="n">backmask</span><span class="o">=</span><span class="n">backmask</span><span class="p">)</span>
<a id="__codelineno-0-820" name="__codelineno-0-820"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-821" name="__codelineno-0-821"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">otsu_thresholding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-0-822" name="__codelineno-0-822"></a>                <span class="n">surf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-823" name="__codelineno-0-823"></a>                <span class="k">if</span> <span class="n">surf</span> <span class="o">&lt;</span> <span class="n">total_surfarea</span><span class="p">:</span>
<a id="__codelineno-0-824" name="__codelineno-0-824"></a>                    <span class="n">nb</span><span class="p">,</span> <span class="n">shapes</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">connectedComponents</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-825" name="__codelineno-0-825"></a>                    <span class="n">outside_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">*</span> <span class="n">out_of_arenas</span><span class="p">)</span>
<a id="__codelineno-0-826" name="__codelineno-0-826"></a>                    <span class="n">inside_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">*</span> <span class="n">arenas_mask</span><span class="p">)</span>
<a id="__codelineno-0-827" name="__codelineno-0-827"></a>                    <span class="k">if</span> <span class="n">outside_pixels</span> <span class="o">&lt;</span> <span class="n">inside_pixels</span><span class="p">:</span>
<a id="__codelineno-0-828" name="__codelineno-0-828"></a>                        <span class="k">if</span> <span class="p">(</span><span class="n">nb</span> <span class="o">&gt;</span> <span class="n">concomp_nb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">nb</span> <span class="o">&lt;</span> <span class="n">concomp_nb</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
<a id="__codelineno-0-829" name="__codelineno-0-829"></a>                            <span class="n">in_common</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ref_image</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-830" name="__codelineno-0-830"></a>                            <span class="k">if</span> <span class="n">in_common</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-831" name="__codelineno-0-831"></a>                                <span class="n">nb</span><span class="p">,</span> <span class="n">shapes</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">centroids</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">connectedComponentsWithStats</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-832" name="__codelineno-0-832"></a>                                <span class="n">nb</span> <span class="o">-=</span> <span class="mi">1</span>
<a id="__codelineno-0-833" name="__codelineno-0-833"></a>                                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">stats</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">])[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">max_shape_size</span><span class="p">):</span>
<a id="__codelineno-0-834" name="__codelineno-0-834"></a>                                    <span class="c1"># If a color space remove fits in the requirements, we store its values</span>
<a id="__codelineno-0-835" name="__codelineno-0-835"></a>                                    <span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-0-836" name="__codelineno-0-836"></a>                                    <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-837" name="__codelineno-0-837"></a>                                    <span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">try_potentials</span><span class="p">)</span>
<a id="__codelineno-0-838" name="__codelineno-0-838"></a>                                    <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">cc_nb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">nb</span>
<a id="__codelineno-0-839" name="__codelineno-0-839"></a>                                    <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">area_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">surf</span>
<a id="__codelineno-0-840" name="__codelineno-0-840"></a>                                    <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">out_of_arenas_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">outside_pixels</span>
<a id="__codelineno-0-841" name="__codelineno-0-841"></a>                                    <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">in_arena_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">inside_pixels</span>
<a id="__codelineno-0-842" name="__codelineno-0-842"></a>                                    <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">surf_in_common_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_common</span>
<a id="__codelineno-0-843" name="__codelineno-0-843"></a>                                    <span class="k">if</span> <span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-844" name="__codelineno-0-844"></a>                                        <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">biosum_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
<a id="__codelineno-0-845" name="__codelineno-0-845"></a>                                            <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">[</span><span class="n">biomask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">biomask</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-846" name="__codelineno-0-846"></a>                                    <span class="k">if</span> <span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-847" name="__codelineno-0-847"></a>                                        <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">backsum_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
<a id="__codelineno-0-848" name="__codelineno-0-848"></a>                                            <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)[</span><span class="n">backmask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">backmask</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-849" name="__codelineno-0-849"></a>                                    <span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-850" name="__codelineno-0-850"></a>                                    <span class="n">color_space_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_space</span><span class="p">)</span>
<a id="__codelineno-0-851" name="__codelineno-0-851"></a>                                    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-852" name="__codelineno-0-852"></a>                                        <span class="n">color_space_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">previous_c_space</span><span class="p">)</span>
<a id="__codelineno-0-853" name="__codelineno-0-853"></a>                <span class="c1"># If it does not (if it did not pass every &quot;if&quot; layers), we definitely remove that color space</span>
<a id="__codelineno-0-854" name="__codelineno-0-854"></a>                <span class="n">previous_c_space</span> <span class="o">=</span> <span class="n">c_space</span>
<a id="__codelineno-0-855" name="__codelineno-0-855"></a>            <span class="n">color_space_to_remove</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">color_space_to_remove</span><span class="p">)</span>
<a id="__codelineno-0-856" name="__codelineno-0-856"></a>            <span class="k">for</span> <span class="n">remove_col_space</span> <span class="ow">in</span> <span class="n">color_space_to_remove</span><span class="p">:</span>
<a id="__codelineno-0-857" name="__codelineno-0-857"></a>                <span class="n">potentials</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">remove_col_space</span><span class="p">)</span>
<a id="__codelineno-0-858" name="__codelineno-0-858"></a>            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-859" name="__codelineno-0-859"></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">potentials</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-0-860" name="__codelineno-0-860"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-0-861" name="__codelineno-0-861"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)</span>
<a id="__codelineno-0-862" name="__codelineno-0-862"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">potentials</span><span class="p">)</span>
<a id="__codelineno-0-863" name="__codelineno-0-863"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">potentials</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-864" name="__codelineno-0-864"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">cc_nb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">nb</span>
<a id="__codelineno-0-865" name="__codelineno-0-865"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">area_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">surf</span>
<a id="__codelineno-0-866" name="__codelineno-0-866"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">out_of_arenas_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">outside_pixels</span>
<a id="__codelineno-0-867" name="__codelineno-0-867"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">in_arena_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">inside_pixels</span>
<a id="__codelineno-0-868" name="__codelineno-0-868"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">surf_in_common_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_common</span>
<a id="__codelineno-0-869" name="__codelineno-0-869"></a>            <span class="k">if</span> <span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-870" name="__codelineno-0-870"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">biosum_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
<a id="__codelineno-0-871" name="__codelineno-0-871"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">[</span><span class="n">biomask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">biomask</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-872" name="__codelineno-0-872"></a>            <span class="k">if</span> <span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-873" name="__codelineno-0-873"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="n">backsum_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
<a id="__codelineno-0-874" name="__codelineno-0-874"></a>                    <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">)[</span><span class="n">backmask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">backmask</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-875" name="__codelineno-0-875"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-876" name="__codelineno-0-876"></a>
<a id="__codelineno-0-877" name="__codelineno-0-877"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="p">:]</span>
<a id="__codelineno-0-878" name="__codelineno-0-878"></a>        <span class="c1"># Among all potentials, select the best one, according to criterion decreasing in importance</span>
<a id="__codelineno-0-879" name="__codelineno-0-879"></a>        <span class="n">cc_efficiency_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:,</span> <span class="n">surf_in_common_idx</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:,</span> <span class="n">in_arena_idx</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[:,</span> <span class="n">out_of_arenas_idx</span><span class="p">])</span>
<a id="__codelineno-0-880" name="__codelineno-0-880"></a>
<a id="__codelineno-0-881" name="__codelineno-0-881"></a>        <span class="c1"># Save and return a dictionnary containing the selected color space combinations</span>
<a id="__codelineno-0-882" name="__codelineno-0-882"></a>        <span class="c1"># and their corresponding binary images</span>
<a id="__codelineno-0-883" name="__codelineno-0-883"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-884" name="__codelineno-0-884"></a>        <span class="k">for</span> <span class="n">saved_csc</span> <span class="ow">in</span> <span class="n">cc_efficiency_order</span><span class="p">:</span>
<a id="__codelineno-0-885" name="__codelineno-0-885"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="p">[</span><span class="n">saved_csc</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-886" name="__codelineno-0-886"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
<a id="__codelineno-0-887" name="__codelineno-0-887"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;csc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-888" name="__codelineno-0-888"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;csc&quot;</span><span class="p">][</span><span class="s1">&#39;logical&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
<a id="__codelineno-0-889" name="__codelineno-0-889"></a>                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="p">[</span><span class="n">saved_csc</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-890" name="__codelineno-0-890"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;csc&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
<a id="__codelineno-0-891" name="__codelineno-0-891"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;binary_image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="p">[</span><span class="n">saved_csc</span><span class="p">]</span>
<a id="__codelineno-0-892" name="__codelineno-0-892"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;converted_image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span><span class="p">[</span>
<a id="__codelineno-0-893" name="__codelineno-0-893"></a>                    <span class="n">saved_csc</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-894" name="__codelineno-0-894"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-895" name="__codelineno-0-895"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-896" name="__codelineno-0-896"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-897" name="__codelineno-0-897"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cellects.core.one_image_analysis.OneImageAnalysis.generate_subtract_background" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_subtract_background</span><span class="p">(</span><span class="n">c_space_dict</span><span class="p">,</span> <span class="n">drift_corrected</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Generate a background-subtracted image using specified color space dictionary.</p>
<p>This method first checks if color spaces have already been generated or
if the image is greyscale. If not, it generates color spaces from the BGR
image. It then converts and segments the image using the provided color space
dictionary without grid segmentation. A disk-shaped structuring element is
created and used to perform a morphological opening operation on the image,
resulting in a background-subtracted version. If there is a second image
(see Also: image2), the same operation is performed on it.</p>
<p>Args:
    c_space_dict (dict): Dictionary containing color space specifications
        for the segmentation process.</p>
<p>Attributes:
    disk_size: Radius of the disk-shaped structuring element
        used for morphological operations, calculated based on image dimensions.
    subtract_background: Background-subtracted version of <code>image</code> obtained
        after morphological operations with the disk-shaped structuring element.
    subtract_background2: Background-subtracted version of <code>image2</code> obtained
        after morphological operations with the disk-shaped structuring element,
        if <code>image2</code> is present.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/cellects/core/one_image_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-220" name="__codelineno-0-220"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_subtract_background</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c_space_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">drift_corrected</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a><span class="sd">    Generate a background-subtracted image using specified color space dictionary.</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a><span class="sd">    This method first checks if color spaces have already been generated or</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a><span class="sd">    if the image is greyscale. If not, it generates color spaces from the BGR</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a><span class="sd">    image. It then converts and segments the image using the provided color space</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a><span class="sd">    dictionary without grid segmentation. A disk-shaped structuring element is</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a><span class="sd">    created and used to perform a morphological opening operation on the image,</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a><span class="sd">    resulting in a background-subtracted version. If there is a second image</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a><span class="sd">    (see Also: image2), the same operation is performed on it.</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a><span class="sd">        c_space_dict (dict): Dictionary containing color space specifications</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a><span class="sd">            for the segmentation process.</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a><span class="sd">    Attributes:</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a><span class="sd">        disk_size: Radius of the disk-shaped structuring element</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a><span class="sd">            used for morphological operations, calculated based on image dimensions.</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a><span class="sd">        subtract_background: Background-subtracted version of `image` obtained</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a><span class="sd">            after morphological operations with the disk-shaped structuring element.</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a><span class="sd">        subtract_background2: Background-subtracted version of `image2` obtained</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a><span class="sd">            after morphological operations with the disk-shaped structuring element,</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a><span class="sd">            if `image2` is present.&quot;&quot;&quot;</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generate background using the generate_subtract_background method of OneImageAnalysis class&quot;</span><span class="p">)</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_color_spaces</span><span class="p">()</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>    <span class="k">if</span> <span class="n">drift_corrected</span><span class="p">:</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>        <span class="c1"># self.adjust_to_drift_correction(c_space_dict[&#39;logical&#39;])</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">check_if_image_border_attest_drift_correction</span><span class="p">()</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">convert_and_segment</span><span class="p">(</span><span class="n">c_space_dict</span><span class="p">,</span> <span class="n">rolling_window_segmentation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allowed_window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">drift_mask_coord</span><span class="p">)</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>    <span class="n">disk_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bgr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))))</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>    <span class="n">disk</span> <span class="o">=</span> <span class="n">create_ellipse</span><span class="p">(</span><span class="n">disk_size</span><span class="p">,</span> <span class="n">disk_size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">subtract_background</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">morphologyEx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_OPEN</span><span class="p">,</span> <span class="n">disk</span><span class="p">)</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subtract_background2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">morphologyEx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image2</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_OPEN</span><span class="p">,</span> <span class="n">disk</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cellects.core.one_image_analysis.OneImageAnalysis.get_crop_coordinates" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_crop_coordinates</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Get the crop coordinates for image processing.</p>
<p>This function projects the image on both x and y axes to detect rows
and columns of arenas, calculates the boundaries for cropping,
and determines if the arenas are zigzagged.-</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/cellects/core/one_image_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-952"> 952</a></span>
<span class="normal"><a href="#__codelineno-0-953"> 953</a></span>
<span class="normal"><a href="#__codelineno-0-954"> 954</a></span>
<span class="normal"><a href="#__codelineno-0-955"> 955</a></span>
<span class="normal"><a href="#__codelineno-0-956"> 956</a></span>
<span class="normal"><a href="#__codelineno-0-957"> 957</a></span>
<span class="normal"><a href="#__codelineno-0-958"> 958</a></span>
<span class="normal"><a href="#__codelineno-0-959"> 959</a></span>
<span class="normal"><a href="#__codelineno-0-960"> 960</a></span>
<span class="normal"><a href="#__codelineno-0-961"> 961</a></span>
<span class="normal"><a href="#__codelineno-0-962"> 962</a></span>
<span class="normal"><a href="#__codelineno-0-963"> 963</a></span>
<span class="normal"><a href="#__codelineno-0-964"> 964</a></span>
<span class="normal"><a href="#__codelineno-0-965"> 965</a></span>
<span class="normal"><a href="#__codelineno-0-966"> 966</a></span>
<span class="normal"><a href="#__codelineno-0-967"> 967</a></span>
<span class="normal"><a href="#__codelineno-0-968"> 968</a></span>
<span class="normal"><a href="#__codelineno-0-969"> 969</a></span>
<span class="normal"><a href="#__codelineno-0-970"> 970</a></span>
<span class="normal"><a href="#__codelineno-0-971"> 971</a></span>
<span class="normal"><a href="#__codelineno-0-972"> 972</a></span>
<span class="normal"><a href="#__codelineno-0-973"> 973</a></span>
<span class="normal"><a href="#__codelineno-0-974"> 974</a></span>
<span class="normal"><a href="#__codelineno-0-975"> 975</a></span>
<span class="normal"><a href="#__codelineno-0-976"> 976</a></span>
<span class="normal"><a href="#__codelineno-0-977"> 977</a></span>
<span class="normal"><a href="#__codelineno-0-978"> 978</a></span>
<span class="normal"><a href="#__codelineno-0-979"> 979</a></span>
<span class="normal"><a href="#__codelineno-0-980"> 980</a></span>
<span class="normal"><a href="#__codelineno-0-981"> 981</a></span>
<span class="normal"><a href="#__codelineno-0-982"> 982</a></span>
<span class="normal"><a href="#__codelineno-0-983"> 983</a></span>
<span class="normal"><a href="#__codelineno-0-984"> 984</a></span>
<span class="normal"><a href="#__codelineno-0-985"> 985</a></span>
<span class="normal"><a href="#__codelineno-0-986"> 986</a></span>
<span class="normal"><a href="#__codelineno-0-987"> 987</a></span>
<span class="normal"><a href="#__codelineno-0-988"> 988</a></span>
<span class="normal"><a href="#__codelineno-0-989"> 989</a></span>
<span class="normal"><a href="#__codelineno-0-990"> 990</a></span>
<span class="normal"><a href="#__codelineno-0-991"> 991</a></span>
<span class="normal"><a href="#__codelineno-0-992"> 992</a></span>
<span class="normal"><a href="#__codelineno-0-993"> 993</a></span>
<span class="normal"><a href="#__codelineno-0-994"> 994</a></span>
<span class="normal"><a href="#__codelineno-0-995"> 995</a></span>
<span class="normal"><a href="#__codelineno-0-996"> 996</a></span>
<span class="normal"><a href="#__codelineno-0-997"> 997</a></span>
<span class="normal"><a href="#__codelineno-0-998"> 998</a></span>
<span class="normal"><a href="#__codelineno-0-999"> 999</a></span>
<span class="normal"><a href="#__codelineno-0-1000">1000</a></span>
<span class="normal"><a href="#__codelineno-0-1001">1001</a></span>
<span class="normal"><a href="#__codelineno-0-1002">1002</a></span>
<span class="normal"><a href="#__codelineno-0-1003">1003</a></span>
<span class="normal"><a href="#__codelineno-0-1004">1004</a></span>
<span class="normal"><a href="#__codelineno-0-1005">1005</a></span>
<span class="normal"><a href="#__codelineno-0-1006">1006</a></span>
<span class="normal"><a href="#__codelineno-0-1007">1007</a></span>
<span class="normal"><a href="#__codelineno-0-1008">1008</a></span>
<span class="normal"><a href="#__codelineno-0-1009">1009</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-952" name="__codelineno-0-952"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_crop_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-953" name="__codelineno-0-953"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-954" name="__codelineno-0-954"></a><span class="sd">    Get the crop coordinates for image processing.</span>
<a id="__codelineno-0-955" name="__codelineno-0-955"></a>
<a id="__codelineno-0-956" name="__codelineno-0-956"></a><span class="sd">    This function projects the image on both x and y axes to detect rows</span>
<a id="__codelineno-0-957" name="__codelineno-0-957"></a><span class="sd">    and columns of arenas, calculates the boundaries for cropping,</span>
<a id="__codelineno-0-958" name="__codelineno-0-958"></a><span class="sd">    and determines if the arenas are zigzagged.-</span>
<a id="__codelineno-0-959" name="__codelineno-0-959"></a>
<a id="__codelineno-0-960" name="__codelineno-0-960"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-961" name="__codelineno-0-961"></a>    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Project the image on the y axis to detect rows of arenas&quot;</span><span class="p">)</span>
<a id="__codelineno-0-962" name="__codelineno-0-962"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">y_boundaries</span><span class="p">,</span> <span class="n">y_max_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection_to_get_peaks_boundaries</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-963" name="__codelineno-0-963"></a>    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Project the image on the x axis to detect columns of arenas&quot;</span><span class="p">)</span>
<a id="__codelineno-0-964" name="__codelineno-0-964"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">x_boundaries</span><span class="p">,</span> <span class="n">x_max_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection_to_get_peaks_boundaries</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-965" name="__codelineno-0-965"></a>    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Get crop coordinates using the get_crop_coordinates method of OneImageAnalysis class&quot;</span><span class="p">)</span>
<a id="__codelineno-0-966" name="__codelineno-0-966"></a>    <span class="n">row_number</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_boundaries</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">//</span> <span class="mi">2</span>
<a id="__codelineno-0-967" name="__codelineno-0-967"></a>    <span class="n">col_number</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_boundaries</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">//</span> <span class="mi">2</span>
<a id="__codelineno-0-968" name="__codelineno-0-968"></a>    <span class="n">are_zigzag</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-969" name="__codelineno-0-969"></a>    <span class="k">if</span> <span class="n">col_number</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">row_number</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-970" name="__codelineno-0-970"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">x_max_sum</span> <span class="o">/</span> <span class="n">col_number</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">y_max_sum</span> <span class="o">/</span> <span class="n">row_number</span><span class="p">):</span>
<a id="__codelineno-0-971" name="__codelineno-0-971"></a>            <span class="n">are_zigzag</span> <span class="o">=</span> <span class="s2">&quot;columns&quot;</span>
<a id="__codelineno-0-972" name="__codelineno-0-972"></a>        <span class="k">elif</span> <span class="p">(</span><span class="n">x_max_sum</span> <span class="o">/</span> <span class="n">col_number</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">y_max_sum</span> <span class="o">/</span> <span class="n">row_number</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-0-973" name="__codelineno-0-973"></a>            <span class="n">are_zigzag</span> <span class="o">=</span> <span class="s2">&quot;rows&quot;</span>
<a id="__codelineno-0-974" name="__codelineno-0-974"></a>    <span class="c1"># here automatically determine if are zigzag</span>
<a id="__codelineno-0-975" name="__codelineno-0-975"></a>    <span class="n">x_boundary_number</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_boundaries</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-976" name="__codelineno-0-976"></a>    <span class="k">if</span> <span class="n">x_boundary_number</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-977" name="__codelineno-0-977"></a>        <span class="k">if</span> <span class="n">x_boundary_number</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
<a id="__codelineno-0-978" name="__codelineno-0-978"></a>            <span class="n">x_interval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_boundaries</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])))</span> <span class="o">//</span> <span class="mi">2</span>
<a id="__codelineno-0-979" name="__codelineno-0-979"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-980" name="__codelineno-0-980"></a>            <span class="k">if</span> <span class="n">are_zigzag</span> <span class="o">==</span> <span class="s2">&quot;columns&quot;</span><span class="p">:</span>
<a id="__codelineno-0-981" name="__codelineno-0-981"></a>                <span class="n">x_interval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_boundaries</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][::</span><span class="mi">2</span><span class="p">])))</span> <span class="o">//</span> <span class="mi">2</span>
<a id="__codelineno-0-982" name="__codelineno-0-982"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-983" name="__codelineno-0-983"></a>                <span class="n">x_interval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_boundaries</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])))</span> <span class="o">//</span> <span class="mi">2</span>
<a id="__codelineno-0-984" name="__codelineno-0-984"></a>        <span class="n">cx_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_boundaries</span> <span class="o">==</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_interval</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-0-985" name="__codelineno-0-985"></a>        <span class="n">cx_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_boundaries</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="n">col_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">x_interval</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-0-986" name="__codelineno-0-986"></a>        <span class="k">if</span> <span class="n">cx_min</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">cx_min</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-987" name="__codelineno-0-987"></a>        <span class="k">if</span> <span class="n">cx_max</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_boundaries</span><span class="p">):</span> <span class="n">cx_max</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_boundaries</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
<a id="__codelineno-0-988" name="__codelineno-0-988"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-989" name="__codelineno-0-989"></a>        <span class="n">cx_min</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-990" name="__codelineno-0-990"></a>        <span class="n">cx_max</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_boundaries</span><span class="p">)</span><span class="c1"># - 1</span>
<a id="__codelineno-0-991" name="__codelineno-0-991"></a>
<a id="__codelineno-0-992" name="__codelineno-0-992"></a>    <span class="n">y_boundary_number</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_boundaries</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-993" name="__codelineno-0-993"></a>    <span class="k">if</span> <span class="n">y_boundary_number</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-994" name="__codelineno-0-994"></a>        <span class="k">if</span> <span class="n">y_boundary_number</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
<a id="__codelineno-0-995" name="__codelineno-0-995"></a>            <span class="n">y_interval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_boundaries</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])))</span> <span class="o">//</span> <span class="mi">2</span>
<a id="__codelineno-0-996" name="__codelineno-0-996"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-997" name="__codelineno-0-997"></a>            <span class="k">if</span> <span class="n">are_zigzag</span> <span class="o">==</span> <span class="s2">&quot;rows&quot;</span><span class="p">:</span>
<a id="__codelineno-0-998" name="__codelineno-0-998"></a>                <span class="n">y_interval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_boundaries</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][::</span><span class="mi">2</span><span class="p">])))</span> <span class="o">//</span> <span class="mi">2</span>
<a id="__codelineno-0-999" name="__codelineno-0-999"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1000" name="__codelineno-0-1000"></a>                <span class="n">y_interval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_boundaries</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])))</span> <span class="o">//</span> <span class="mi">2</span>
<a id="__codelineno-0-1001" name="__codelineno-0-1001"></a>        <span class="n">cy_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_boundaries</span> <span class="o">==</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_interval</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-0-1002" name="__codelineno-0-1002"></a>        <span class="n">cy_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_boundaries</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="n">row_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">y_interval</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-0-1003" name="__codelineno-0-1003"></a>        <span class="k">if</span> <span class="n">cy_min</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">cy_min</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-1004" name="__codelineno-0-1004"></a>        <span class="k">if</span> <span class="n">cy_max</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_boundaries</span><span class="p">):</span> <span class="n">cy_max</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_boundaries</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
<a id="__codelineno-0-1005" name="__codelineno-0-1005"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1006" name="__codelineno-0-1006"></a>        <span class="n">cy_min</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-1007" name="__codelineno-0-1007"></a>        <span class="n">cy_max</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_boundaries</span><span class="p">)</span><span class="c1"># - 1</span>
<a id="__codelineno-0-1008" name="__codelineno-0-1008"></a>
<a id="__codelineno-0-1009" name="__codelineno-0-1009"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">crop_coord</span> <span class="o">=</span> <span class="p">[</span><span class="n">cy_min</span><span class="p">,</span> <span class="n">cy_max</span><span class="p">,</span> <span class="n">cx_min</span><span class="p">,</span> <span class="n">cx_max</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cellects.core.one_image_analysis.OneImageAnalysis.network_detection" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">network_detection</span><span class="p">(</span><span class="n">arenas_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pseudopod_min_size</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">csc_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">biomask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">backmask</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Network Detection Function</p>
<p>Perform network detection and pseudopod analysis on an image.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>arenas_mask</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The mask indicating the arena regions in the image.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pseudopod_min_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The minimum size for pseudopods to be detected.</p>
              </div>
            </td>
            <td>
                  <code>50</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>csc_dict</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary containing color space conversion parameters. If None,
defaults to {'bgr': np.array((1, 1, 1), np.int8), 'logical': 'None'}</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>biomask</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The mask for biological objects in the image.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>backmask</code>
            </td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The background mask.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>This function modifies the object's state by setting <code>self.im_combinations</code>
with the results of network detection and pseudopod analysis.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/cellects/core/one_image_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-899">899</a></span>
<span class="normal"><a href="#__codelineno-0-900">900</a></span>
<span class="normal"><a href="#__codelineno-0-901">901</a></span>
<span class="normal"><a href="#__codelineno-0-902">902</a></span>
<span class="normal"><a href="#__codelineno-0-903">903</a></span>
<span class="normal"><a href="#__codelineno-0-904">904</a></span>
<span class="normal"><a href="#__codelineno-0-905">905</a></span>
<span class="normal"><a href="#__codelineno-0-906">906</a></span>
<span class="normal"><a href="#__codelineno-0-907">907</a></span>
<span class="normal"><a href="#__codelineno-0-908">908</a></span>
<span class="normal"><a href="#__codelineno-0-909">909</a></span>
<span class="normal"><a href="#__codelineno-0-910">910</a></span>
<span class="normal"><a href="#__codelineno-0-911">911</a></span>
<span class="normal"><a href="#__codelineno-0-912">912</a></span>
<span class="normal"><a href="#__codelineno-0-913">913</a></span>
<span class="normal"><a href="#__codelineno-0-914">914</a></span>
<span class="normal"><a href="#__codelineno-0-915">915</a></span>
<span class="normal"><a href="#__codelineno-0-916">916</a></span>
<span class="normal"><a href="#__codelineno-0-917">917</a></span>
<span class="normal"><a href="#__codelineno-0-918">918</a></span>
<span class="normal"><a href="#__codelineno-0-919">919</a></span>
<span class="normal"><a href="#__codelineno-0-920">920</a></span>
<span class="normal"><a href="#__codelineno-0-921">921</a></span>
<span class="normal"><a href="#__codelineno-0-922">922</a></span>
<span class="normal"><a href="#__codelineno-0-923">923</a></span>
<span class="normal"><a href="#__codelineno-0-924">924</a></span>
<span class="normal"><a href="#__codelineno-0-925">925</a></span>
<span class="normal"><a href="#__codelineno-0-926">926</a></span>
<span class="normal"><a href="#__codelineno-0-927">927</a></span>
<span class="normal"><a href="#__codelineno-0-928">928</a></span>
<span class="normal"><a href="#__codelineno-0-929">929</a></span>
<span class="normal"><a href="#__codelineno-0-930">930</a></span>
<span class="normal"><a href="#__codelineno-0-931">931</a></span>
<span class="normal"><a href="#__codelineno-0-932">932</a></span>
<span class="normal"><a href="#__codelineno-0-933">933</a></span>
<span class="normal"><a href="#__codelineno-0-934">934</a></span>
<span class="normal"><a href="#__codelineno-0-935">935</a></span>
<span class="normal"><a href="#__codelineno-0-936">936</a></span>
<span class="normal"><a href="#__codelineno-0-937">937</a></span>
<span class="normal"><a href="#__codelineno-0-938">938</a></span>
<span class="normal"><a href="#__codelineno-0-939">939</a></span>
<span class="normal"><a href="#__codelineno-0-940">940</a></span>
<span class="normal"><a href="#__codelineno-0-941">941</a></span>
<span class="normal"><a href="#__codelineno-0-942">942</a></span>
<span class="normal"><a href="#__codelineno-0-943">943</a></span>
<span class="normal"><a href="#__codelineno-0-944">944</a></span>
<span class="normal"><a href="#__codelineno-0-945">945</a></span>
<span class="normal"><a href="#__codelineno-0-946">946</a></span>
<span class="normal"><a href="#__codelineno-0-947">947</a></span>
<span class="normal"><a href="#__codelineno-0-948">948</a></span>
<span class="normal"><a href="#__codelineno-0-949">949</a></span>
<span class="normal"><a href="#__codelineno-0-950">950</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-899" name="__codelineno-0-899"></a><span class="k">def</span><span class="w"> </span><span class="nf">network_detection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arenas_mask</span><span class="p">:</span> <span class="n">NDArray</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pseudopod_min_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">csc_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">biomask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">backmask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-900" name="__codelineno-0-900"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-901" name="__codelineno-0-901"></a><span class="sd">    Network Detection Function</span>
<a id="__codelineno-0-902" name="__codelineno-0-902"></a>
<a id="__codelineno-0-903" name="__codelineno-0-903"></a><span class="sd">    Perform network detection and pseudopod analysis on an image.</span>
<a id="__codelineno-0-904" name="__codelineno-0-904"></a>
<a id="__codelineno-0-905" name="__codelineno-0-905"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-906" name="__codelineno-0-906"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-907" name="__codelineno-0-907"></a><span class="sd">    arenas_mask : NDArray, optional</span>
<a id="__codelineno-0-908" name="__codelineno-0-908"></a><span class="sd">        The mask indicating the arena regions in the image.</span>
<a id="__codelineno-0-909" name="__codelineno-0-909"></a><span class="sd">    pseudopod_min_size : int, optional</span>
<a id="__codelineno-0-910" name="__codelineno-0-910"></a><span class="sd">        The minimum size for pseudopods to be detected.</span>
<a id="__codelineno-0-911" name="__codelineno-0-911"></a><span class="sd">    csc_dict : dict, optional</span>
<a id="__codelineno-0-912" name="__codelineno-0-912"></a><span class="sd">        A dictionary containing color space conversion parameters. If None,</span>
<a id="__codelineno-0-913" name="__codelineno-0-913"></a><span class="sd">        defaults to {&#39;bgr&#39;: np.array((1, 1, 1), np.int8), &#39;logical&#39;: &#39;None&#39;}</span>
<a id="__codelineno-0-914" name="__codelineno-0-914"></a><span class="sd">    biomask : NDArray, optional</span>
<a id="__codelineno-0-915" name="__codelineno-0-915"></a><span class="sd">        The mask for biological objects in the image.</span>
<a id="__codelineno-0-916" name="__codelineno-0-916"></a><span class="sd">    backmask : NDArray, optional</span>
<a id="__codelineno-0-917" name="__codelineno-0-917"></a><span class="sd">        The background mask.</span>
<a id="__codelineno-0-918" name="__codelineno-0-918"></a>
<a id="__codelineno-0-919" name="__codelineno-0-919"></a><span class="sd">    Notes</span>
<a id="__codelineno-0-920" name="__codelineno-0-920"></a><span class="sd">    -----</span>
<a id="__codelineno-0-921" name="__codelineno-0-921"></a><span class="sd">    This function modifies the object&#39;s state by setting `self.im_combinations`</span>
<a id="__codelineno-0-922" name="__codelineno-0-922"></a><span class="sd">    with the results of network detection and pseudopod analysis.</span>
<a id="__codelineno-0-923" name="__codelineno-0-923"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-924" name="__codelineno-0-924"></a>    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Start automatic detection of network(s) in the last image&quot;</span><span class="p">)</span>
<a id="__codelineno-0-925" name="__codelineno-0-925"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bgr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
<a id="__codelineno-0-926" name="__codelineno-0-926"></a>        <span class="k">if</span> <span class="n">csc_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-927" name="__codelineno-0-927"></a>            <span class="n">csc_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bgr&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">),</span> <span class="s1">&#39;logical&#39;</span><span class="p">:</span> <span class="s1">&#39;None&#39;</span><span class="p">}</span>
<a id="__codelineno-0-928" name="__codelineno-0-928"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_color_spaces</span><span class="p">()</span>
<a id="__codelineno-0-929" name="__codelineno-0-929"></a>        <span class="c1"># csc_dict = translate_dict(csc_dict)</span>
<a id="__codelineno-0-930" name="__codelineno-0-930"></a>        <span class="c1"># self.image = combine_color_spaces(csc_dict, self.all_c_spaces)</span>
<a id="__codelineno-0-931" name="__codelineno-0-931"></a>        <span class="n">first_dict</span><span class="p">,</span> <span class="n">second_dict</span><span class="p">,</span> <span class="n">c_spaces</span> <span class="o">=</span> <span class="n">split_dict</span><span class="p">(</span><span class="n">csc_dict</span><span class="p">)</span>
<a id="__codelineno-0-932" name="__codelineno-0-932"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">first_pc_vector</span> <span class="o">=</span> <span class="n">generate_color_space_combination</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bgr</span><span class="p">,</span> <span class="n">c_spaces</span><span class="p">,</span> <span class="n">first_dict</span><span class="p">,</span> <span class="n">second_dict</span><span class="p">,</span> <span class="n">all_c_spaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">all_c_spaces</span><span class="p">)</span>
<a id="__codelineno-0-933" name="__codelineno-0-933"></a>        <span class="c1"># if first_pc_vector is not None:</span>
<a id="__codelineno-0-934" name="__codelineno-0-934"></a>        <span class="c1">#     csc_dict = {&quot;bgr&quot;: first_pc_vector, &quot;logical&quot;: &#39;None&#39;}</span>
<a id="__codelineno-0-935" name="__codelineno-0-935"></a>    <span class="n">greyscale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span>
<a id="__codelineno-0-936" name="__codelineno-0-936"></a>    <span class="n">NetDet</span> <span class="o">=</span> <span class="n">NetworkDetection</span><span class="p">(</span><span class="n">greyscale</span><span class="p">,</span> <span class="n">possibly_filled_pixels</span><span class="o">=</span><span class="n">arenas_mask</span><span class="p">)</span>
<a id="__codelineno-0-937" name="__codelineno-0-937"></a>    <span class="n">NetDet</span><span class="o">.</span><span class="n">get_best_network_detection_method</span><span class="p">()</span>
<a id="__codelineno-0-938" name="__codelineno-0-938"></a>    <span class="n">lighter_background</span> <span class="o">=</span> <span class="n">NetDet</span><span class="o">.</span><span class="n">greyscale_image</span><span class="p">[</span><span class="n">arenas_mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">NetDet</span><span class="o">.</span><span class="n">greyscale_image</span><span class="p">[</span><span class="n">arenas_mask</span><span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<a id="__codelineno-0-939" name="__codelineno-0-939"></a>    <span class="n">NetDet</span><span class="o">.</span><span class="n">detect_pseudopods</span><span class="p">(</span><span class="n">lighter_background</span><span class="p">,</span> <span class="n">pseudopod_min_size</span><span class="o">=</span><span class="n">pseudopod_min_size</span><span class="p">,</span> <span class="n">only_one_connected_component</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-940" name="__codelineno-0-940"></a>    <span class="n">NetDet</span><span class="o">.</span><span class="n">merge_network_with_pseudopods</span><span class="p">()</span>
<a id="__codelineno-0-941" name="__codelineno-0-941"></a>    <span class="n">cc_efficiency_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">NetDet</span><span class="o">.</span><span class="n">quality_metrics</span><span class="p">)</span>
<a id="__codelineno-0-942" name="__codelineno-0-942"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-943" name="__codelineno-0-943"></a>    <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="n">cc_efficiency_order</span><span class="p">:</span>
<a id="__codelineno-0-944" name="__codelineno-0-944"></a>        <span class="n">res_i</span> <span class="o">=</span> <span class="n">NetDet</span><span class="o">.</span><span class="n">all_results</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span>
<a id="__codelineno-0-945" name="__codelineno-0-945"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
<a id="__codelineno-0-946" name="__codelineno-0-946"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;csc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">csc_dict</span>
<a id="__codelineno-0-947" name="__codelineno-0-947"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;converted_image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bracket_to_uint8_image_contrast</span><span class="p">(</span><span class="n">res_i</span><span class="p">[</span><span class="s1">&#39;filtered&#39;</span><span class="p">])</span>
<a id="__codelineno-0-948" name="__codelineno-0-948"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;binary_image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_i</span><span class="p">[</span><span class="s1">&#39;binary&#39;</span><span class="p">]</span>
<a id="__codelineno-0-949" name="__codelineno-0-949"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;filter_spec&#39;</span><span class="p">]</span><span class="o">=</span> <span class="p">{</span><span class="s1">&#39;filter1_type&#39;</span><span class="p">:</span> <span class="n">res_i</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">],</span> <span class="s1">&#39;filter1_param&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">res_i</span><span class="p">[</span><span class="s1">&#39;sigmas&#39;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">res_i</span><span class="p">[</span><span class="s1">&#39;sigmas&#39;</span><span class="p">])],</span> <span class="s1">&#39;filter2_type&#39;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s1">&#39;filter2_param&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]}</span>
<a id="__codelineno-0-950" name="__codelineno-0-950"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;rolling_window&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">res_i</span><span class="p">[</span><span class="s1">&#39;rolling_window&#39;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cellects.core.one_image_analysis.OneImageAnalysis.projection_to_get_peaks_boundaries" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">projection_to_get_peaks_boundaries</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Projection to get peaks' boundaries.</p>
<p>Calculate the projection of an array along a specified axis and
identify the boundaries of non-zero peaks.</p>
<p>Args:
    axis: int,
        The axis along which to calculate the projection and identify
        peaks' boundaries.</p>
<p>Returns:
    Tuple[NDArray, int]:
        A tuple containing two elements: an array representing the slopes
        of peaks' boundaries and an integer representing the maximum sum
        along the specified axis.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/cellects/core/one_image_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1011">1011</a></span>
<span class="normal"><a href="#__codelineno-0-1012">1012</a></span>
<span class="normal"><a href="#__codelineno-0-1013">1013</a></span>
<span class="normal"><a href="#__codelineno-0-1014">1014</a></span>
<span class="normal"><a href="#__codelineno-0-1015">1015</a></span>
<span class="normal"><a href="#__codelineno-0-1016">1016</a></span>
<span class="normal"><a href="#__codelineno-0-1017">1017</a></span>
<span class="normal"><a href="#__codelineno-0-1018">1018</a></span>
<span class="normal"><a href="#__codelineno-0-1019">1019</a></span>
<span class="normal"><a href="#__codelineno-0-1020">1020</a></span>
<span class="normal"><a href="#__codelineno-0-1021">1021</a></span>
<span class="normal"><a href="#__codelineno-0-1022">1022</a></span>
<span class="normal"><a href="#__codelineno-0-1023">1023</a></span>
<span class="normal"><a href="#__codelineno-0-1024">1024</a></span>
<span class="normal"><a href="#__codelineno-0-1025">1025</a></span>
<span class="normal"><a href="#__codelineno-0-1026">1026</a></span>
<span class="normal"><a href="#__codelineno-0-1027">1027</a></span>
<span class="normal"><a href="#__codelineno-0-1028">1028</a></span>
<span class="normal"><a href="#__codelineno-0-1029">1029</a></span>
<span class="normal"><a href="#__codelineno-0-1030">1030</a></span>
<span class="normal"><a href="#__codelineno-0-1031">1031</a></span>
<span class="normal"><a href="#__codelineno-0-1032">1032</a></span>
<span class="normal"><a href="#__codelineno-0-1033">1033</a></span>
<span class="normal"><a href="#__codelineno-0-1034">1034</a></span>
<span class="normal"><a href="#__codelineno-0-1035">1035</a></span>
<span class="normal"><a href="#__codelineno-0-1036">1036</a></span>
<span class="normal"><a href="#__codelineno-0-1037">1037</a></span>
<span class="normal"><a href="#__codelineno-0-1038">1038</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1011" name="__codelineno-0-1011"></a><span class="k">def</span><span class="w"> </span><span class="nf">projection_to_get_peaks_boundaries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<a id="__codelineno-0-1012" name="__codelineno-0-1012"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1013" name="__codelineno-0-1013"></a>
<a id="__codelineno-0-1014" name="__codelineno-0-1014"></a><span class="sd">    Projection to get peaks&#39; boundaries.</span>
<a id="__codelineno-0-1015" name="__codelineno-0-1015"></a>
<a id="__codelineno-0-1016" name="__codelineno-0-1016"></a><span class="sd">    Calculate the projection of an array along a specified axis and</span>
<a id="__codelineno-0-1017" name="__codelineno-0-1017"></a><span class="sd">    identify the boundaries of non-zero peaks.</span>
<a id="__codelineno-0-1018" name="__codelineno-0-1018"></a>
<a id="__codelineno-0-1019" name="__codelineno-0-1019"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1020" name="__codelineno-0-1020"></a><span class="sd">        axis: int,</span>
<a id="__codelineno-0-1021" name="__codelineno-0-1021"></a><span class="sd">            The axis along which to calculate the projection and identify</span>
<a id="__codelineno-0-1022" name="__codelineno-0-1022"></a><span class="sd">            peaks&#39; boundaries.</span>
<a id="__codelineno-0-1023" name="__codelineno-0-1023"></a>
<a id="__codelineno-0-1024" name="__codelineno-0-1024"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1025" name="__codelineno-0-1025"></a><span class="sd">        Tuple[NDArray, int]:</span>
<a id="__codelineno-0-1026" name="__codelineno-0-1026"></a><span class="sd">            A tuple containing two elements: an array representing the slopes</span>
<a id="__codelineno-0-1027" name="__codelineno-0-1027"></a><span class="sd">            of peaks&#39; boundaries and an integer representing the maximum sum</span>
<a id="__codelineno-0-1028" name="__codelineno-0-1028"></a><span class="sd">            along the specified axis.</span>
<a id="__codelineno-0-1029" name="__codelineno-0-1029"></a>
<a id="__codelineno-0-1030" name="__codelineno-0-1030"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1031" name="__codelineno-0-1031"></a>    <span class="n">sums</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validated_shapes</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
<a id="__codelineno-0-1032" name="__codelineno-0-1032"></a>    <span class="n">slopes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">sums</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1033" name="__codelineno-0-1033"></a>    <span class="n">slopes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">slopes</span><span class="p">))</span>
<a id="__codelineno-0-1034" name="__codelineno-0-1034"></a>    <span class="n">coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">slopes</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-1035" name="__codelineno-0-1035"></a>    <span class="k">for</span> <span class="n">ci</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coord</span><span class="p">)):</span>
<a id="__codelineno-0-1036" name="__codelineno-0-1036"></a>        <span class="k">if</span> <span class="n">ci</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-1037" name="__codelineno-0-1037"></a>            <span class="n">slopes</span><span class="p">[</span><span class="n">coord</span><span class="p">[</span><span class="n">ci</span><span class="p">]]</span> <span class="o">=</span> <span class="o">-</span> <span class="mi">1</span>
<a id="__codelineno-0-1038" name="__codelineno-0-1038"></a>    <span class="k">return</span> <span class="n">slopes</span><span class="p">,</span> <span class="n">sums</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cellects.core.one_image_analysis.OneImageAnalysis.save_combination_features" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_combination_features</span><span class="p">(</span><span class="n">process_i</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Saves the combination features of a given processed image.</p>
<p>Args:
    process_i (object): The processed image object containing various attributes
        such as validated_shapes, image, csc_dict, unaltered_concomp_nb,
        shape_number, total_area, stats, biomask, and backmask.</p>
<div class="highlight"><pre><span></span><code>Attributes:
    processed image object
        validated_shapes (array-like): The validated shapes of the processed image.
        image (array-like): The image data.
        csc_dict (dict): Color space conversion dictionary
</code></pre></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/cellects/core/one_image_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span>
<span class="normal"><a href="#__codelineno-0-599">599</a></span>
<span class="normal"><a href="#__codelineno-0-600">600</a></span>
<span class="normal"><a href="#__codelineno-0-601">601</a></span>
<span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span>
<span class="normal"><a href="#__codelineno-0-607">607</a></span>
<span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span>
<span class="normal"><a href="#__codelineno-0-614">614</a></span>
<span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span>
<span class="normal"><a href="#__codelineno-0-617">617</a></span>
<span class="normal"><a href="#__codelineno-0-618">618</a></span>
<span class="normal"><a href="#__codelineno-0-619">619</a></span>
<span class="normal"><a href="#__codelineno-0-620">620</a></span>
<span class="normal"><a href="#__codelineno-0-621">621</a></span>
<span class="normal"><a href="#__codelineno-0-622">622</a></span>
<span class="normal"><a href="#__codelineno-0-623">623</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-590" name="__codelineno-0-590"></a><span class="k">def</span><span class="w"> </span><span class="nf">save_combination_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process_i</span><span class="p">:</span> <span class="nb">object</span><span class="p">):</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a><span class="sd">    Saves the combination features of a given processed image.</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a><span class="sd">        process_i (object): The processed image object containing various attributes</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a><span class="sd">            such as validated_shapes, image, csc_dict, unaltered_concomp_nb,</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a><span class="sd">            shape_number, total_area, stats, biomask, and backmask.</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a><span class="sd">        Attributes:</span>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a><span class="sd">            processed image object</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a><span class="sd">                validated_shapes (array-like): The validated shapes of the processed image.</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a><span class="sd">                image (array-like): The image data.</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a><span class="sd">                csc_dict (dict): Color space conversion dictionary</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a>    <span class="k">if</span> <span class="n">process_i</span><span class="o">.</span><span class="n">validated_shapes</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saved_images_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process_i</span><span class="o">.</span><span class="n">validated_shapes</span><span class="p">)</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">converted_images_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">process_i</span><span class="o">.</span><span class="n">image</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saved_color_space_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process_i</span><span class="o">.</span><span class="n">csc_dict</span><span class="p">)</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">process_i</span><span class="o">.</span><span class="n">csc_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">process_i</span><span class="o">.</span><span class="n">unaltered_concomp_nb</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># unaltered_cc_nb</span>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">process_i</span><span class="o">.</span><span class="n">shape_number</span>  <span class="c1"># cc_nb</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">process_i</span><span class="o">.</span><span class="n">total_area</span>  <span class="c1"># area</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">process_i</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">2</span><span class="p">])</span>  <span class="c1"># width_std</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">process_i</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">3</span><span class="p">])</span>  <span class="c1"># height_std</span>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">process_i</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">4</span><span class="p">])</span>  <span class="c1"># area_std</span>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a>        <span class="k">if</span> <span class="n">process_i</span><span class="o">.</span><span class="n">biomask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a>                <span class="n">process_i</span><span class="o">.</span><span class="n">validated_shapes</span><span class="p">[</span><span class="n">process_i</span><span class="o">.</span><span class="n">biomask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">process_i</span><span class="o">.</span><span class="n">biomask</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a>        <span class="k">if</span> <span class="n">process_i</span><span class="o">.</span><span class="n">backmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combination_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a>                <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">process_i</span><span class="o">.</span><span class="n">validated_shapes</span><span class="p">)[</span><span class="n">process_i</span><span class="o">.</span><span class="n">backmask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">process_i</span><span class="o">.</span><span class="n">backmask</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saved_csc_nb</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cellects.core.one_image_analysis.OneImageAnalysis.segmentation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">segmentation</span><span class="p">(</span><span class="n">logical</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">color_number</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">biomask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">backmask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bio_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bio_label2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rolling_window_segmentation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lighter_background</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allowed_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_spec</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Implement segmentation on the image using various methods and parameters.</p>
<p>Args:
    logical (str): Logical operation to perform between two binary images.
                   Options are 'Or', 'And', 'Xor'. Default is 'None'.
    color_number (int): Number of colors to use in segmentation. Must be greater than 2
                        for kmeans clustering. Default is 2.
    biomask (NDArray[np.uint8]): Binary mask for biological areas. Default is None.
    backmask (NDArray[np.uint8]): Binary mask for background areas. Default is None.
    bio_label (Any): Label for biological features. Default is None.
    bio_label2 (Any): Secondary label for biological features. Default is None.
    rolling_window_segmentation (dict): Whether to perform grid segmentation. Default is None.
    lighter_background (bool): Indicates if the background is lighter than objects.
                               Default is None.
    allowed_window (Tuple): Mask to apply during segmentation. Default is None.
    filter_spec (dict): Dictionary of filters to apply on the image before segmentation.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/cellects/core/one_image_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="k">def</span><span class="w"> </span><span class="nf">segmentation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">color_number</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">biomask</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>                 <span class="n">backmask</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bio_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bio_label2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>                 <span class="n">rolling_window_segmentation</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lighter_background</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allowed_window</span><span class="p">:</span> <span class="n">Tuple</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>                 <span class="n">filter_spec</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><span class="sd">    Implement segmentation on the image using various methods and parameters.</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="sd">        logical (str): Logical operation to perform between two binary images.</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="sd">                       Options are &#39;Or&#39;, &#39;And&#39;, &#39;Xor&#39;. Default is &#39;None&#39;.</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a><span class="sd">        color_number (int): Number of colors to use in segmentation. Must be greater than 2</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="sd">                            for kmeans clustering. Default is 2.</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="sd">        biomask (NDArray[np.uint8]): Binary mask for biological areas. Default is None.</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a><span class="sd">        backmask (NDArray[np.uint8]): Binary mask for background areas. Default is None.</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a><span class="sd">        bio_label (Any): Label for biological features. Default is None.</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="sd">        bio_label2 (Any): Secondary label for biological features. Default is None.</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a><span class="sd">        rolling_window_segmentation (dict): Whether to perform grid segmentation. Default is None.</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a><span class="sd">        lighter_background (bool): Indicates if the background is lighter than objects.</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="sd">                                   Default is None.</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="sd">        allowed_window (Tuple): Mask to apply during segmentation. Default is None.</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><span class="sd">        filter_spec (dict): Dictionary of filters to apply on the image before segmentation.</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>    <span class="c1"># 1. Check valid pixels for segmentation (e.g. when there is a drift correction)</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>    <span class="k">if</span> <span class="n">allowed_window</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>        <span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>        <span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">=</span> <span class="n">allowed_window</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>    <span class="n">greyscale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">[</span><span class="n">min_y</span><span class="p">:</span><span class="n">max_y</span><span class="p">,</span> <span class="n">min_x</span><span class="p">:</span><span class="n">max_x</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>    <span class="c1"># 2. Apply filter on the greyscale images</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>    <span class="k">if</span> <span class="n">filter_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">filter_spec</span><span class="p">[</span><span class="s2">&quot;filter1_type&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>        <span class="n">greyscale</span> <span class="o">=</span> <span class="n">apply_filter</span><span class="p">(</span><span class="n">greyscale</span><span class="p">,</span> <span class="n">filter_spec</span><span class="p">[</span><span class="s2">&quot;filter1_type&quot;</span><span class="p">],</span> <span class="n">filter_spec</span><span class="p">[</span><span class="s2">&quot;filter1_param&quot;</span><span class="p">])</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>    <span class="n">greyscale2</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>    <span class="k">if</span> <span class="n">logical</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>        <span class="n">greyscale2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image2</span><span class="p">[</span><span class="n">min_y</span><span class="p">:</span><span class="n">max_y</span><span class="p">,</span> <span class="n">min_x</span><span class="p">:</span><span class="n">max_x</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>        <span class="k">if</span> <span class="n">filter_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">filter_spec</span><span class="p">[</span><span class="s2">&quot;filter2_type&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>            <span class="n">greyscale2</span> <span class="o">=</span> <span class="n">apply_filter</span><span class="p">(</span><span class="n">greyscale2</span><span class="p">,</span> <span class="n">filter_spec</span><span class="p">[</span><span class="s2">&quot;filter2_type&quot;</span><span class="p">],</span> <span class="n">filter_spec</span><span class="p">[</span><span class="s2">&quot;filter2_param&quot;</span><span class="p">])</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>    <span class="c1"># 3. Do one of the three segmentation algorithms: kmeans, otsu, windowed</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>    <span class="k">if</span> <span class="n">color_number</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>        <span class="n">binary_image</span><span class="p">,</span> <span class="n">binary_image2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bio_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bio_label2</span>  <span class="o">=</span> <span class="n">kmeans</span><span class="p">(</span><span class="n">greyscale</span><span class="p">,</span> <span class="n">greyscale2</span><span class="p">,</span> <span class="n">color_number</span><span class="p">,</span> <span class="n">biomask</span><span class="p">,</span> <span class="n">backmask</span><span class="p">,</span> <span class="n">logical</span><span class="p">,</span> <span class="n">bio_label</span><span class="p">,</span> <span class="n">bio_label2</span><span class="p">)</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>    <span class="k">elif</span> <span class="n">rolling_window_segmentation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rolling_window_segmentation</span><span class="p">[</span><span class="s1">&#39;do&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>        <span class="n">binary_image</span> <span class="o">=</span> <span class="n">windowed_thresholding</span><span class="p">(</span><span class="n">greyscale</span><span class="p">,</span> <span class="n">lighter_background</span><span class="p">,</span> <span class="n">rolling_window_segmentation</span><span class="p">[</span><span class="s1">&#39;side_len&#39;</span><span class="p">],</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>        <span class="n">rolling_window_segmentation</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">],</span> <span class="n">rolling_window_segmentation</span><span class="p">[</span><span class="s1">&#39;min_int_var&#39;</span><span class="p">])</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="n">binary_image</span> <span class="o">=</span> <span class="n">otsu_thresholding</span><span class="p">(</span><span class="n">greyscale</span><span class="p">)</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>    <span class="k">if</span> <span class="n">logical</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span> <span class="ow">and</span> <span class="n">color_number</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>        <span class="k">if</span> <span class="n">rolling_window_segmentation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rolling_window_segmentation</span><span class="p">[</span><span class="s1">&#39;do&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>            <span class="n">binary_image2</span> <span class="o">=</span> <span class="n">windowed_thresholding</span><span class="p">(</span><span class="n">greyscale2</span><span class="p">,</span> <span class="n">lighter_background</span><span class="p">,</span> <span class="n">rolling_window_segmentation</span><span class="p">[</span><span class="s1">&#39;side_len&#39;</span><span class="p">],</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>            <span class="n">rolling_window_segmentation</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">],</span> <span class="n">rolling_window_segmentation</span><span class="p">[</span><span class="s1">&#39;min_int_var&#39;</span><span class="p">])</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>            <span class="n">binary_image2</span> <span class="o">=</span> <span class="n">otsu_thresholding</span><span class="p">(</span><span class="n">greyscale2</span><span class="p">)</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>    <span class="c1"># 4. Use previous_binary_image to make sure that the specimens are labelled with ones and the background zeros</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous_binary_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>        <span class="n">previous_binary_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous_binary_image</span><span class="p">[</span><span class="n">min_y</span><span class="p">:</span><span class="n">max_y</span><span class="p">,</span> <span class="n">min_x</span><span class="p">:</span><span class="n">max_x</span><span class="p">]</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">binary_image</span> <span class="o">*</span> <span class="n">previous_binary_image</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="p">(</span><span class="n">binary_image</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="n">binary_image</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="n">binary_image</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="n">binary_image</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">all</span><span class="p">()):</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>            <span class="c1"># if (binary_image * (1 - previous_binary_image)).sum() &gt; (binary_image * previous_binary_image).sum() + perimeter(binary_image):</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>            <span class="c1"># Ones of the binary image have more in common with the background than with the specimen</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>            <span class="n">binary_image</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">binary_image</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>        <span class="k">if</span> <span class="n">logical</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">binary_image2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">previous_binary_image</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">binary_image2</span> <span class="o">*</span> <span class="n">previous_binary_image</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">():</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>                <span class="n">binary_image2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">binary_image2</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>    <span class="c1"># 5. Give back the image their original size and combine binary images (optional)</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">[</span><span class="n">min_y</span><span class="p">:</span><span class="n">max_y</span><span class="p">,</span> <span class="n">min_x</span><span class="p">:</span><span class="n">max_x</span><span class="p">]</span> <span class="o">=</span> <span class="n">binary_image</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">greyscale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">greyscale</span><span class="p">[</span><span class="n">min_y</span><span class="p">:</span><span class="n">max_y</span><span class="p">,</span> <span class="n">min_x</span><span class="p">:</span><span class="n">max_x</span><span class="p">]</span> <span class="o">=</span> <span class="n">greyscale</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>    <span class="k">if</span> <span class="n">logical</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span><span class="p">[</span><span class="n">min_y</span><span class="p">:</span><span class="n">max_y</span><span class="p">,</span> <span class="n">min_x</span><span class="p">:</span><span class="n">max_x</span><span class="p">]</span> <span class="o">=</span> <span class="n">binary_image2</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">greyscale2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">greyscale2</span><span class="p">[</span><span class="n">min_y</span><span class="p">:</span><span class="n">max_y</span><span class="p">,</span> <span class="n">min_x</span><span class="p">:</span><span class="n">max_x</span><span class="p">]</span> <span class="o">=</span> <span class="n">greyscale2</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>    <span class="k">if</span> <span class="n">logical</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>        <span class="k">if</span> <span class="n">logical</span> <span class="o">==</span> <span class="s1">&#39;Or&#39;</span><span class="p">:</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span><span class="p">)</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>        <span class="k">elif</span> <span class="n">logical</span> <span class="o">==</span> <span class="s1">&#39;And&#39;</span><span class="p">:</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span><span class="p">)</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>        <span class="k">elif</span> <span class="n">logical</span> <span class="o">==</span> <span class="s1">&#39;Xor&#39;</span><span class="p">:</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_xor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image2</span><span class="p">)</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cellects.core.one_image_analysis.OneImageAnalysis.update_current_images" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_current_images</span><span class="p">(</span><span class="n">current_combination_id</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Update the current images based on a given combination ID.</p>
<p>This method updates two attributes of the instance: <code>image</code> and
<code>validated_shapes</code>. The <code>image</code> attribute is set to the value of the key
"converted_image" from a dictionary in <code>im_combinations</code> which is
indexed by the provided <code>current_combination_id</code>. Similarly, the
<code>validated_shapes</code> attribute is set to the value of the key "binary_image"
from the same dictionary.</p>
<p>Args:
    current_combination_id (int): The ID of the combination whose
        images should be set as the current ones.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/cellects/core/one_image_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-625">625</a></span>
<span class="normal"><a href="#__codelineno-0-626">626</a></span>
<span class="normal"><a href="#__codelineno-0-627">627</a></span>
<span class="normal"><a href="#__codelineno-0-628">628</a></span>
<span class="normal"><a href="#__codelineno-0-629">629</a></span>
<span class="normal"><a href="#__codelineno-0-630">630</a></span>
<span class="normal"><a href="#__codelineno-0-631">631</a></span>
<span class="normal"><a href="#__codelineno-0-632">632</a></span>
<span class="normal"><a href="#__codelineno-0-633">633</a></span>
<span class="normal"><a href="#__codelineno-0-634">634</a></span>
<span class="normal"><a href="#__codelineno-0-635">635</a></span>
<span class="normal"><a href="#__codelineno-0-636">636</a></span>
<span class="normal"><a href="#__codelineno-0-637">637</a></span>
<span class="normal"><a href="#__codelineno-0-638">638</a></span>
<span class="normal"><a href="#__codelineno-0-639">639</a></span>
<span class="normal"><a href="#__codelineno-0-640">640</a></span>
<span class="normal"><a href="#__codelineno-0-641">641</a></span>
<span class="normal"><a href="#__codelineno-0-642">642</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-625" name="__codelineno-0-625"></a><span class="k">def</span><span class="w"> </span><span class="nf">update_current_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_combination_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a><span class="sd">    Update the current images based on a given combination ID.</span>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a><span class="sd">    This method updates two attributes of the instance: `image` and</span>
<a id="__codelineno-0-630" name="__codelineno-0-630"></a><span class="sd">    `validated_shapes`. The `image` attribute is set to the value of the key</span>
<a id="__codelineno-0-631" name="__codelineno-0-631"></a><span class="sd">    &quot;converted_image&quot; from a dictionary in `im_combinations` which is</span>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a><span class="sd">    indexed by the provided `current_combination_id`. Similarly, the</span>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a><span class="sd">    `validated_shapes` attribute is set to the value of the key &quot;binary_image&quot;</span>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a><span class="sd">    from the same dictionary.</span>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a><span class="sd">        current_combination_id (int): The ID of the combination whose</span>
<a id="__codelineno-0-638" name="__codelineno-0-638"></a><span class="sd">            images should be set as the current ones.</span>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="n">current_combination_id</span><span class="p">][</span><span class="s2">&quot;converted_image&quot;</span><span class="p">]</span>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">validated_shapes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_combinations</span><span class="p">[</span><span class="n">current_combination_id</span><span class="p">][</span><span class="s2">&quot;binary_image&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../../..", "features": ["navigation.instant", "navigation.tabs", "navigation.sections", "navigation.top", "toc.integrate", "search.suggest", "search.highlight", "content.tabs.link", "content.code.copy"], "search": "../../../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>