name: release

on:
  push:
    tags: ["*"]
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to release (tag, branch or commit SHA)"
        required: true
        default: "main"
      pypi:
        description: "Publish the package to PyPI"
        type: boolean
        required: true
        default: false
      docs:
        description: "Build and publish documentation"
        type: boolean
        required: true
        default: true

concurrency:
  group: ${{ github.repository }}-pipeline
  cancel-in-progress: false

jobs:
  resolve:
    runs-on: ubuntu-latest
    outputs:
      ref: ${{ steps.o.outputs.ref }}
      is_tag: ${{ steps.o.outputs.is_tag }}
      pypi: ${{ steps.o.outputs.pypi }}
      docs: ${{ steps.o.outputs.docs }}
    steps:
      - id: o
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "ref=${GITHUB_REF}" >> $GITHUB_OUTPUT
            echo "is_tag=true" >> $GITHUB_OUTPUT
            echo "pypi=true" >> $GITHUB_OUTPUT
            echo "docs=true" >> $GITHUB_OUTPUT
          else
            echo "ref=${{ inputs.ref }}" >> $GITHUB_OUTPUT
            echo "is_tag=false" >> $GITHUB_OUTPUT
            echo "pypi=${{ inputs.pypi }}" >> $GITHUB_OUTPUT
            echo "docs=${{ inputs.docs }}" >> $GITHUB_OUTPUT
          fi

  gate:
    runs-on: ubuntu-latest
    needs: resolve
    if: ${{ needs.resolve.outputs.is_tag == 'true' || needs.resolve.outputs.pypi == 'true' || needs.resolve.outputs.docs == 'true' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.resolve.outputs.ref }}
          lfs: true
      - run: |
          git fetch origin main --depth=1
          REF_SHA="$(git rev-parse HEAD)"
          MAIN_SHA="$(git rev-parse origin/main)"
          git merge-base --is-ancestor "$REF_SHA" "$MAIN_SHA"

  build-test:
    needs: [resolve, gate]
    uses: ./.github/workflows/_build_and_test.yml
    with:
      ref: ${{ needs.resolve.outputs.ref }}
      py_build: "3.12"
      py_test: '["3.12","3.13"]'
      coverage: true

  coverage-badge:
    runs-on: ubuntu-latest
    needs: [ resolve, build-test ]
    if: ${{ needs.resolve.outputs.docs == 'true' || needs.resolve.outputs.pypi == 'true' }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true
      - uses: actions/download-artifact@v4
        with:
          name: coverage
          path: coverage
      - run: |
          python -m pip install -U pip
          pip install genbadge[coverage]
          mkdir -p badges
          genbadge coverage -i coverage/coverage.xml -o badges/coverage.svg
      - uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: badges
          destination_dir: badges
          keep_files: true

  pypi:
    runs-on: ubuntu-latest
    needs: [resolve, build-test]
    if: ${{ needs.resolve.outputs.pypi == 'true' }}
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist
      - uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist
          verify-metadata: false

  docs:
    runs-on: ubuntu-latest
    needs: [resolve, build-test, coverage-badge, pypi]
    if: ${{ needs.resolve.outputs.docs == 'true' }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.resolve.outputs.ref }}
          lfs: true
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
      - run: |
          python -m pip install -U pip
          pip install -e .
          pip install mkdocs mkdocs-material \
            "mkdocstrings[python]" mkdocs-gen-files mkdocs-autorefs \
            pymdown-extensions mkdocs-literate-nav mkdocs-section-index \
            mkdocs-jupyter
      - run: mkdocs build --strict
      - uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          publish_branch: gh-pages
          keep_files: true

  windows-installer:
    runs-on: windows-latest
    needs: [resolve, build-test]
    if: ${{ needs.resolve.outputs.is_tag == 'true' }}
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.resolve.outputs.ref }}
          lfs: true
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pyinstaller
      
      - name: Build with PyInstaller
        run: |
          pyinstaller __main__.spec
      
      - name: Get version from tag
        id: get_version
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"
      
      - name: Create ZIP archive
        shell: bash
        run: |
          cd dist
          7z a -tzip ../Cellects-${{ steps.get_version.outputs.version }}-windows.zip Cellects/
      
      - name: Install NSIS
        run: |
          choco install nsis -y

      - name: Add NSIS to PATH
        shell: powershell
        run: |
          echo "C:\Program Files (x86)\NSIS" >> $env:GITHUB_PATH
      
      - name: Build NSIS installer
        shell: bash
        run: |
          export INSTALLER_VERSION="${{ steps.get_version.outputs.version }}"
          export INSTALLER_NAME="Cellects-${{ steps.get_version.outputs.version }}-setup.exe"
          makensis installer.nsi
      
      - name: Upload ZIP to Release
        uses: softprops/action-gh-release@v2
        with:
          files: Cellects-${{ steps.get_version.outputs.version }}-windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload installer to Release
        uses: softprops/action-gh-release@v2
        with:
          files: Cellects-${{ steps.get_version.outputs.version }}-setup.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  mac-installer:
    runs-on: macos-latest
    needs: [ resolve, build-test ]
    if: ${{ needs.resolve.outputs.is_tag == 'true' && needs.resolve.outputs.mac == 'true' }}
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.resolve.outputs.ref }}
          lfs: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pyinstaller

      - name: Get version from tag
        id: get_version
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Build with PyInstaller
        env:
          APP_VERSION: ${{ steps.get_version.outputs.version }}
        run: |
          pyinstaller __main__.spec

      - name: Verify app bundle
        run: |
          if [ ! -d "dist/Cellects.app" ]; then
            echo "App bundle not found!"
            exit 1
          fi
          echo "App bundle created successfully"
          ls -lh dist/Cellects.app/Contents/MacOS/Cellects

      - name: Install create-dmg
        run: |
          npm install -g create-dmg

      - name: Create DMG
        run: |
          chmod +x create_dmg.sh
          ./create_dmg.sh

      - name: Rename DMG with version
        run: |
          mv dist/Cellects.dmg Cellects-${{ steps.get_version.outputs.version }}.dmg
          echo "DMG created: Cellects-${{ steps.get_version.outputs.version }}.dmg"
          ls -lh Cellects-${{ steps.get_version.outputs.version }}.dmg

      - name: Upload DMG to Release
        uses: softprops/action-gh-release@v2
        with:
          files: Cellects-${{ steps.get_version.outputs.version }}.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-summary:
    runs-on: ubuntu-latest
    needs: [ resolve, windows-installer, mac-installer ]
    if: always() && needs.resolve.outputs.is_tag == 'true'
    steps:
      - name: Create release summary
        shell: bash
        run: |
          echo "### Release Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Ref:** \`${{ needs.resolve.outputs.ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Build Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.windows-installer.result }}" = "success" ]; then
            echo "- **Windows**: ZIP + Installer uploaded" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.windows-installer.result }}" = "skipped" ]; then
            echo "- **Windows**: Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Windows**: Build failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.mac-installer.result }}" = "success" ]; then
            echo "- **Mac**: DMG uploaded" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.mac-installer.result }}" = "skipped" ]; then
            echo "- **Mac**: Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Mac**: Build failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Release Assets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the [Releases page](https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}) for:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Windows:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`Cellects-X.X.X-windows.zip\` - Portable version" >> $GITHUB_STEP_SUMMARY
          echo "- \`Cellects-X.X.X-setup.exe\` - Windows installer" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**macOS:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`Cellects-X.X.X.dmg\` - Mac installer" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Other:**" >> $GITHUB_STEP_SUMMARY
          echo "- Source code (auto-generated)" >> $GITHUB_STEP_SUMMARY
